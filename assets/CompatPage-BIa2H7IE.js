import{r as i,j as a,I as Be,R as $e}from"./index-Ca4uGMNd.js";import{a as Ae,D as oe,k as U,M as ie,i as Oe,j as He,S as ce,d as M,B as ue,m as Ye}from"./index-CPuyTuj8.js";import{s as Ge,P as de,l as ze,c as Je,a as me}from"./seo-DVborI1b.js";import{F as Ke,A as Ue,c as qe}from"./openaiService-C1aXJaew.js";import{S as We}from"./ShareModal-DORy5Qno.js";const C="compat_locked",k="compat_partner",J="compat_skip_scroll_on_return";function ve(t){try{return localStorage.getItem(t)}catch{return null}}function N(t,l){try{localStorage.setItem(t,l)}catch{}}function he(t){try{localStorage.removeItem(t)}catch{}}function Ve(t){try{return sessionStorage.getItem(t)}catch{return null}}function pe(t,l){try{sessionStorage.setItem(t,l)}catch{}}function Qe(t){return t=Number(t),!Number.isFinite(t)||t<=0?!1:t%400===0||t%4===0&&t%100!==0}function fe(t,l){const h=Number(t),m=Number(l);return!Number.isFinite(m)||m<1||m>12?31:m===2?Qe(h)?29:28:[4,6,9,11].includes(m)?30:31}function ge(t){if(t===""||t===null||t===void 0)return null;const l=Number(t);return Number.isFinite(l)&&l>=0&&l<=23?l:null}function q(t){return t==null?"":String(t).trim().toUpperCase()}function ye(t){const l=t?.calendar||"solar",h=t?.year??"",m=t?.month??"",A=t?.day??"",v=t?.hour??"",D=t?.minute??"0",O=t?.gender||"",o=t?.leapMonth||(t?.isLeap?"leap":"common"),g=q(t?.mbti);return[l,`${h}-${m}-${A}`,`${v}:${D}`,O,o,g].join("|")}function Se(t,l){return`ME:${ye(t)}||PARTNER:${ye(l)}`}function Xe(t){return t?t.signature?t.signature:t.me&&t.partner?Se(t.me,t.partner):null:null}function xe(){const t=ve(C);if(t==="1")return!0;if(t==="0")return!1;try{const l=U();if(l&&(l.text||l.myPillars||l.partnerPillars))return!0}catch{}return!1}function K(t){const l=t||{};return{calendar:l.calendar||"solar",leapMonth:l.leapMonth||"common",gender:l.gender||"female",mbti:l.mbti||"",year:l.year?String(l.year):"",month:l.month?String(l.month):"",day:l.day?String(l.day):"",hour:l.hour!=null?String(l.hour):"",minute:l.minute!=null?String(l.minute):""}}function lt(){i.useEffect(()=>{Ge({title:"궁합",description:"상생·상극 밸런스와 소통 팁을 사주 기둥 기반으로 확인하세요.",path:"/#/compat",image:"/og-image.png"})},[]);const t=Ae(),l=!!t,[h,m]=i.useState(xe),[A,v]=i.useState(()=>xe()?"saved":""),D=i.useMemo(()=>t?.gender==="male"?"female":t?.gender==="female"?"male":"female",[t]),O=i.useMemo(()=>{if(!t)return[];const e=t.calendar==="lunar",n=e?"음력":"양력",s=e&&(t.leapMonth==="leap"||t.isLeap)?" (윤달)":"",r=[t.year,t.month,t.day].filter(Boolean).join("."),u=(t?.hour??"")!==""?`${t.hour}시`:"—",c=t.gender==="male"?"남성":t.gender==="female"?"여성":"—",d=t.mbti?String(t.mbti).toUpperCase():"—";return[{label:"달력",value:`${n}${s}`.trim()},{label:"생년월일",value:r||"—"},{label:"시간",value:u},{label:"성별",value:c},{label:"MBTI",value:d}]},[t]),[o,g]=i.useState(()=>({...oe,calendar:"solar",gender:D,mbti:""})),[F,E]=i.useState(null),[_,T]=i.useState(null),[Ze,H]=i.useState(null),[et,Y]=i.useState(null),[G,j]=i.useState(""),[f,W]=i.useState(!1),[be,B]=i.useState(""),[we,V]=i.useState(!1),Q=i.useRef(!1),R=i.useRef(!1),X=i.useRef(null),L=i.useRef(!1),$=i.useRef(!1);i.useEffect(()=>(Ve(J),pe(J,"0"),()=>{pe(J,"1")}),[]),i.useEffect(()=>{const e=U();e&&(e.myPillars&&E(e.myPillars),e.partnerPillars&&T(e.partnerPillars),e.text&&j(e.text),e.myMeta&&H(e.myMeta),e.partnerMeta&&Y(e.partnerMeta));let n=null;const s=ve(k);if(s)try{n=JSON.parse(s)}catch{}!n&&e&&e.partner&&(n=e.partner),n&&g(r=>({...r,...K(n)}))},[]);const Me=i.useMemo(()=>ie.map(e=>({value:e.value,label:e.label})),[]),Ne=i.useMemo(()=>{const e=[];for(let n=1900;n<=2029;n++)e.push({value:String(n),label:`${n}년`});return e},[]),je=i.useMemo(()=>{const e=[];for(let n=1;n<=12;n++)e.push({value:String(n),label:`${n}월`});return e},[]),Ce=i.useMemo(()=>{const n=o.calendar==="lunar"?30:fe(o.year,o.month),s=[];for(let r=1;r<=n;r++)s.push({value:String(r),label:`${r}일`});return s},[o.calendar,o.year,o.month]),Ee=i.useMemo(()=>{const e=[{value:"",label:"모름"}];for(let n=0;n<24;n++)e.push({value:String(n),label:`${String(n).padStart(2,"0")}시`});return e},[]),Z=e=>{const n={...e},r=n.calendar==="lunar"?30:fe(n.year,n.month),u=Number(n.day);return(!u||u>r)&&(n.day=String(Math.min(u||1,r))),n},Te=e=>g(n=>Z({...n,calendar:e})),Re=e=>g(n=>({...n,gender:e})),S=(e,n)=>{g(e==="year"||e==="month"||e==="leapMonth"?s=>Z({...s,[e]:n}):s=>({...s,[e]:n}))},z=i.useMemo(()=>{const e=o.year&&o.month&&o.day,n=o.calendar==="solar"||!!o.leapMonth;return!!(e&&n&&o.gender)},[o]);function ee(e){const n=e.calendar||"solar",s=Number(e.year),r=Number(e.month),u=Number(e.day),d=ge(e.hour)??12,y=e.minute!=null?Number(e.minute):0,I=e.leapMonth==="leap"||e.isLeap;let b=s,p=r,x=u;if(n==="lunar"){const w=ze(s,r,u,I),P=w instanceof Date?w:new Date(w);b=P.getFullYear(),p=P.getMonth()+1,x=P.getDate()}return Je(b,p,x,d,y)}const te=i.useCallback(()=>{try{const e=document.querySelector("header, .header, [role='banner']");if(!e)return 0;const n=getComputedStyle(e).position||"";return/fixed|sticky/i.test(n)?Math.ceil(e.getBoundingClientRect().height||0):0}catch{return 0}},[]),ne=i.useCallback(e=>{if(!e||typeof window>"u")return null;let n=e.parentElement;for(;n;){const s=window.getComputedStyle(n),r=s.overflowY||s.overflow;if(/(auto|scroll|overlay)/i.test(r))return n;n=n.parentElement}return null},[]),ae=i.useCallback(e=>{if(!e)return!1;const n=14,s=te(),r=ne(e)||window;let u;if(r===window){const x=e.getBoundingClientRect();u=(window.scrollY||window.pageYOffset)+x.top}else{const x=e.getBoundingClientRect(),w=r.getBoundingClientRect();u=r.scrollTop+(x.top-w.top)}const c=Math.max(0,u-s-n),d=document.scrollingElement||document.documentElement,y=r===window?window.innerHeight||d.clientHeight:r.clientHeight,I=r===window?d.scrollHeight:r.scrollHeight,b=Math.max(0,I-y),p=Math.min(c,b);try{r===window?window.scrollTo({top:p,behavior:"smooth"}):r.scrollTo({top:p,behavior:"smooth"})}catch{r===window?window.scrollTo(0,p):r.scrollTop=p}return!0},[te,ne]);i.useEffect(()=>{if(!$.current&&!f&&G&&L.current){const e=document.getElementById("compat-my-header")||document.querySelector("h3.h4, h3");e&&requestAnimationFrame(()=>setTimeout(()=>{ae(e)&&($.current=!0,L.current=!1)},80))}},[f,G,ae]);function re(e,n){const s=Number(e?.year),r=Number(e?.month),u=Number(e?.day),c=ge(e?.hour)??12,d=e?.minute!=null?Number(e.minute):0;return{y:s,m:r,d:u,hh:c,mm:d,gender:e?.gender||"unknown",yearStem:n?.year?.stem}}async function Le(e,n,s,r,u){W(!0),B(""),j("");try{const c={calendar:e?.calendar,year:e?.year,month:e?.month,day:e?.day,hour:e?.hour??"",minute:e?.minute??"0",gender:e?.gender,leapMonth:e?.leapMonth,mbti:q(e?.mbti)},d={calendar:n?.calendar,year:n?.year,month:n?.month,day:n?.day,hour:n?.hour??"",minute:n?.minute??"0",gender:n?.gender,leapMonth:n?.leapMonth,mbti:q(n?.mbti)},y=re(e,s),I=re(n,r),b=me(s,{birth:y,mode:"compat"}),p=me(r,{birth:I,mode:"compat"}),x={me:{input:c,pillars:s,meta:b},partner:{input:d,pillars:r,meta:p},guidance:{must_use:["오행 분포/균형","용신·기신","십성(육친)","신살","합·충·형·해·파·원진","격국(요지)","대운·세운 톤(과도한 단정 금지)"],avoid:["JSON 외 임의 간지/점수 생성","과장/공포 유발 표현","개인정보/생년월일 재기술"]}},w=["당신은 명리·사주 풀이 무당입니다. 궁합을 풀이하고 다음 규칙을 반드시 지킵니다.","모르거나 부정확한 풀이는 허위로 작성하지 말고 완전히 작성하지 마세요","소제목은 h3(###) 형식으로 작성하고, 추가 소제목/서론/결론/요약 금지","오직 제공된 JSON(양측의 4주와 meta: 용신·기신·십성·신살·오행분포·합충형해파·격국 등)만을 근거로 서술하세요.","새 간지/점수/절기 생성 금지, 외부 추정 금지, 단정/공포 금지.","궁합 총평, 성격풀이, 겉궁합 풀이, 속궁합 풀이, 섹스풀이로 소제목을 작성해줘.","각 항목 500자 이상 작성하고, 반복/상투어 금지, 구체 사례/상호작용 중심.","조언, 해결책제시는 금지. 오로지 사주풀이만 작성해주세요","생년월일/시각은 본문에 재기술하지 마세요(이미 별도로 제공됨)."].join(" "),P=["분석 JSON:","```json",JSON.stringify(x,null,2),"```","","지침:","- 용신과 기신의 상호작용(상생/상극)으로 관계의 균형·보완 포인트를 설명하세요.","- 양측 십성(육친)과 신살을 비교하여 소통/신뢰/갈등 포인트를 구체화하세요.","- 합·충·형·해·파·원진이 성립하면 해당 영역에 미칠 가능성을 사례로 연결하세요.","- 과한 점괘식 표현/점수화/별점/색상 표기는 금지합니다."].join(`
`),_e=await qe({messages:[{role:"system",content:w},{role:"user",content:P}]}),le=String(_e||"").trim();j(le),Ye({me:c,partner:d,myPillars:s,partnerPillars:r,myMeta:b,partnerMeta:p,text:le,signature:u,ts:Date.now()}),m(!0),v("saved"),N(C,"1"),N(k,JSON.stringify(K(d)))}catch(c){B(c?.message||String(c))}finally{W(!1)}}const Ie=async e=>{e.preventDefault(),L.current=!0,$.current=!1,m(!0),v("");const n=K(o);N(C,"1"),N(k,JSON.stringify(n));let s=null;t?.year&&t?.month&&t?.day?(s=ee(t),E(s)):E(null);let r=null;if(o?.year&&o?.month&&o?.day?(r=ee(o),T(r)):T(null),!(s&&r)){j(""),B("내 정보와 상대방 정보를 모두 입력해야 궁합 풀이가 가능합니다."),m(!1),v(""),N(C,"0"),he(k),L.current=!1;return}const u=Se(t,o),c=U(),d=Xe(c);if(c&&c.text&&d===u){j(c.text),E(c.myPillars||s),T(c.partnerPillars||r),c.myMeta&&H(c.myMeta),c.partnerMeta&&Y(c.partnerMeta),m(!0),v("saved"),N(C,"1");return}await Le(t,o,s,r,u)},Pe=()=>{g({...oe,calendar:"solar",gender:D,mbti:""}),E(null),T(null),H(null),Y(null),j(""),B(""),m(!1),v(""),N(C,"0"),he(k),$.current=!1,L.current=!1},ke=[{value:"solar",label:"양력"},{value:"lunar",label:"음력"}],De=[{value:"male",label:"남성"},{value:"female",label:"여성"}],Fe=o.calendar==="lunar";if(!l)return a.jsx("div",{className:"calculator",children:a.jsx(Be,{homeHref:"/"})});const se=f;return i.useEffect(()=>{const e=()=>{window.pageYOffset>8&&(R.current=!0)},n=()=>{R.current=!0},s=()=>{R.current=!0},r=d=>{["PageDown","End"," ","Spacebar"].includes(d.key)&&(R.current=!0)};window.addEventListener("scroll",e,{passive:!0}),window.addEventListener("wheel",n,{passive:!0}),window.addEventListener("touchstart",s,{passive:!0}),window.addEventListener("keydown",r);const u=X.current;let c;return u&&(c=new IntersectionObserver(d=>{for(const y of d)y.isIntersecting&&y.intersectionRatio>=.99&&R.current&&!Q.current&&!Oe()&&(Q.current=!0,He(),V(!0))},{root:null,threshold:[.99]}),c.observe(u)),()=>{window.removeEventListener("scroll",e),window.removeEventListener("wheel",n),window.removeEventListener("touchstart",s),window.removeEventListener("keydown",r),c&&c.disconnect()}},[]),a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"calculator","aria-label":"궁합",children:[a.jsx(Ke,{show:se,title:"궁합 해석을 준비하고 있어요",message:"두 사람의 사주 기둥과 메타를 분석하는 중입니다."}),a.jsxs("div",{className:"card result","aria-busy":se?"true":"false",children:[a.jsx("h2",{children:"궁합"}),t?a.jsxs("div",{"aria-label":"내정보 요약",style:{marginTop:8,display:"flex",flexWrap:"wrap",alignItems:"center",gap:8,rowGap:6},children:[a.jsx("span",{"aria-hidden":"true",style:{padding:"4px 8px",borderRadius:999,background:"var(--muted)",fontSize:12,lineHeight:1},children:"내정보"}),O.map(({label:e,value:n},s)=>a.jsxs($e.Fragment,{children:[s>0&&a.jsx("span",{"aria-hidden":"true",style:{opacity:.35,margin:"0 4px"},children:"|"}),a.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:6,minWidth:0,whiteSpace:"nowrap"},children:[a.jsx("span",{style:{fontSize:12,color:"var(--ink-soft)"},children:e}),a.jsx("span",{style:{fontSize:15,letterSpacing:"-0.01em"},children:n})]})]},e))]}):null,a.jsxs("form",{onSubmit:Ie,style:{marginTop:16},children:[a.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:8},children:[a.jsx("h3",{className:"h4",style:{margin:0},children:"상대방 정보"}),h&&A==="saved"&&a.jsx("span",{role:"status","aria-live":"polite",style:{padding:"3px 8px",borderRadius:999,background:"var(--surface)",border:"1px solid var(--border)",fontSize:12,color:"var(--ink-strong)"},children:"저장완료"})]}),a.jsxs("fieldset",{disabled:h||f,"aria-disabled":h||f,style:{border:0,padding:0,margin:0},children:[a.jsxs("div",{className:"row cols-2",children:[a.jsx("div",{className:"field-calendar",children:a.jsx(ce,{label:"달력",options:ke,value:o.calendar,onChange:Te,ariaLabel:"달력 종류 선택",helper:"음력 선택 시 양력으로 자동 변환해 계산합니다."})}),Fe&&a.jsx("div",{className:"field-leap",children:a.jsx(M,{label:"윤달 여부",id:"p-leapMonth",options:[{value:"common",label:"평달"},{value:"leap",label:"윤달"}],value:o.leapMonth,onChange:e=>S("leapMonth",e.target.value),helper:"음력에서만 의미가 있습니다."})})]}),a.jsxs("div",{className:"row cols-2",children:[a.jsx("div",{className:"field-gender",children:a.jsx(ce,{label:"성별",options:De,value:o.gender,onChange:Re,ariaLabel:"성별 선택",helper:a.jsxs("span",{children:["성별은 ",a.jsx("strong",{children:"대운 방향(순/역행)"})," 계산에 사용됩니다."]})})}),a.jsx("div",{className:"field-mbti only-desktop",children:a.jsx(M,{label:"MBTI (선택사항)",id:"p-mbti-desktop",options:ie.map(e=>({value:e.value,label:e.label})),value:o.mbti||"",onChange:e=>S("mbti",e.target.value),helper:"더 개인화된 해석을 위해 선택해주세요"})})]}),a.jsxs("div",{className:"row cols-4 sm-cols-2","aria-label":"생년월일 및 시간 선택",children:[a.jsx("div",{className:"field-year",children:a.jsx(M,{label:"년도",id:"p-year",options:Ne,value:o.year,onChange:e=>S("year",e.target.value)})}),a.jsx("div",{className:"field-month",children:a.jsx(M,{label:"월",id:"p-month",options:je,value:o.month,onChange:e=>S("month",e.target.value)})}),a.jsx("div",{className:"field-day",children:a.jsx(M,{label:"일",id:"p-day",options:Ce,value:o.day,onChange:e=>S("day",e.target.value)})}),a.jsx("div",{className:"field-hour",children:a.jsx(M,{label:"시간",id:"p-hour",options:Ee,value:o.hour,onChange:e=>S("hour",e.target.value)})})]}),a.jsx("div",{className:"row only-mobile",style:{marginTop:"clamp(8px, 2.2vw, 16px)"},children:a.jsx("div",{className:"field-mbti",children:a.jsx(M,{label:"MBTI (선택사항)",id:"p-mbti-mobile",options:Me,value:o.mbti||"",onChange:e=>S("mbti",e.target.value),helper:"더 개인화된 해석을 위해 선택해주세요"})})})]}),a.jsxs("div",{className:"actions",style:{marginTop:"clamp(10px, 2.8vw, 20px)",gap:10},children:[a.jsx(ue,{variant:"text",type:"button",onClick:Pe,children:"초기화"}),a.jsx(ue,{type:"submit",disabled:h||f||!z,"aria-disabled":h||f||!z,title:h?"이전 결과가 저장되었습니다. 초기화를 누르면 해제됩니다.":z?void 0:"필수 정보를 먼저 입력하세요.",children:f?"분석 중…":h?"저장완료":"궁합 보기"})]})]}),(F||_)&&a.jsxs("div",{className:"row cols-2 sm-cols-1",style:{marginTop:16},children:[a.jsxs("section",{style:{display:"grid",gap:8},children:[a.jsx("h3",{id:"compat-my-header",className:"h4",style:{margin:0},children:"내 사주 기둥"}),F?a.jsx(de,{pillars:F,idPrefix:"my"}):a.jsx("p",{className:"muted",style:{margin:0},children:"내 정보가 없어 표시할 수 없습니다."})]}),a.jsxs("section",{style:{display:"grid",gap:8},children:[a.jsx("h3",{className:"h4",style:{margin:0},children:"상대방 사주 기둥"}),_?a.jsx(de,{pillars:_,idPrefix:"partner"}):a.jsx("p",{className:"muted",style:{margin:0},children:"상대방 정보를 먼저 입력해 주세요."})]})]}),F&&_&&a.jsxs("section",{style:{display:"grid",gap:8,marginTop:16},children:[a.jsx("h3",{id:"compat-analysis-header",className:"h4",style:{margin:0},children:"궁합 풀이"}),!f&&a.jsx(Ue,{content:G,isLoading:!1,error:be})]})]})]}),a.jsx("div",{ref:X,"aria-hidden":!0,style:{height:1}}),a.jsx(We,{isOpen:we,onClose:()=>V(!1),pageTitle:"궁합",shareText:"궁합 결과가 도움이 되셨다면 지인과 공유해 보세요."})]})}export{lt as default};
