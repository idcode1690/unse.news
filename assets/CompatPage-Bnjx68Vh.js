import{r as i,j as n,I as Je,R as Ke}from"./index-CNdVkFF5.js";import{a as ke,D as ce,k as V,M as ue,i as Ue,j as qe,S as de,d as I,B as me,m as We}from"./cookieUtils-fixozt5I.js";import{s as Ve,P as he,l as Qe,c as Xe,a as fe}from"./sajuExtras-LbL1oaer.js";import{F as Ze,A as je,c as Oe}from"./openaiService-CEHq7sOl.js";import{S as et}from"./ShareModal-DxElo6DM.js";const b="compat_locked",$="compat_partner",q="compat_skip_scroll_on_return";function we(t){try{return localStorage.getItem(t)}catch{return null}}function P(t,l){try{localStorage.setItem(t,l)}catch{}}function ge(t){try{localStorage.removeItem(t)}catch{}}function tt(t){try{return sessionStorage.getItem(t)}catch{return null}}function ye(t,l){try{sessionStorage.setItem(t,l)}catch{}}function at(t){return t=Number(t),!Number.isFinite(t)||t<=0?!1:t%400===0||t%4===0&&t%100!==0}function pe(t,l){const f=Number(t),h=Number(l);return!Number.isFinite(h)||h<1||h>12?31:h===2?at(f)?29:28:[4,6,9,11].includes(h)?30:31}function ve(t){if(t===""||t===null||t===void 0)return null;const l=Number(t);return Number.isFinite(l)&&l>=0&&l<=23?l:null}function Q(t){return t==null?"":String(t).trim().toUpperCase()}function xe(t){var C,S,E,w,L;const l=(t==null?void 0:t.calendar)||"solar",f=(C=t==null?void 0:t.year)!=null?C:"",h=(S=t==null?void 0:t.month)!=null?S:"",G=(E=t==null?void 0:t.day)!=null?E:"",N=(w=t==null?void 0:t.hour)!=null?w:"",A=(L=t==null?void 0:t.minute)!=null?L:"0",z=(t==null?void 0:t.gender)||"",r=(t==null?void 0:t.leapMonth)||(t!=null&&t.isLeap?"leap":"common"),x=Q(t==null?void 0:t.mbti);return[l,`${f}-${h}-${G}`,`${N}:${A}`,z,r,x].join("|")}function Me(t,l){return`ME:${xe(t)}||PARTNER:${xe(l)}`}function nt(t){return t?t.signature?t.signature:t.me&&t.partner?Me(t.me,t.partner):null:null}function Se(){const t=we(b);if(t==="1")return!0;if(t==="0")return!1;try{const l=V();if(l&&(l.text||l.myPillars||l.partnerPillars))return!0}catch{}return!1}function W(t){const l=t||{};return{calendar:l.calendar||"solar",leapMonth:l.leapMonth||"common",gender:l.gender||"female",mbti:l.mbti||"",year:l.year?String(l.year):"",month:l.month?String(l.month):"",day:l.day?String(l.day):"",hour:l.hour!=null?String(l.hour):"",minute:l.minute!=null?String(l.minute):""}}function ut(){i.useEffect(()=>{Ve({title:"궁합",description:"상생·상극 밸런스와 소통 팁을 사주 기둥 기반으로 확인하세요.",path:"/#/compat",image:"/og-image.png"})},[]);const t=ke(),l=!!t,[f,h]=i.useState(Se),[G,N]=i.useState(()=>Se()?"saved":""),A=i.useMemo(()=>(t==null?void 0:t.gender)==="male"?"female":(t==null?void 0:t.gender)==="female"?"male":"female",[t]),z=i.useMemo(()=>{var m;if(!t)return[];const e=t.calendar==="lunar",a=e?"음력":"양력",o=e&&(t.leapMonth==="leap"||t.isLeap)?" (윤달)":"",s=[t.year,t.month,t.day].filter(Boolean).join("."),u=((m=t==null?void 0:t.hour)!=null?m:"")!==""?`${t.hour}시`:"—",c=t.gender==="male"?"남성":t.gender==="female"?"여성":"—",d=t.mbti?String(t.mbti).toUpperCase():"—";return[{label:"달력",value:`${a}${o}`.trim()},{label:"생년월일",value:s||"—"},{label:"시간",value:u},{label:"성별",value:c},{label:"MBTI",value:d}]},[t]),[r,x]=i.useState(()=>({...ce,calendar:"solar",gender:A,mbti:""})),[C,S]=i.useState(null),[E,w]=i.useState(null),[L,J]=i.useState(null),[st,K]=i.useState(null),[k,F]=i.useState(""),[p,X]=i.useState(!1),[Ne,H]=i.useState(""),[Ce,Z]=i.useState(!1),j=i.useRef(!1),B=i.useRef(!1),O=i.useRef(null),D=i.useRef(!1),Y=i.useRef(!1);i.useEffect(()=>(tt(q),ye(q,"0"),()=>{ye(q,"1")}),[]),i.useEffect(()=>{const e=V();e&&(e.myPillars&&S(e.myPillars),e.partnerPillars&&w(e.partnerPillars),e.text&&F(e.text),e.myMeta&&J(e.myMeta),e.partnerMeta&&K(e.partnerMeta));let a=null;const o=we($);if(o)try{a=JSON.parse(o)}catch{}!a&&e&&e.partner&&(a=e.partner),a&&x(s=>({...s,...W(a)}))},[]);const Ee=i.useMemo(()=>ue.map(e=>({value:e.value,label:e.label})),[]),Te=i.useMemo(()=>{const e=[];for(let a=1900;a<=2029;a++)e.push({value:String(a),label:`${a}년`});return e},[]),Re=i.useMemo(()=>{const e=[];for(let a=1;a<=12;a++)e.push({value:String(a),label:`${a}월`});return e},[]),Ie=i.useMemo(()=>{const a=r.calendar==="lunar"?30:pe(r.year,r.month),o=[];for(let s=1;s<=a;s++)o.push({value:String(s),label:`${s}일`});return o},[r.calendar,r.year,r.month]),Pe=i.useMemo(()=>{const e=[{value:"",label:"모름"}];for(let a=0;a<24;a++)e.push({value:String(a),label:`${String(a).padStart(2,"0")}시`});return e},[]),ee=e=>{const a={...e},s=a.calendar==="lunar"?30:pe(a.year,a.month),u=Number(a.day);return(!u||u>s)&&(a.day=String(Math.min(u||1,s))),a},Fe=e=>x(a=>ee({...a,calendar:e})),_e=e=>x(a=>({...a,gender:e})),T=(e,a)=>{x(e==="year"||e==="month"||e==="leapMonth"?o=>ee({...o,[e]:a}):o=>({...o,[e]:a}))},U=i.useMemo(()=>{const e=r.year&&r.month&&r.day,a=r.calendar==="solar"||!!r.leapMonth;return!!(e&&a&&r.gender)},[r]);function te(e){const a=e.calendar||"solar",o=Number(e.year),s=Number(e.month),u=Number(e.day),c=ve(e.hour),d=c!=null?c:12,m=e.minute!=null?Number(e.minute):0,v=e.leapMonth==="leap"||e.isLeap;let g=o,y=s,M=u;if(a==="lunar"){const R=Qe(o,s,u,v),_=R instanceof Date?R:new Date(R);g=_.getFullYear(),y=_.getMonth()+1,M=_.getDate()}return Xe(g,y,M,d,m)}const ae=i.useCallback(()=>{try{const e=document.querySelector("header, .header, [role='banner']");if(!e)return 0;const a=getComputedStyle(e).position||"";return/fixed|sticky/i.test(a)?Math.ceil(e.getBoundingClientRect().height||0):0}catch{return 0}},[]),ne=i.useCallback(e=>{if(!e||typeof window=="undefined")return null;let a=e.parentElement;for(;a;){const o=window.getComputedStyle(a),s=o.overflowY||o.overflow;if(/(auto|scroll|overlay)/i.test(s))return a;a=a.parentElement}return null},[]),se=i.useCallback(e=>{if(!e)return!1;const a=14,o=ae(),s=ne(e)||window;let u;if(s===window){const M=e.getBoundingClientRect();u=(window.scrollY||window.pageYOffset)+M.top}else{const M=e.getBoundingClientRect(),R=s.getBoundingClientRect();u=s.scrollTop+(M.top-R.top)}const c=Math.max(0,u-o-a),d=document.scrollingElement||document.documentElement,m=s===window?window.innerHeight||d.clientHeight:s.clientHeight,v=s===window?d.scrollHeight:s.scrollHeight,g=Math.max(0,v-m),y=Math.min(c,g);try{s===window?window.scrollTo({top:y,behavior:"smooth"}):s.scrollTo({top:y,behavior:"smooth"})}catch{s===window?window.scrollTo(0,y):s.scrollTop=y}return!0},[ae,ne]);i.useEffect(()=>{if(!Y.current&&!p&&k&&D.current){const e=document.getElementById("compat-my-header")||document.querySelector("h3.h4, h3");e&&requestAnimationFrame(()=>setTimeout(()=>{se(e)&&(Y.current=!0,D.current=!1)},80))}},[p,k,se]);function re(e,a){var m,v;const o=Number(e==null?void 0:e.year),s=Number(e==null?void 0:e.month),u=Number(e==null?void 0:e.day),c=(m=ve(e==null?void 0:e.hour))!=null?m:12,d=(e==null?void 0:e.minute)!=null?Number(e.minute):0;return{y:o,m:s,d:u,hh:c,mm:d,gender:(e==null?void 0:e.gender)||"unknown",yearStem:(v=a==null?void 0:a.year)==null?void 0:v.stem}}async function be(e,a,o,s,u){var c,d,m,v;X(!0),H(""),F("");try{const g={calendar:e==null?void 0:e.calendar,year:e==null?void 0:e.year,month:e==null?void 0:e.month,day:e==null?void 0:e.day,hour:(c=e==null?void 0:e.hour)!=null?c:"",minute:(d=e==null?void 0:e.minute)!=null?d:"0",gender:e==null?void 0:e.gender,leapMonth:e==null?void 0:e.leapMonth,mbti:Q(e==null?void 0:e.mbti)},y={calendar:a==null?void 0:a.calendar,year:a==null?void 0:a.year,month:a==null?void 0:a.month,day:a==null?void 0:a.day,hour:(m=a==null?void 0:a.hour)!=null?m:"",minute:(v=a==null?void 0:a.minute)!=null?v:"0",gender:a==null?void 0:a.gender,leapMonth:a==null?void 0:a.leapMonth,mbti:Q(a==null?void 0:a.mbti)},M=re(e,o),R=re(a,s),_=fe(o,{birth:M,mode:"compat"}),le=fe(s,{birth:R,mode:"compat"}),Ye={me:{input:g,pillars:o,meta:_},partner:{input:y,pillars:s,meta:le},guidance:{must_use:["오행 분포/균형","용신·기신","십성(육친)","신살","합·충·형·해·파·원진","격국(요지)","대운·세운 톤(과도한 단정 금지)"],avoid:["JSON 외 임의 간지/점수 생성","과장/공포 유발 표현","개인정보/생년월일 재기술"]}},Ge=["당신은 명리·사주 풀이 무당입니다. 궁합을 풀이하고 다음 규칙을 반드시 지킵니다.","모르거나 부정확한 풀이는 허위로 작성하지 말고 완전히 작성하지 마세요","소제목은 h3(###) 형식으로 작성하고, 추가 소제목/서론/결론/요약 금지","오직 제공된 JSON(양측의 4주와 meta: 용신·기신·십성·신살·오행분포·합충형해파·격국 등)만을 근거로 서술하세요.","새 간지/점수/절기 생성 금지, 외부 추정 금지, 단정/공포 금지.","궁합 총평, 성격풀이, 겉궁합 풀이, 속궁합 풀이, 섹스풀이로 소제목을 작성해줘.","각 항목 500자 이상 작성하고, 반복/상투어 금지, 구체 사례/상호작용 중심.","조언, 해결책제시는 금지. 오로지 사주풀이만 작성해주세요","생년월일/시각은 본문에 재기술하지 마세요(이미 별도로 제공됨)."].join(" "),ze=["분석 JSON:","```json",JSON.stringify(Ye,null,2),"```","","지침:","- 용신과 기신의 상호작용(상생/상극)으로 관계의 균형·보완 포인트를 설명하세요.","- 양측 십성(육친)과 신살을 비교하여 소통/신뢰/갈등 포인트를 구체화하세요.","- 합·충·형·해·파·원진이 성립하면 해당 영역에 미칠 가능성을 사례로 연결하세요.","- 과한 점괘식 표현/점수화/별점/색상 표기는 금지합니다."].join(`
`),Le=await Oe({messages:[{role:"system",content:Ge},{role:"user",content:ze}]}),ie=String(Le||"").trim();F(ie),We({me:g,partner:y,myPillars:o,partnerPillars:s,myMeta:_,partnerMeta:le,text:ie,signature:u,ts:Date.now()}),h(!0),N("saved"),P(b,"1"),P($,JSON.stringify(W(y)))}catch(g){H((g==null?void 0:g.message)||String(g))}finally{X(!1)}}const Be=async e=>{e.preventDefault(),D.current=!0,Y.current=!1,h(!0),N("");const a=W(r);P(b,"1"),P($,JSON.stringify(a));let o=null;t!=null&&t.year&&(t!=null&&t.month)&&(t!=null&&t.day)?(o=te(t),S(o)):S(null);let s=null;if(r!=null&&r.year&&(r!=null&&r.month)&&(r!=null&&r.day)?(s=te(r),w(s)):w(null),!(o&&s)){F(""),H("내 정보와 상대방 정보를 모두 입력해야 궁합 풀이가 가능합니다."),h(!1),N(""),P(b,"0"),ge($),D.current=!1;return}const u=Me(t,r),c=V(),d=nt(c);if(c&&c.text&&d===u){F(c.text),S(c.myPillars||o),w(c.partnerPillars||s),c.myMeta&&J(c.myMeta),c.partnerMeta&&K(c.partnerMeta),h(!0),N("saved"),P(b,"1");return}await be(t,r,o,s,u)},De=()=>{x({...ce,calendar:"solar",gender:A,mbti:""}),S(null),w(null),J(null),K(null),F(""),H(""),h(!1),N(""),P(b,"0"),ge($),Y.current=!1,D.current=!1},$e=[{value:"solar",label:"양력"},{value:"lunar",label:"음력"}],Ae=[{value:"male",label:"남성"},{value:"female",label:"여성"}],He=r.calendar==="lunar";if(!l)return n.jsx("div",{className:"calculator",children:n.jsx(Je,{homeHref:"/"})});const oe=p;return i.useEffect(()=>{const e=()=>{window.pageYOffset>8&&(B.current=!0)},a=()=>{B.current=!0},o=()=>{B.current=!0},s=d=>{["PageDown","End"," ","Spacebar"].includes(d.key)&&(B.current=!0)};window.addEventListener("scroll",e,{passive:!0}),window.addEventListener("wheel",a,{passive:!0}),window.addEventListener("touchstart",o,{passive:!0}),window.addEventListener("keydown",s);const u=O.current;let c;return u&&(c=new IntersectionObserver(d=>{for(const m of d)m.isIntersecting&&m.intersectionRatio>=.99&&B.current&&!j.current&&!Ue()&&(j.current=!0,qe(),Z(!0))},{root:null,threshold:[.99]}),c.observe(u)),()=>{window.removeEventListener("scroll",e),window.removeEventListener("wheel",a),window.removeEventListener("touchstart",o),window.removeEventListener("keydown",s),c&&c.disconnect()}},[]),n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"calculator","aria-label":"궁합",children:[n.jsx(Ze,{show:oe,title:"궁합 해석을 준비하고 있어요",message:"두 사람의 사주 기둥과 메타를 분석하는 중입니다."}),n.jsxs("div",{className:"card result","aria-busy":oe?"true":"false",children:[n.jsx("h2",{children:"궁합"}),t?n.jsxs("div",{"aria-label":"내정보 요약",style:{marginTop:8,display:"flex",flexWrap:"wrap",alignItems:"center",gap:8,rowGap:6},children:[n.jsx("span",{"aria-hidden":"true",style:{padding:"4px 8px",borderRadius:999,background:"var(--muted)",fontSize:12,lineHeight:1},children:"내정보"}),z.map(({label:e,value:a},o)=>n.jsxs(Ke.Fragment,{children:[o>0&&n.jsx("span",{"aria-hidden":"true",style:{opacity:.35,margin:"0 4px"},children:"|"}),n.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:6,minWidth:0,whiteSpace:"nowrap"},children:[n.jsx("span",{style:{fontSize:12,color:"var(--ink-soft)"},children:e}),n.jsx("span",{style:{fontSize:15,letterSpacing:"-0.01em"},children:a})]})]},e))]}):null,n.jsxs("form",{onSubmit:Be,className:"form-compat",style:{marginTop:16},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("h3",{className:"h4",style:{margin:0},children:"상대방 정보"}),f&&G==="saved"&&n.jsx("span",{role:"status","aria-live":"polite",style:{padding:"3px 8px",borderRadius:999,background:"var(--surface)",border:"1px solid var(--border)",fontSize:12,color:"var(--ink-strong)"},children:"저장완료"})]}),n.jsxs("fieldset",{disabled:f||p,"aria-disabled":f||p,className:f||p?"fieldset-locked":void 0,style:{border:0,padding:0,margin:0},children:[n.jsxs("div",{className:"row cols-2",children:[n.jsx("div",{className:"field-calendar",children:n.jsx(de,{label:"달력",options:$e,value:r.calendar,onChange:Fe,ariaLabel:"달력 종류 선택"})}),He&&n.jsx("div",{className:"field-leap",children:n.jsx(I,{label:"윤달 여부",id:"p-leapMonth",options:[{value:"common",label:"평달"},{value:"leap",label:"윤달"}],value:r.leapMonth,onChange:e=>T("leapMonth",e.target.value)})})]}),n.jsxs("div",{className:"row cols-2",children:[n.jsx("div",{className:"field-gender",children:n.jsx(de,{label:"성별",options:Ae,value:r.gender,onChange:_e,ariaLabel:"성별 선택"})}),n.jsx("div",{className:"field-mbti only-desktop",children:n.jsx(I,{label:"MBTI (선택사항)",id:"p-mbti-desktop",options:ue.map(e=>({value:e.value,label:e.label})),value:r.mbti||"",onChange:e=>T("mbti",e.target.value)})})]}),n.jsxs("div",{className:"row cols-4 sm-cols-2","aria-label":"생년월일 및 시간 선택",children:[n.jsx("div",{className:"field-year",children:n.jsx(I,{label:"년도",id:"p-year",options:Te,value:r.year,onChange:e=>T("year",e.target.value)})}),n.jsx("div",{className:"field-month",children:n.jsx(I,{label:"월",id:"p-month",options:Re,value:r.month,onChange:e=>T("month",e.target.value)})}),n.jsx("div",{className:"field-day",children:n.jsx(I,{label:"일",id:"p-day",options:Ie,value:r.day,onChange:e=>T("day",e.target.value)})}),n.jsx("div",{className:"field-hour",children:n.jsx(I,{label:"시간",id:"p-hour",options:Pe,value:r.hour,onChange:e=>T("hour",e.target.value)})})]}),n.jsx("div",{className:"row only-mobile",children:n.jsx("div",{className:"field-mbti",children:n.jsx(I,{label:"MBTI (선택사항)",id:"p-mbti-mobile",options:Ee,value:r.mbti||"",onChange:e=>T("mbti",e.target.value)})})})]}),n.jsxs("div",{className:"actions",children:[n.jsx(me,{variant:"text",type:"button",onClick:De,children:"초기화"}),n.jsx(me,{type:"submit",disabled:f||p||!U,"aria-disabled":f||p||!U,title:f?"이전 결과가 저장되었습니다. 초기화를 누르면 해제됩니다.":U?void 0:"필수 정보를 먼저 입력하세요.",children:p?"분석 중…":f?"저장완료":"궁합 보기"})]})]}),(C||E)&&n.jsxs("div",{className:"row cols-2 sm-cols-1",style:{marginTop:16},children:[n.jsxs("section",{style:{display:"grid",gap:8},children:[n.jsx("h3",{id:"compat-my-header",className:"h4",style:{margin:0},children:"내 사주 기둥"}),C?n.jsx(he,{pillars:C,idPrefix:"my"}):n.jsx("p",{className:"muted",style:{margin:0},children:"내 정보가 없어 표시할 수 없습니다."})]}),n.jsxs("section",{style:{display:"grid",gap:8},children:[n.jsx("h3",{className:"h4",style:{margin:0},children:"상대방 사주 기둥"}),E?n.jsx(he,{pillars:E,idPrefix:"partner"}):n.jsx("p",{className:"muted",style:{margin:0},children:"상대방 정보를 먼저 입력해 주세요."})]})]}),C&&E&&n.jsxs("section",{style:{display:"grid",gap:8,marginTop:16},children:[n.jsx("h3",{id:"compat-analysis-header",className:"h4",style:{margin:0},children:"궁합 풀이"}),!p&&n.jsx(je,{content:k,isLoading:!1,error:Ne})]})]})]}),n.jsx("div",{ref:O,"aria-hidden":!0,style:{height:1}}),n.jsx(et,{isOpen:Ce,onClose:()=>Z(!1),pageTitle:"궁합",shareText:"궁합 결과가 도움이 되셨다면 지인과 공유해 보세요."}),n.jsx("style",{children:`
        :root{ --row-gap: 14px; --col-gap: 12px; }

        .form-compat .row{
          display: grid;
          gap: var(--row-gap) var(--col-gap);
          margin: 0;
        }
        .form-compat .row + .row{
          margin-top: var(--row-gap);
        }
        .form-compat .row > [class^="field-"]{
          margin: 0;
        }

        .form-compat .actions{
          margin-top: var(--row-gap);
          display: flex;
          gap: 10px;
        }

        /* 홈 폼과 동일: 락 시 포인터 차단 */
        .fieldset-locked { opacity: 0.98; }
        .fieldset-locked * {
          pointer-events: none !important;
          cursor: not-allowed !important;
        }
      `})]})}export{ut as default};
