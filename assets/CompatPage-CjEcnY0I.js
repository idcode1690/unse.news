import{r as i,j as n,I as Be,R as $e}from"./index-XpcX2Vby.js";import{a as Ae,D as le,k as U,M as ie,i as Oe,j as He,S as ce,d as M,B as ue,m as Ye}from"./index-BXLhSbu3.js";import{s as Ge,P as de,l as ze,c as Je,a as me}from"./seo-Dz25LcOt.js";import{F as Ke,A as Ue,c as qe}from"./openaiService-C30_TfBV.js";import{S as We}from"./ShareModal-CexRBAA7.js";const C="compat_locked",P="compat_partner",J="compat_skip_scroll_on_return";function xe(t){try{return localStorage.getItem(t)}catch{return null}}function N(t,o){try{localStorage.setItem(t,o)}catch{}}function he(t){try{localStorage.removeItem(t)}catch{}}function Ve(t){try{return sessionStorage.getItem(t)}catch{return null}}function pe(t,o){try{sessionStorage.setItem(t,o)}catch{}}function Qe(t){return t=Number(t),!Number.isFinite(t)||t<=0?!1:t%400===0||t%4===0&&t%100!==0}function fe(t,o){const h=Number(t),m=Number(o);return!Number.isFinite(m)||m<1||m>12?31:m===2?Qe(h)?29:28:[4,6,9,11].includes(m)?30:31}function ge(t){if(t===""||t===null||t===void 0)return null;const o=Number(t);return Number.isFinite(o)&&o>=0&&o<=23?o:null}function q(t){return t==null?"":String(t).trim().toUpperCase()}function ye(t){const o=t?.calendar||"solar",h=t?.year??"",m=t?.month??"",A=t?.day??"",x=t?.hour??"",D=t?.minute??"0",O=t?.gender||"",l=t?.leapMonth||(t?.isLeap?"leap":"common"),g=q(t?.mbti);return[o,`${h}-${m}-${A}`,`${x}:${D}`,O,l,g].join("|")}function Se(t,o){return`ME:${ye(t)}||PARTNER:${ye(o)}`}function Xe(t){return t?t.signature?t.signature:t.me&&t.partner?Se(t.me,t.partner):null:null}function ve(){const t=xe(C);if(t==="1")return!0;if(t==="0")return!1;try{const o=U();if(o&&(o.text||o.myPillars||o.partnerPillars))return!0}catch{}return!1}function K(t){const o=t||{};return{calendar:o.calendar||"solar",leapMonth:o.leapMonth||"common",gender:o.gender||"female",mbti:o.mbti||"",year:o.year?String(o.year):"",month:o.month?String(o.month):"",day:o.day?String(o.day):"",hour:o.hour!=null?String(o.hour):"",minute:o.minute!=null?String(o.minute):""}}function ot(){i.useEffect(()=>{Ge({title:"궁합",description:"상생·상극 밸런스와 소통 팁을 사주 기둥 기반으로 확인하세요.",path:"/#/compat",image:"/og-image.png"})},[]);const t=Ae(),o=!!t,[h,m]=i.useState(ve),[A,x]=i.useState(()=>ve()?"saved":""),D=i.useMemo(()=>t?.gender==="male"?"female":t?.gender==="female"?"male":"female",[t]),O=i.useMemo(()=>{if(!t)return[];const e=t.calendar==="lunar",a=e?"음력":"양력",s=e&&(t.leapMonth==="leap"||t.isLeap)?" (윤달)":"",r=[t.year,t.month,t.day].filter(Boolean).join("."),u=(t?.hour??"")!==""?`${t.hour}시`:"—",c=t.gender==="male"?"남성":t.gender==="female"?"여성":"—",d=t.mbti?String(t.mbti).toUpperCase():"—";return[{label:"달력",value:`${a}${s}`.trim()},{label:"생년월일",value:r||"—"},{label:"시간",value:u},{label:"성별",value:c},{label:"MBTI",value:d}]},[t]),[l,g]=i.useState(()=>({...le,calendar:"solar",gender:D,mbti:""})),[F,E]=i.useState(null),[_,T]=i.useState(null),[Ze,H]=i.useState(null),[et,Y]=i.useState(null),[G,j]=i.useState(""),[p,W]=i.useState(!1),[be,B]=i.useState(""),[we,V]=i.useState(!1),Q=i.useRef(!1),R=i.useRef(!1),X=i.useRef(null),L=i.useRef(!1),$=i.useRef(!1);i.useEffect(()=>(Ve(J),pe(J,"0"),()=>{pe(J,"1")}),[]),i.useEffect(()=>{const e=U();e&&(e.myPillars&&E(e.myPillars),e.partnerPillars&&T(e.partnerPillars),e.text&&j(e.text),e.myMeta&&H(e.myMeta),e.partnerMeta&&Y(e.partnerMeta));let a=null;const s=xe(P);if(s)try{a=JSON.parse(s)}catch{}!a&&e&&e.partner&&(a=e.partner),a&&g(r=>({...r,...K(a)}))},[]);const Me=i.useMemo(()=>ie.map(e=>({value:e.value,label:e.label})),[]),Ne=i.useMemo(()=>{const e=[];for(let a=1900;a<=2029;a++)e.push({value:String(a),label:`${a}년`});return e},[]),je=i.useMemo(()=>{const e=[];for(let a=1;a<=12;a++)e.push({value:String(a),label:`${a}월`});return e},[]),Ce=i.useMemo(()=>{const a=l.calendar==="lunar"?30:fe(l.year,l.month),s=[];for(let r=1;r<=a;r++)s.push({value:String(r),label:`${r}일`});return s},[l.calendar,l.year,l.month]),Ee=i.useMemo(()=>{const e=[{value:"",label:"모름"}];for(let a=0;a<24;a++)e.push({value:String(a),label:`${String(a).padStart(2,"0")}시`});return e},[]),Z=e=>{const a={...e},r=a.calendar==="lunar"?30:fe(a.year,a.month),u=Number(a.day);return(!u||u>r)&&(a.day=String(Math.min(u||1,r))),a},Te=e=>g(a=>Z({...a,calendar:e})),Re=e=>g(a=>({...a,gender:e})),S=(e,a)=>{g(e==="year"||e==="month"||e==="leapMonth"?s=>Z({...s,[e]:a}):s=>({...s,[e]:a}))},z=i.useMemo(()=>{const e=l.year&&l.month&&l.day,a=l.calendar==="solar"||!!l.leapMonth;return!!(e&&a&&l.gender)},[l]);function ee(e){const a=e.calendar||"solar",s=Number(e.year),r=Number(e.month),u=Number(e.day),d=ge(e.hour)??12,y=e.minute!=null?Number(e.minute):0,I=e.leapMonth==="leap"||e.isLeap;let b=s,f=r,v=u;if(a==="lunar"){const w=ze(s,r,u,I),k=w instanceof Date?w:new Date(w);b=k.getFullYear(),f=k.getMonth()+1,v=k.getDate()}return Je(b,f,v,d,y)}const te=i.useCallback(()=>{try{const e=document.querySelector("header, .header, [role='banner']");if(!e)return 0;const a=getComputedStyle(e).position||"";return/fixed|sticky/i.test(a)?Math.ceil(e.getBoundingClientRect().height||0):0}catch{return 0}},[]),ae=i.useCallback(e=>{if(!e||typeof window>"u")return null;let a=e.parentElement;for(;a;){const s=window.getComputedStyle(a),r=s.overflowY||s.overflow;if(/(auto|scroll|overlay)/i.test(r))return a;a=a.parentElement}return null},[]),ne=i.useCallback(e=>{if(!e)return!1;const a=14,s=te(),r=ae(e)||window;let u;if(r===window){const v=e.getBoundingClientRect();u=(window.scrollY||window.pageYOffset)+v.top}else{const v=e.getBoundingClientRect(),w=r.getBoundingClientRect();u=r.scrollTop+(v.top-w.top)}const c=Math.max(0,u-s-a),d=document.scrollingElement||document.documentElement,y=r===window?window.innerHeight||d.clientHeight:r.clientHeight,I=r===window?d.scrollHeight:r.scrollHeight,b=Math.max(0,I-y),f=Math.min(c,b);try{r===window?window.scrollTo({top:f,behavior:"smooth"}):r.scrollTo({top:f,behavior:"smooth"})}catch{r===window?window.scrollTo(0,f):r.scrollTop=f}return!0},[te,ae]);i.useEffect(()=>{if(!$.current&&!p&&G&&L.current){const e=document.getElementById("compat-my-header")||document.querySelector("h3.h4, h3");e&&requestAnimationFrame(()=>setTimeout(()=>{ne(e)&&($.current=!0,L.current=!1)},80))}},[p,G,ne]);function re(e,a){const s=Number(e?.year),r=Number(e?.month),u=Number(e?.day),c=ge(e?.hour)??12,d=e?.minute!=null?Number(e.minute):0;return{y:s,m:r,d:u,hh:c,mm:d,gender:e?.gender||"unknown",yearStem:a?.year?.stem}}async function Le(e,a,s,r,u){W(!0),B(""),j("");try{const c={calendar:e?.calendar,year:e?.year,month:e?.month,day:e?.day,hour:e?.hour??"",minute:e?.minute??"0",gender:e?.gender,leapMonth:e?.leapMonth,mbti:q(e?.mbti)},d={calendar:a?.calendar,year:a?.year,month:a?.month,day:a?.day,hour:a?.hour??"",minute:a?.minute??"0",gender:a?.gender,leapMonth:a?.leapMonth,mbti:q(a?.mbti)},y=re(e,s),I=re(a,r),b=me(s,{birth:y,mode:"compat"}),f=me(r,{birth:I,mode:"compat"}),v={me:{input:c,pillars:s,meta:b},partner:{input:d,pillars:r,meta:f},guidance:{must_use:["오행 분포/균형","용신·기신","십성(육친)","신살","합·충·형·해·파·원진","격국(요지)","대운·세운 톤(과도한 단정 금지)"],avoid:["JSON 외 임의 간지/점수 생성","과장/공포 유발 표현","개인정보/생년월일 재기술"]}},w=["당신은 명리·사주 풀이 무당입니다. 궁합을 풀이하고 다음 규칙을 반드시 지킵니다.","모르거나 부정확한 풀이는 허위로 작성하지 말고 완전히 작성하지 마세요","소제목은 h3(###) 형식으로 작성하고, 추가 소제목/서론/결론/요약 금지","오직 제공된 JSON(양측의 4주와 meta: 용신·기신·십성·신살·오행분포·합충형해파·격국 등)만을 근거로 서술하세요.","새 간지/점수/절기 생성 금지, 외부 추정 금지, 단정/공포 금지.","궁합 총평, 성격풀이, 겉궁합 풀이, 속궁합 풀이, 섹스풀이로 소제목을 작성해줘.","각 항목 500자 이상 작성하고, 반복/상투어 금지, 구체 사례/상호작용 중심.","조언, 해결책제시는 금지. 오로지 사주풀이만 작성해주세요","생년월일/시각은 본문에 재기술하지 마세요(이미 별도로 제공됨)."].join(" "),k=["분석 JSON:","```json",JSON.stringify(v,null,2),"```","","지침:","- 용신과 기신의 상호작용(상생/상극)으로 관계의 균형·보완 포인트를 설명하세요.","- 양측 십성(육친)과 신살을 비교하여 소통/신뢰/갈등 포인트를 구체화하세요.","- 합·충·형·해·파·원진이 성립하면 해당 영역에 미칠 가능성을 사례로 연결하세요.","- 과한 점괘식 표현/점수화/별점/색상 표기는 금지합니다."].join(`
`),_e=await qe({messages:[{role:"system",content:w},{role:"user",content:k}]}),oe=String(_e||"").trim();j(oe),Ye({me:c,partner:d,myPillars:s,partnerPillars:r,myMeta:b,partnerMeta:f,text:oe,signature:u,ts:Date.now()}),m(!0),x("saved"),N(C,"1"),N(P,JSON.stringify(K(d)))}catch(c){B(c?.message||String(c))}finally{W(!1)}}const Ie=async e=>{e.preventDefault(),L.current=!0,$.current=!1,m(!0),x("");const a=K(l);N(C,"1"),N(P,JSON.stringify(a));let s=null;t?.year&&t?.month&&t?.day?(s=ee(t),E(s)):E(null);let r=null;if(l?.year&&l?.month&&l?.day?(r=ee(l),T(r)):T(null),!(s&&r)){j(""),B("내 정보와 상대방 정보를 모두 입력해야 궁합 풀이가 가능합니다."),m(!1),x(""),N(C,"0"),he(P),L.current=!1;return}const u=Se(t,l),c=U(),d=Xe(c);if(c&&c.text&&d===u){j(c.text),E(c.myPillars||s),T(c.partnerPillars||r),c.myMeta&&H(c.myMeta),c.partnerMeta&&Y(c.partnerMeta),m(!0),x("saved"),N(C,"1");return}await Le(t,l,s,r,u)},ke=()=>{g({...le,calendar:"solar",gender:D,mbti:""}),E(null),T(null),H(null),Y(null),j(""),B(""),m(!1),x(""),N(C,"0"),he(P),$.current=!1,L.current=!1},Pe=[{value:"solar",label:"양력"},{value:"lunar",label:"음력"}],De=[{value:"male",label:"남성"},{value:"female",label:"여성"}],Fe=l.calendar==="lunar";if(!o)return n.jsx("div",{className:"calculator",children:n.jsx(Be,{homeHref:"/"})});const se=p;return i.useEffect(()=>{const e=()=>{window.pageYOffset>8&&(R.current=!0)},a=()=>{R.current=!0},s=()=>{R.current=!0},r=d=>{["PageDown","End"," ","Spacebar"].includes(d.key)&&(R.current=!0)};window.addEventListener("scroll",e,{passive:!0}),window.addEventListener("wheel",a,{passive:!0}),window.addEventListener("touchstart",s,{passive:!0}),window.addEventListener("keydown",r);const u=X.current;let c;return u&&(c=new IntersectionObserver(d=>{for(const y of d)y.isIntersecting&&y.intersectionRatio>=.99&&R.current&&!Q.current&&!Oe()&&(Q.current=!0,He(),V(!0))},{root:null,threshold:[.99]}),c.observe(u)),()=>{window.removeEventListener("scroll",e),window.removeEventListener("wheel",a),window.removeEventListener("touchstart",s),window.removeEventListener("keydown",r),c&&c.disconnect()}},[]),n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"calculator","aria-label":"궁합",children:[n.jsx(Ke,{show:se,title:"궁합 해석을 준비하고 있어요",message:"두 사람의 사주 기둥과 메타를 분석하는 중입니다."}),n.jsxs("div",{className:"card result","aria-busy":se?"true":"false",children:[n.jsx("h2",{children:"궁합"}),t?n.jsxs("div",{"aria-label":"내정보 요약",style:{marginTop:8,display:"flex",flexWrap:"wrap",alignItems:"center",gap:8,rowGap:6},children:[n.jsx("span",{"aria-hidden":"true",style:{padding:"4px 8px",borderRadius:999,background:"var(--muted)",fontSize:12,lineHeight:1},children:"내정보"}),O.map(({label:e,value:a},s)=>n.jsxs($e.Fragment,{children:[s>0&&n.jsx("span",{"aria-hidden":"true",style:{opacity:.35,margin:"0 4px"},children:"|"}),n.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:6,minWidth:0,whiteSpace:"nowrap"},children:[n.jsx("span",{style:{fontSize:12,color:"var(--ink-soft)"},children:e}),n.jsx("span",{style:{fontSize:15,letterSpacing:"-0.01em"},children:a})]})]},e))]}):null,n.jsxs("form",{onSubmit:Ie,className:"form-compat",style:{marginTop:16},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("h3",{className:"h4",style:{margin:0},children:"상대방 정보"}),h&&A==="saved"&&n.jsx("span",{role:"status","aria-live":"polite",style:{padding:"3px 8px",borderRadius:999,background:"var(--surface)",border:"1px solid var(--border)",fontSize:12,color:"var(--ink-strong)"},children:"저장완료"})]}),n.jsxs("fieldset",{disabled:h||p,"aria-disabled":h||p,className:h||p?"fieldset-locked":void 0,style:{border:0,padding:0,margin:0},children:[n.jsxs("div",{className:"row cols-2",children:[n.jsx("div",{className:"field-calendar",children:n.jsx(ce,{label:"달력",options:Pe,value:l.calendar,onChange:Te,ariaLabel:"달력 종류 선택"})}),Fe&&n.jsx("div",{className:"field-leap",children:n.jsx(M,{label:"윤달 여부",id:"p-leapMonth",options:[{value:"common",label:"평달"},{value:"leap",label:"윤달"}],value:l.leapMonth,onChange:e=>S("leapMonth",e.target.value)})})]}),n.jsxs("div",{className:"row cols-2",children:[n.jsx("div",{className:"field-gender",children:n.jsx(ce,{label:"성별",options:De,value:l.gender,onChange:Re,ariaLabel:"성별 선택"})}),n.jsx("div",{className:"field-mbti only-desktop",children:n.jsx(M,{label:"MBTI (선택사항)",id:"p-mbti-desktop",options:ie.map(e=>({value:e.value,label:e.label})),value:l.mbti||"",onChange:e=>S("mbti",e.target.value)})})]}),n.jsxs("div",{className:"row cols-4 sm-cols-2","aria-label":"생년월일 및 시간 선택",children:[n.jsx("div",{className:"field-year",children:n.jsx(M,{label:"년도",id:"p-year",options:Ne,value:l.year,onChange:e=>S("year",e.target.value)})}),n.jsx("div",{className:"field-month",children:n.jsx(M,{label:"월",id:"p-month",options:je,value:l.month,onChange:e=>S("month",e.target.value)})}),n.jsx("div",{className:"field-day",children:n.jsx(M,{label:"일",id:"p-day",options:Ce,value:l.day,onChange:e=>S("day",e.target.value)})}),n.jsx("div",{className:"field-hour",children:n.jsx(M,{label:"시간",id:"p-hour",options:Ee,value:l.hour,onChange:e=>S("hour",e.target.value)})})]}),n.jsx("div",{className:"row only-mobile",children:n.jsx("div",{className:"field-mbti",children:n.jsx(M,{label:"MBTI (선택사항)",id:"p-mbti-mobile",options:Me,value:l.mbti||"",onChange:e=>S("mbti",e.target.value)})})})]}),n.jsxs("div",{className:"actions",children:[n.jsx(ue,{variant:"text",type:"button",onClick:ke,children:"초기화"}),n.jsx(ue,{type:"submit",disabled:h||p||!z,"aria-disabled":h||p||!z,title:h?"이전 결과가 저장되었습니다. 초기화를 누르면 해제됩니다.":z?void 0:"필수 정보를 먼저 입력하세요.",children:p?"분석 중…":h?"저장완료":"궁합 보기"})]})]}),(F||_)&&n.jsxs("div",{className:"row cols-2 sm-cols-1",style:{marginTop:16},children:[n.jsxs("section",{style:{display:"grid",gap:8},children:[n.jsx("h3",{id:"compat-my-header",className:"h4",style:{margin:0},children:"내 사주 기둥"}),F?n.jsx(de,{pillars:F,idPrefix:"my"}):n.jsx("p",{className:"muted",style:{margin:0},children:"내 정보가 없어 표시할 수 없습니다."})]}),n.jsxs("section",{style:{display:"grid",gap:8},children:[n.jsx("h3",{className:"h4",style:{margin:0},children:"상대방 사주 기둥"}),_?n.jsx(de,{pillars:_,idPrefix:"partner"}):n.jsx("p",{className:"muted",style:{margin:0},children:"상대방 정보를 먼저 입력해 주세요."})]})]}),F&&_&&n.jsxs("section",{style:{display:"grid",gap:8,marginTop:16},children:[n.jsx("h3",{id:"compat-analysis-header",className:"h4",style:{margin:0},children:"궁합 풀이"}),!p&&n.jsx(Ue,{content:G,isLoading:!1,error:be})]})]})]}),n.jsx("div",{ref:X,"aria-hidden":!0,style:{height:1}}),n.jsx(We,{isOpen:we,onClose:()=>V(!1),pageTitle:"궁합",shareText:"궁합 결과가 도움이 되셨다면 지인과 공유해 보세요."}),n.jsx("style",{children:`
        :root{ --row-gap: 14px; --col-gap: 12px; }

        .form-compat .row{
          display: grid;
          gap: var(--row-gap) var(--col-gap);
          margin: 0;
        }
        .form-compat .row + .row{
          margin-top: var(--row-gap);
        }
        .form-compat .row > [class^="field-"]{
          margin: 0;
        }

        .form-compat .actions{
          margin-top: var(--row-gap);
          display: flex;
          gap: 10px;
        }

        /* 홈 폼과 동일: 락 시 포인터 차단 */
        .fieldset-locked { opacity: 0.98; }
        .fieldset-locked * {
          pointer-events: none !important;
          cursor: not-allowed !important;
        }
      `})]})}export{ot as default};
