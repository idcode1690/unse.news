import{r as n,j as t,I as q}from"./index-Jxt82uoD.js";import{c as H,a as P,P as W,s as _,S as Q}from"./ShareModal-DQhy4F-z.js";import{c as V,F as X,A as Z}from"./openaiService-DspiLxsH.js";import{f as ee,g as te,h as Y,l as se,a as ne,b as re,i as ae,j as oe,k as le,m as ie}from"./cookieUtils--qWSIfRP.js";function I(f){return String(f).padStart(2,"0")}function ce(){const f=Date.now(),S=new Date(f+9*3600*1e3),R=S.getUTCFullYear(),p=I(S.getUTCMonth()+1),x=I(S.getUTCDate());return`${R}.${p}.${x}`}const me=()=>{const[f,S]=n.useState(null),[R,p]=n.useState(null),[x,k]=n.useState(""),[v,N]=n.useState(!1),[b,$]=n.useState(""),[D,T]=n.useState(null),w=n.useMemo(()=>ce(),[]),E=n.useMemo(()=>{try{if(new URLSearchParams(window.location.search).get("debug")==="1"||localStorage.getItem("SAJU_DEBUG")==="1")return!0}catch{}return!1},[]),h=n.useCallback((e,o=void 0)=>{const s=Number(e);return Number.isFinite(s)?s:o},[]),F=n.useCallback(e=>{if(e?.sajuResult?.year&&e?.sajuResult?.month&&e?.sajuResult?.day&&e?.sajuResult?.hour)return e;const o=e.calendar||"solar",s=h(e.year),r=h(e.month),a=h(e.day),c=h(e.hour,0),g=h(e.minute,0),u=e.leapMonth==="leap"||e.isLeap===!0;let d,l,m;if(typeof e.solarDate=="string"){const i=String(e.solarDate).match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);i&&(d=h(i[1]),l=h(i[2]),m=h(i[3]))}if(!d||!l||!m)if(o==="lunar"){const i=ee(s,r,a,u),y=i instanceof Date?i:new Date(i);d=y.getFullYear(),l=y.getMonth()+1,m=y.getDate()}else d=s,l=r,m=a;const j=H(d,l,m,c,g);return{...e,calendar:o,solarDate:`${d}-${String(l).padStart(2,"0")}-${String(m).padStart(2,"0")}`,sajuResult:j,year:s,month:r,day:a,hour:c,minute:g}},[h]),C=n.useCallback((e,o)=>{const{calendar:s,year:r,month:a,day:c,hour:g,minute:u,gender:d,leapMonth:l,solarDate:m,mbti:j}=e||{},i=(o?.mbti||j||"").toUpperCase();return["SAJU",s,`${r}-${a}-${c}`,`${g}:${u}`,d,l,m||"",i].join("|")},[]),J=n.useCallback(async(e,o,s)=>{k(""),N(!0),$("");try{let r=0,a=0,c=0;if(typeof e.solarDate=="string"){const A=e.solarDate.match(/^(\d{4})-(\d{2})-(\d{2})$/);A&&(r=Number(A[1]),a=Number(A[2]),c=Number(A[3]))}else r=h(e.year),a=h(e.month),c=h(e.day);const g={y:r,m:a,d:c,hh:e.hour??0,mm:e.minute??0,gender:e.gender||"unknown",yearStem:e.sajuResult?.year?.stem},u=s||P(e.sajuResult,{birth:g}),d=`- 입력 캘린더=${e.calendar||"N/A"} 생년월일=${e.year||"YYYY"}.${e.month||"MM"}.${e.day||"DD"} ${I(e.hour??0)}:${I(e.minute??0)} 성별=${e.gender||"N/A"} (양력=${e.solarDate||"N/A"}, 윤달=${e.leapMonth||(e.isLeap?"leap":"normal")})
- 4주: 년(${e.sajuResult?.year?.stem||""}${e.sajuResult?.year?.branch||""}) 월(${e.sajuResult?.month?.stem||""}${e.sajuResult?.month?.branch||""}) 일(${e.sajuResult?.day?.stem||""}${e.sajuResult?.day?.branch||""}) 시(${e.sajuResult?.hour?.stem||""}${e.sajuResult?.hour?.branch||""})
- 조회일(KST): ${w}
- MBTI: ${(o?.mbti||e.mbti||"미입력").toUpperCase()}`,l=["당신은 명리·사주 풀이 무당입니다. 평생운을 풀이하고 다음 규칙을 반드시 지킵니다.","한글로 작성해야된다.","사주기둥으로 윤친,신살,용신을 모두 적용해서 해석하고 당사자에게 말하는 말투로 작성하되 이 사람의 사주풀이에 대해서만 이야기해야 된다.","평생운 총평, 과거운 풀이, 미래운 풀이, 직장운 풀이, 사업운 풀이, 재물운 풀이, 삼재운 풀이, 연애운 풀이, 바람끼 풀이, 성욕 풀이로 소제목을 작성해줘.","주어진 데이터에 따른 풀이만 이야기하고 명리용어 및 전문용어설명 금지, 조언금지 JSON에 없는 추정/가정 금지.","todayKST는 조회일·나이 표현 참고용일 뿐, 오늘의 일진/시주는 새로 세우지 않습니다.","**일반적이지 않은 내용을 위주로 작성하고 문단마다 500자 내외로 자세히 서술하세요","해결방법을 제시하지말것, 조언하지말것, 소설쓰지말것, 충고하지말것 사주풀이만 이야기할것"].join(" "),j=["분석용 JSON:","```json",JSON.stringify({birth:{calendar:e.calendar,y:e.year,m:e.month,d:e.day,hh:e.hour??0,mm:e.minute??0,gender:e.gender||"unknown",solarDate:e.solarDate,leapMonth:e.leapMonth||(e.isLeap?"leap":"normal")},pillars:e.sajuResult,meta:u,todayKST:w,mbti:(o?.mbti||e.mbti||"").toUpperCase()},null,2),"```","","※ 추가 소제목/서론/결론/요약 금지. 각 항목은 한 단락으로만 작성."].join(`
`),i=[{role:"system",content:l},{role:"user",content:d+`

`+j}];T({birth:{calendar:e.calendar,y:e.year,m:e.month,d:e.day,hh:e.hour??0,mm:e.minute??0,gender:e.gender||"unknown",solarDate:e.solarDate,leapMonth:e.leapMonth||(e.isLeap?"leap":"normal")},pillars:e.sajuResult,meta:u,todayKST:w,mbti:(o?.mbti||e.mbti||"").toUpperCase()});const y=C(e,o),M=await V({messages:i,cacheKey:y});k(M||""),te(M||"",{signature:y}),Y(u,{signature:y}),p(u)}catch(r){$(`AI 풀이 생성에 실패했습니다.
${r?.message?`오류: ${r.message}`:""}`)}finally{N(!1)}},[C,h,w]),K=n.useRef(!1);n.useEffect(()=>{if(K.current)return;K.current=!0;const e=se()||null,o=ne();if(!o){$("입력 데이터가 없습니다. 먼저 정보를 입력해 주세요.");return}try{const s=F(o);S(s),re(s);const r=C(s,e),a=ae(),c=!!(a?.meta&&a?.metaSignature===r);let g=null;if(c)p(a.meta),g=a.meta;else{let l=0,m=0,j=0;if(typeof s.solarDate=="string"){const M=s.solarDate.match(/^(\d{4})-(\d{2})-(\d{2})$/);M&&(l=Number(M[1]),m=Number(M[2]),j=Number(M[3]))}else l=Number(s.year),m=Number(s.month),j=Number(s.day);const i={y:l,m,d:j,hh:s.hour??0,mm:s.minute??0,gender:s.gender||"unknown",yearStem:s.sajuResult?.year?.stem},y=P(s.sajuResult,{birth:i});p(y),Y(y,{signature:r}),g=y}const u=oe();if(!!(u?.text&&u?.meta?.signature===r)){k(u.text);return}J(s,e,g)}catch{$("명식을 계산하는 중 오류가 발생했습니다.")}},[F,C]);const L=!f&&!b,O=L||v&&!b,z=({data:e})=>{if(!e)return null;const o=e.calendar==="lunar"?"음력":"양력",s=e.year??e.y,r=e.month??e.m,a=e.day??e.d,c=e.hour??e.hh,g=r!=null?String(r).padStart(2,"0"):"MM",u=a!=null?String(a).padStart(2,"0"):"DD",d=e.gender==="male"?"남성":e.gender==="female"?"여성":e.gender||"미입력",l=(e.mbti||"").toUpperCase()||"미입력",m=e.calendar==="lunar"?e.leapMonth==="leap"||e.isLeap?"윤달":"평달":"-",j=(e.solarDate||"").replace(/-/g,"."),i=e.calendar==="lunar"&&j;return t.jsxs("div",{className:"info-box info-soft","aria-label":"기본정보",style:{marginTop:10},children:[t.jsx("strong",{style:{display:"block",marginBottom:6},children:"📋 계산 기준 정보(입력·변환 요약)"}),t.jsxs("ul",{style:{listStyle:"none",padding:0,margin:0},children:[t.jsxs("li",{children:["달력: ",t.jsx("strong",{children:o})]}),t.jsxs("li",{children:["생년월일: ",t.jsxs("strong",{children:[s,".",g,".",u,c!=null?` ${String(c).padStart(2,"0")}시`:""]})]}),i&&t.jsxs("li",{children:["양력변환: ",t.jsxs("strong",{children:[j,c!=null?` ${String(c).padStart(2,"0")}시`:""]})]}),e.calendar==="lunar"&&t.jsxs("li",{children:["윤달 여부: ",t.jsx("strong",{children:m})]}),t.jsxs("li",{children:["성별: ",t.jsx("strong",{children:d})]}),t.jsxs("li",{children:["MBTI: ",t.jsx("strong",{children:l})]}),t.jsxs("li",{children:["조회일(KST): ",t.jsx("strong",{children:w})]})]})]})},U=n.useMemo(()=>typeof x=="string"&&x.trim().length>0,[x]),G=n.useMemo(()=>U&&!v&&!b,[U,v,b]);if(b&&!f)return t.jsx("div",{className:"calculator",children:t.jsx(q,{homeHref:"/"})});const{sajuResult:B}=f||{};return t.jsxs("div",{className:"calculator",children:[t.jsx(X,{show:O,title:L?"사주 정보를 불러오는 중…":"AI 해석을 준비하고 있어요",message:L?"입력값을 검증하고 명식을 계산하는 중입니다.":"한 번 생성되면 같은 입력에서는 동일한 결과가 제공됩니다."}),t.jsxs("div",{className:"card result","aria-busy":O?"true":"false",children:[t.jsx("h2",{children:"사주팔자 결과"}),B?t.jsxs(t.Fragment,{children:[t.jsxs("div",{style:{marginTop:0},children:[t.jsx("h3",{style:{margin:"8px 0 0",fontSize:14,color:"var(--ink-soft)"},children:"출생 사주 기둥"}),t.jsx(W,{pillars:B})]}),t.jsx(z,{data:f}),!v&&t.jsx(Z,{content:x,isLoading:!1,error:b}),G&&t.jsxs("details",{className:"info-box info-soft calc-notes",style:{marginTop:12},children:[t.jsx("summary",{children:"📘 이 결과는 이렇게 계산했어요 (펼치기)"}),t.jsxs("div",{className:"calc-body",children:[t.jsxs("ol",{children:[t.jsxs("li",{children:[t.jsx("strong",{children:"입력 전처리"}),": 음력 선택 시 양력 변환(윤달 반영)."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"연주"}),": 입춘(≈ 2/4) 이전 출생은 전년으로 간주 → 1984년=갑자 기준 10간/12지 모듈러."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"월주"}),": 절기 경계 근사표로 월지 결정, 월간은 ",t.jsx("em",{children:"기두법"}),"(寅 기준 순가산)."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"일주"}),": 기준 갑자일 앵커 + ",t.jsx("em",{children:"중경법"}),"(23:30 이후 익일)."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"시주"}),": 子시 23:30 시작, 2시간 단위 12지 분할, 일간그룹별 시작간 적용."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"절기"}),": 24절기 월/일 근사표로 현재/다음 절기 표기."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"오행·신강"}),": 간·지·장간 가중 합산 + 계절 보정 점수로 판정."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"합·충·형·해·파·원진"}),": 표준 테이블로 성립여부 탐지."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"격국"}),": 월지 오행과 일간의 생극관계로 1차 분류."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"용신"}),": 신강도·계절 기반으로 순환/조후 용신 참조."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"대운"}),": 출생→절입까지 일수로 환산, 10년 주기 전개."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"세운"}),": 1984=갑자 기준으로 연운 산출."]})]}),t.jsx("p",{className:"caption",children:"※ 오늘 날짜(todayKST)는 결과의 표현(조회일·나이) 참고에만 쓰이며, 오늘의 일진/기둥 계산은 포함하지 않습니다."})]}),t.jsx("style",{children:`
                  .calc-notes > summary { cursor: pointer; font-weight: 600; color: var(--ink-strong, #222); list-style: none; }
                  .calc-notes[open] > summary { margin-bottom: 8px; }
                  .calc-body ol { margin: 0; padding-left: 18px; line-height: 1.6; }
                  .calc-body li { margin: 6px 0; }
                  .calc-body em { font-style: normal; color: var(--accent, #7a5af8); }
                  .calc-body .caption { margin-top: 8px; color: var(--ink-soft, #666); font-size: .9rem; }
                `})]}),E&&D?t.jsxs("details",{className:"info-box",style:{marginTop:12},children:[t.jsx("summary",{children:"보낸 데이터 미리보기 (AI 프롬프트용)"}),t.jsx("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-all",marginTop:8},children:JSON.stringify(D,null,2)})]}):null,E&&R?t.jsxs("details",{className:"info-box",style:{marginTop:8},children:[t.jsx("summary",{children:"메타 미리보기 (오행/신강/합충/격국/용신/대운/세운)"}),t.jsx("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-all",marginTop:8},children:JSON.stringify(R,null,2)})]}):null]}):t.jsx("div",{className:"sr-only","aria-live":"polite",children:"사주 정보를 불러오고 있습니다…"})]})]})};function pe(){const[f,S]=n.useState(!1),R=n.useRef(!1),p=n.useRef(!1),x=n.useRef(null);return n.useEffect(()=>{_({title:"사주 결과",description:"입력하신 정보로 사주를 계산해 보여드립니다.",path:"/#/result"})},[]),n.useEffect(()=>{document.body.classList.remove("scroll-lock")},[]),n.useEffect(()=>{const k=()=>{window.pageYOffset>8&&(p.current=!0)},v=()=>{p.current=!0},N=()=>{p.current=!0},b=T=>{["PageDown","End"," ","Spacebar"].includes(T.key)&&(p.current=!0)};window.addEventListener("scroll",k,{passive:!0}),window.addEventListener("wheel",v,{passive:!0}),window.addEventListener("touchstart",N,{passive:!0}),window.addEventListener("keydown",b);const $=x.current;let D;return $&&(D=new IntersectionObserver(T=>{for(const w of T)w.isIntersecting&&w.intersectionRatio>=.99&&p.current&&!R.current&&!le()&&(R.current=!0,ie(),S(!0))},{root:null,threshold:[.99]}),D.observe($)),()=>{window.removeEventListener("scroll",k),window.removeEventListener("wheel",v),window.removeEventListener("touchstart",N),window.removeEventListener("keydown",b),D&&D.disconnect()}},[]),t.jsxs(t.Fragment,{children:[t.jsx(me,{}),t.jsx("div",{ref:x,"aria-hidden":!0,style:{height:1}}),t.jsx(Q,{isOpen:f,onClose:()=>S(!1),pageTitle:"사주 결과",shareText:"결과가 도움이 되셨다면 지인과 공유해 보세요."})]})}export{pe as default};
