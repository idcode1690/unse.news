import{r as o,j as e,I as P}from"./index-BUdIPcLE.js";import{s as K,c as O,P as M,S as A}from"./ShareModal-DOQU3P7s.js";import{F as Y,A as J,c as B}from"./openaiService-DsyqD1R7.js";import{a as F,k as z,m as H,f as q,j as G,g as W}from"./cookieUtils-HqKrucY_.js";function S(t){return String(t).padStart(2,"0")}function Q(){const t=Date.now(),s=new Date(t+9*3600*1e3),r=s.getUTCFullYear(),c=S(s.getUTCMonth()+1),l=S(s.getUTCDate());return`${r}.${c}.${l}`}function V(){const t=Date.now(),s=new Date(t+9*3600*1e3),r=s.getUTCFullYear(),c=S(s.getUTCMonth()+1),l=S(s.getUTCDate());return`${r}-${c}-${l}`}const g=(t,s=void 0)=>{const r=Number(t);return Number.isFinite(r)?r:s};function X(t){if(!t)return null;if(t?.sajuResult?.year&&t?.sajuResult?.month&&t?.sajuResult?.day&&t?.sajuResult?.hour)return t;const s=t.calendar||"solar",r=g(t.year),c=g(t.month),l=g(t.day),j=g(t.hour,0),u=g(t.minute,0),v=t.leapMonth==="leap"||t.isLeap===!0;let a,d,n;if(typeof t.solarDate=="string"){const m=String(t.solarDate).match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);m&&(a=g(m[1]),d=g(m[2]),n=g(m[3]))}if(!a||!d||!n)if(s==="lunar"){const m=q(r,c,l,v),x=m instanceof Date?m:new Date(m);a=x.getFullYear(),d=x.getMonth()+1,n=x.getDate()}else a=r,d=c,n=l;const C=O(a,d,n,j,u);return{...t,calendar:s,solarDate:`${a}-${String(d).padStart(2,"0")}-${String(n).padStart(2,"0")}`,sajuResult:C,year:r,month:c,day:l,hour:j,minute:u}}function Z(){const t=Date.now(),s=new Date(t+9*3600*1e3);return{y:s.getUTCFullYear(),m:s.getUTCMonth()+1,d:s.getUTCDate(),hh:s.getUTCHours(),mm:s.getUTCMinutes()}}function _(t){if(!t)return"NOINPUT";const{calendar:s,year:r,month:c,day:l,hour:j,minute:u,gender:v,leapMonth:a,solarDate:d,mbti:n}=t;return["FORTUNE",s||"solar",`${r||""}-${c||""}-${l||""}`,`${S(j||0)}:${S(u||0)}`,v||"",a||(t.isLeap?"leap":"common"),d||"",(n||"").toUpperCase()].join("|")}const re=()=>{const[t,s]=o.useState(""),[r,c]=o.useState(""),[l,j]=o.useState(!1),[u,v]=o.useState(null),[a,d]=o.useState(null),[n,C]=o.useState(null),[m,x]=o.useState(!1),L=o.useRef(!1),T=o.useRef(!1),R=o.useRef(null),y=o.useMemo(()=>Q(),[]),E=o.useMemo(()=>V(),[]),I=o.useMemo(()=>!!F(),[]);if(o.useEffect(()=>{K({title:`오늘의 운세 ${y}`,description:"오늘의 일진과 길한 시간대, 주의 포인트를 간단 요약으로 확인하세요.",path:"/#/fortune",image:"/og-image.png"})},[y]),o.useEffect(()=>{const f=F();if(!f)return;const i=X(f);C(i||null),v(i?.sajuResult||null)},[]),o.useEffect(()=>{const{y:f,m:i,d:h,hh:D,mm:w}=Z(),p=O(f,i,h,D,w);d(p)},[]),o.useEffect(()=>{if(!n||!u||!a)return;(async()=>{j(!0),c("");try{const i=_(n),h=G();if(h?.text&&h?.meta?.date===y&&h?.meta?.signature===i){s(h.text);return}const w={birth:{calendar:n.calendar,y:n.year,m:n.month,d:n.day,hh:n.hour??0,mm:n.minute??0,gender:n.gender||"unknown",leapMonth:n.leapMonth||(n.isLeap?"leap":"common"),solarDate:n.solarDate||null,mbti:(n.mbti||"").toUpperCase()},birthPillars:u,today:{dateKST:E,pillars:a,timeBase:"KST now"}},p="당신은 명리학자이며 오늘의 운세 해설가입니다. 오직 제공된 JSON의 출생 사주 기둥(birthPillars)과 오늘의 사주 기둥(today.pillars)을 근거로, 오늘의 사주를 풀어주세요전문용어 사용금지, 조언금지추정/가정 금지, JSON 외의 간지/절기/점수 생성 금지. 제시된 항목 외 서론/결론 문단을 덧붙이지 마세요.",b=["분석 JSON:","```json",JSON.stringify(w,null,2),"```","","요구사항:","- 반드시 출생 사주 기둥과 오늘의 사주 기둥의 상호작용(오행/십성/합충 등)으로 해석하세요.","- 소제목 7개(총평, 금전, 관계, 업무, 건강·컨디션, 시간대·팁, 주의 포인트).","- 각 항목 500자 이상. 같은 말 반복/상투적 표현 금지.","- 확률/점수 제시 금지, 구체적 행동 팁 포함."].join(`
`),N=await B({messages:[{role:"system",content:p},{role:"user",content:b}],cacheKey:`TODAY|${E}|${i}`}),k=String(N||"").trim();s(k),W(k,{date:y,signature:i})}catch(i){c(`오늘의 운세 생성에 실패했습니다.
${i?.message??""}`)}finally{j(!1)}})()},[n,u,a,y,E]),o.useEffect(()=>{const f=()=>{window.pageYOffset>8&&(T.current=!0)},i=()=>{T.current=!0},h=()=>{T.current=!0},D=b=>{["PageDown","End"," ","Spacebar"].includes(b.key)&&(T.current=!0)};window.addEventListener("scroll",f,{passive:!0}),window.addEventListener("wheel",i,{passive:!0}),window.addEventListener("touchstart",h,{passive:!0}),window.addEventListener("keydown",D);const w=R.current;let p;return w&&(p=new IntersectionObserver(b=>{for(const N of b)N.isIntersecting&&N.intersectionRatio>=.99&&T.current&&!L.current&&!z()&&(L.current=!0,H(),x(!0))},{root:null,threshold:[.99]}),p.observe(w)),()=>{window.removeEventListener("scroll",f),window.removeEventListener("wheel",i),window.removeEventListener("touchstart",h),window.removeEventListener("keydown",D),p&&p.disconnect()}},[]),!I)return e.jsx("div",{className:"calculator",children:e.jsx(P,{homeHref:"/"})});const $=(!u||!a)&&!r,U=$||l&&!r;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"calculator",children:[e.jsx(Y,{show:U,title:$?"오늘의 정보를 준비 중…":"AI 해석을 준비하고 있어요",message:$?"출생 사주와 오늘의 일진을 계산하고 있습니다.":"곧 결과가 표시됩니다."}),e.jsxs("div",{className:"card result","aria-busy":U?"true":"false",children:[e.jsx("h2",{style:{textAlign:"left"},children:"오늘의 운세"}),u&&e.jsxs("div",{children:[e.jsx("h3",{style:{margin:"8px 0 0",fontSize:14,color:"var(--ink-soft)"},children:"출생 사주 기둥"}),e.jsx(M,{pillars:u})]}),a&&e.jsxs("div",{style:{marginTop:4},children:[e.jsx("h3",{style:{margin:"8px 0 0",fontSize:14,color:"var(--ink-soft)"},children:"오늘의 사주 기둥 (KST 현재 시각 기준)"}),e.jsx(M,{pillars:a})]}),e.jsxs("div",{className:"info-box",style:{marginTop:4},children:[e.jsx("div",{className:"season-title",style:{marginBottom:4},children:"오늘"}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"info-label",children:"KST 기준"}),e.jsx("span",{className:"info-value",children:y})]}),e.jsx("div",{className:"info-sub",children:"※ 날짜/시각이 바뀌면 ‘오늘의 사주 기둥’도 달라질 수 있어요."})]}),!l&&e.jsx(J,{content:t,isLoading:!1,error:r}),!l&&!r&&t&&e.jsxs("details",{className:"info-box info-soft calc-notes",style:{marginTop:12},children:[e.jsx("summary",{children:"오늘의 운세는 이렇게 계산했어요 (펼치기)"}),e.jsxs("div",{className:"calc-body",children:[e.jsxs("ol",{children:[e.jsxs("li",{children:[e.jsx("strong",{children:"일간(일주)의 중심성"}),": 출생 일주의 ",e.jsx("em",{children:"일간"}),"과 오늘의 흐름(생·극·설·쟁)을 교차 점검합니다."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"계절 기운과 신강·신약"}),": 월지·절기와 평소 ",e.jsx("em",{children:"신강/신약"})," 성향, 오늘의 조후 보정 여부를 함께 봅니다."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"용신·기신의 작동"}),": 출생 균형을 세우는 ",e.jsx("em",{children:"용신/기신"})," 기준으로 오늘의 천간·지지를 평가합니다."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"십성의 초점"}),": 오늘 천간이 일간과 맺는 ",e.jsx("em",{children:"십성"})," 관계에 따라 금전/관계/업무의 초점을 정합니다."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"합·충·형·해·파·원진"}),": 오늘 지지와 출생 지지의 상호작용으로 변동성·협력 가능성을 판단합니다."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"대운·세운 톤 매칭"}),": 큰 흐름과 오늘의 톤이 맞을수록 작은 일도 성과가 납니다."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"실천 가이드"}),": 합의 날엔 협상/발표, 충의 날엔 일정 완충·언어 완급을 권장합니다."]})]}),e.jsx("p",{className:"caption",children:"※ 본 해석은 길흉을 단정하지 않으며, 합리적 선택을 돕는 참고 안내입니다."})]})]}),r&&!l&&!t&&e.jsx("div",{className:"helper",style:{marginTop:12,whiteSpace:"pre-wrap"},children:r})]})]}),e.jsx("div",{ref:R,"aria-hidden":!0,style:{height:1}}),e.jsx(A,{isOpen:m,onClose:()=>x(!1),pageTitle:"오늘의 운세",shareText:"오늘의 운세가 도움이 되셨다면 지인과 공유해 보세요."})]})};export{re as default};
