import{r,j as t,I as he}from"./index-CYkD4_p8.js";import{l as je,c as ge,a as se,P as ye,s as pe}from"./sajuExtras-DXHqYHgX.js";import{c as de,F as xe,A as fe}from"./openaiService-xGPmheR-.js";import{e as be,f as ne,l as Se,a as we,b as $e,g as Re,h as De,i as Ne,j as ve}from"./cookieUtils-5_XOccd2.js";import{S as ke}from"./ShareModal-wZP8rqsk.js";function L(l){return String(l).padStart(2,"0")}function E(l){if(l===""||l===null||l===void 0)return null;const c=Number(l);return Number.isFinite(c)&&c>=0&&c<=23?c:null}function Te({year:l,month:c,day:b,hour:g}){const x=l?String(l):"YYYY",R=c?L(c):"MM",S=b?L(b):"DD",k=E(g);return k===null?`${x}.${R}.${S} 모름`:`${x}.${R}.${S} ${L(k)}시`}function Ce(){const l=Date.now(),c=new Date(l+9*3600*1e3),b=c.getUTCFullYear(),g=L(c.getUTCMonth()+1),x=L(c.getUTCDate());return`${b}.${g}.${x}`}const Me=()=>{const[l,c]=r.useState(null),[b,g]=r.useState(null),[x,R]=r.useState(""),[S,k]=r.useState(!1),[D,A]=r.useState(""),[F,O]=r.useState(null),T=r.useMemo(()=>Ce(),[]),q=r.useMemo(()=>{try{if(new URLSearchParams(window.location.search).get("debug")==="1"||localStorage.getItem("SAJU_DEBUG")==="1")return!0}catch{}return!1},[]),u=r.useCallback((e,n=void 0)=>{const m=Number(e);return Number.isFinite(m)?m:n},[]),W=r.useCallback(e=>{var N,I,v,$;if((N=e==null?void 0:e.sajuResult)!=null&&N.year&&((I=e==null?void 0:e.sajuResult)!=null&&I.month)&&((v=e==null?void 0:e.sajuResult)!=null&&v.day)&&(($=e==null?void 0:e.sajuResult)!=null&&$.hour))return e;const n=e.calendar||"solar",m=u(e.year),y=u(e.month),p=u(e.day),s=e.hour!==void 0?e.hour:"",d=e.minute!==void 0?e.minute:"",a=E(s)??12,w=u(d,0),h=e.leapMonth==="leap"||e.isLeap===!0;let o,j,i;if(typeof e.solarDate=="string"){const f=String(e.solarDate).match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);f&&(o=u(f[1]),j=u(f[2]),i=u(f[3]))}if(!o||!j||!i)if(n==="lunar"){const f=je(m,y,p,h),K=f instanceof Date?f:new Date(f);o=K.getFullYear(),j=K.getMonth()+1,i=K.getDate()}else o=m,j=y,i=p;const C=ge(o,j,i,a,w);return{...e,calendar:n,solarDate:`${o}-${String(j).padStart(2,"0")}-${String(i).padStart(2,"0")}`,sajuResult:C,year:m,month:y,day:p,hour:s,minute:d}},[u]),U=r.useCallback((e,n)=>{const{calendar:m,year:y,month:p,day:s,hour:d,minute:a,gender:w,leapMonth:h,solarDate:o,mbti:j}=e||{},i=((n==null?void 0:n.mbti)||j||"").toUpperCase();return["SAJU",m,`${y}-${p}-${s}`,`${d??""}:${a??""}`,w,h,o||"",i].join("|")},[]),re=r.useCallback(async(e,n,m)=>{var y,p,s,d,a,w,h,o,j,i,C,N,I,v,$,f,K,Z;R(""),k(!0),A("");try{let M=0,J=0,z=0;if(typeof e.solarDate=="string"){const B=e.solarDate.match(/^(\d{4})-(\d{2})-(\d{2})$/);B&&(M=Number(B[1]),J=Number(B[2]),z=Number(B[3]))}else M=u(e.year),J=u(e.month),z=u(e.day);const ee=E(e.hour),H=E(e.hour)??12,ae={y:M,m:J,d:z,hh:H,mm:u(e.minute,0)??0,gender:e.gender||"unknown",yearStem:(p=(y=e.sajuResult)==null?void 0:y.year)==null?void 0:p.stem},Y=m||se(e.sajuResult,{birth:ae}),ie=`- 입력 캘린더=${e.calendar||"N/A"} 생년월일=${e.year||"YYYY"}.${e.month||"MM"}.${e.day||"DD"} ${ee===null?"모름":L(ee)}:${L(u(e.minute,0)??0)} 성별=${e.gender||"N/A"} (양력=${e.solarDate||"N/A"}, 윤달=${e.leapMonth||(e.isLeap?"leap":"normal")})
- 4주: 년(${((d=(s=e.sajuResult)==null?void 0:s.year)==null?void 0:d.stem)||""}${((w=(a=e.sajuResult)==null?void 0:a.year)==null?void 0:w.branch)||""}) 월(${((o=(h=e.sajuResult)==null?void 0:h.month)==null?void 0:o.stem)||""}${((i=(j=e.sajuResult)==null?void 0:j.month)==null?void 0:i.branch)||""}) 일(${((N=(C=e.sajuResult)==null?void 0:C.day)==null?void 0:N.stem)||""}${((v=(I=e.sajuResult)==null?void 0:I.day)==null?void 0:v.branch)||""}) 시(${((f=($=e.sajuResult)==null?void 0:$.hour)==null?void 0:f.stem)||""}${((Z=(K=e.sajuResult)==null?void 0:K.hour)==null?void 0:Z.branch)||""})
- 조회일(KST): ${T}
- MBTI: ${((n==null?void 0:n.mbti)||e.mbti||"미입력").toUpperCase()}`,ce=["당신은 명리·사주 풀이 무당입니다. 평생운을 풀이하고 다음 규칙을 반드시 지킵니다.","모르거나 부정확한 풀이는 허위로 작성하지 말고 완전히 작성하지 마세요","이 사람의 사주풀이에 대해서만 이야기하고 당사자에게 말하는 말투로 작성해줘.","한글로 작성해야된다.","사주기둥으로 윤친,신살,용신을 모두 해석할 것","소제목은 항상 h3(###) 형식으로 작성하고, 추가 소제목/서론/결론/요약 금지","평생운 총평, 과거운 풀이, 미래운 풀이, 자식운 풀이(자식이 언제쯤 생길지 이야기해줘), 직장운 풀이, 사업운 풀이, 건강운 풀이, 재물운 풀이, 삼재운 풀이, 연애운 풀이, 바람끼 풀이, 성욕 풀이(변태 성욕이 있는지 풀이해줘)로 소제목을 작성해줘.","각 항목별 500자 정도 작성할것","주어진 데이터에 따른 풀이만 이야기하고 명리용어 및 전문용어설명 금지, 조언금지 JSON에 없는 추정/가정 금지.","todayKST는 조회일·나이 표현 참고용일 뿐, 오늘의 일진/시주는 새로 세우지 않습니다.","**일반적이지 않은 내용을 위주로 작성하고 항목마다 500자 내외로 자세히 서술하세요","해결방법을 제시하지말것, 조언하지말것, 소설쓰지말것, 충고하지말것 사주풀이만 이야기할것"].join(" "),ue=["분석용 JSON:","```json",JSON.stringify({birth:{calendar:e.calendar,y:e.year,m:e.month,d:e.day,hh:H,mm:u(e.minute,0)??0,gender:e.gender||"unknown",solarDate:e.solarDate,leapMonth:e.leapMonth||(e.isLeap?"leap":"normal")},pillars:e.sajuResult,meta:Y,todayKST:T,mbti:((n==null?void 0:n.mbti)||e.mbti||"").toUpperCase()},null,2),"```","","※ 추가 소제목/서론/결론/요약 금지. 각 항목은 한 단락으로만 작성."].join(`
`),me=[{role:"system",content:ce},{role:"user",content:ie+`

`+ue}];O({birth:{calendar:e.calendar,y:e.year,m:e.month,d:e.day,hh:H,mm:u(e.minute,0)??0,gender:e.gender||"unknown",solarDate:e.solarDate,leapMonth:e.leapMonth||(e.isLeap?"leap":"normal")},pillars:e.sajuResult,meta:Y,todayKST:T,mbti:((n==null?void 0:n.mbti)||e.mbti||"").toUpperCase()});const G=U(e,n),te=await de({messages:me,cacheKey:G});R(te||""),be(te||"",{signature:G}),ne(Y,{signature:G}),g(Y)}catch(M){A(`AI 풀이 생성에 실패했습니다.
${M!=null&&M.message?`오류: ${M.message}`:""}`)}finally{k(!1)}},[U,u,T]),_=r.useRef(!1);r.useEffect(()=>{var m,y,p;if(_.current)return;_.current=!0;const e=Se()||null,n=we();if(!n){A("입력 데이터가 없습니다. 먼저 정보를 입력해 주세요.");return}try{const s=W(n);c(s),$e(s);const d=U(s,e),a=Re(),w=!!(a!=null&&a.meta&&(a==null?void 0:a.metaSignature)===d);let h=null;if(w)g(a.meta),h=a.meta;else{let i=0,C=0,N=0;if(typeof s.solarDate=="string"){const $=s.solarDate.match(/^(\d{4})-(\d{2})-(\d{2})$/);$&&(i=Number($[1]),C=Number($[2]),N=Number($[3]))}else i=Number(s.year),C=Number(s.month),N=Number(s.day);const I={y:i,m:C,d:N,hh:E(s.hour)??12,mm:Number(s.minute??0),gender:s.gender||"unknown",yearStem:(y=(m=s.sajuResult)==null?void 0:m.year)==null?void 0:y.stem},v=se(s.sajuResult,{birth:I});g(v),ne(v,{signature:d}),h=v}const o=De();if(!!(o!=null&&o.text&&((p=o==null?void 0:o.meta)==null?void 0:p.signature)===d)){R(o.text);return}re(s,e,h)}catch{A("명식을 계산하는 중 오류가 발생했습니다.")}},[W,U]);const P=!l&&!D,Q=P||S&&!D,oe=({data:e})=>{if(!e)return null;const n=e.calendar==="lunar"?"음력":"양력",m=e.year??e.y,y=e.month??e.m,p=e.day??e.d,s=e.hour??e.hh,d=e.gender==="male"?"남성":e.gender==="female"?"여성":e.gender||"미입력",a=(e.mbti||"").toUpperCase()||"미입력",w=e.calendar==="lunar"?e.leapMonth==="leap"||e.isLeap?"윤달":"평달":"-",h=(e.solarDate||"").replace(/-/g,"."),o=e.calendar==="lunar"&&h,j=Te({year:m,month:y,day:p,hour:s}),i=o?E(s)===null?`${h} 모름`:`${h} ${L(E(s))}시`:"";return t.jsxs("div",{className:"info-box info-soft","aria-label":"기본정보",style:{marginTop:10},children:[t.jsx("strong",{style:{display:"block",marginBottom:6},children:"📋 계산 기준 정보(입력·변환 요약)"}),t.jsxs("ul",{style:{listStyle:"none",padding:0,margin:0},children:[t.jsxs("li",{children:["달력: ",t.jsx("strong",{children:n})]}),t.jsxs("li",{children:["생년월일: ",t.jsx("strong",{children:j})]}),o&&t.jsxs("li",{children:["양력변환: ",t.jsx("strong",{children:i})]}),e.calendar==="lunar"&&t.jsxs("li",{children:["윤달 여부: ",t.jsx("strong",{children:w})]}),t.jsxs("li",{children:["성별: ",t.jsx("strong",{children:d})]}),t.jsxs("li",{children:["MBTI: ",t.jsx("strong",{children:a})]}),t.jsxs("li",{children:["조회일(KST): ",t.jsx("strong",{children:T})]})]})]})},V=r.useMemo(()=>typeof x=="string"&&x.trim().length>0,[x]),le=r.useMemo(()=>V&&!S&&!D,[V,S,D]);if(D&&!l)return t.jsx("div",{className:"calculator",children:t.jsx(he,{homeHref:"/"})});const{sajuResult:X}=l||{};return t.jsxs("div",{className:"calculator",children:[t.jsx(xe,{show:Q,title:P?"사주 정보를 불러오는 중…":"AI 해석을 준비하고 있어요",message:P?"입력값을 검증하고 명식을 계산하는 중입니다.":"한 번 생성되면 같은 입력에서는 동일한 결과가 제공됩니다."}),t.jsxs("div",{className:"card result","aria-busy":Q?"true":"false",children:[t.jsx("h2",{children:"사주팔자 결과"}),X?t.jsxs(t.Fragment,{children:[t.jsxs("div",{style:{marginTop:0},children:[t.jsx("h3",{style:{margin:"8px 0 0",fontSize:14,color:"var(--ink-soft)"},children:"출생 사주 기둥"}),t.jsx(ye,{pillars:X})]}),t.jsx(oe,{data:l}),!S&&t.jsx(fe,{content:x,isLoading:!1,error:D}),le&&t.jsxs("details",{className:"info-box info-soft calc-notes",style:{marginTop:12},children:[t.jsx("summary",{children:"📘 이 결과는 이렇게 계산했어요 (펼치기)"}),t.jsxs("div",{className:"calc-body",children:[t.jsxs("ol",{children:[t.jsxs("li",{children:[t.jsx("strong",{children:"입력 전처리"}),": 음력 선택 시 양력 변환(윤달 반영)."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"연주"}),": 입춘(≈ 2/4) 이전 출생은 전년으로 간주 → 1984년=갑자 기준 10간/12지 모듈러."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"월주"}),": 절기 경계 근사표로 월지 결정, 월간은 ",t.jsx("em",{children:"기두법"}),"(寅 기준 순가산)."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"일주"}),": 기준 갑자일 앵커 + ",t.jsx("em",{children:"중경법"}),"(23:30 이후 익일)."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"시주"}),": 子시 23:30 시작, 2시간 단위 12지 분할, 일간그룹별 시작간 적용."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"절기"}),": 24절기 월/일 근사표로 현재/다음 절기 표기."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"오행·신강"}),": 간·지·장간 가중 합산 + 계절 보정 점수로 판정."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"합·충·형·해·파·원진"}),": 표준 테이블로 성립여부 탐지."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"격국"}),": 월지 오행과 일간의 생극관계로 1차 분류."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"용신"}),": 신강도·계절 기반으로 순환/조후 용신 참조."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"대운"}),": 출생→절입까지 일수로 환산, 10년 주기 전개."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"세운"}),": 1984=갑자 기준으로 연운 산출."]})]}),t.jsx("p",{className:"caption",children:"※ 오늘 날짜(todayKST)는 결과의 표현(조회일·나이) 참고에만 쓰이며, 오늘의 일진/기둥 계산은 포함하지 않습니다."})]}),t.jsx("style",{children:`
                  .calc-notes > summary { cursor: pointer; font-weight: 600; color: var(--ink-strong, #222); list-style: none; }
                  .calc-notes[open] > summary { margin-bottom: 8px; }
                  .calc-body ol { margin: 0; padding-left: 18px; line-height: 1.6; }
                  .calc-body li { margin: 6px 0; }
                  .calc-body em { font-style: normal; color: var(--accent, #7a5af8); }
                  .calc-body .caption { margin-top: 8px; color: var(--ink-soft, #666); font-size: .9rem; }
                `})]}),q&&F?t.jsxs("details",{className:"info-box",style:{marginTop:12},children:[t.jsx("summary",{children:"보낸 데이터 미리보기 (AI 프롬프트용)"}),t.jsx("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-all",marginTop:8},children:JSON.stringify(F,null,2)})]}):null,q&&b?t.jsxs("details",{className:"info-box",style:{marginTop:8},children:[t.jsx("summary",{children:"메타 미리보기 (오행/신강/합충/격국/용신/대운/세운)"}),t.jsx("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-all",marginTop:8},children:JSON.stringify(b,null,2)})]}):null]}):t.jsx("div",{className:"sr-only","aria-live":"polite",children:"사주 정보를 불러오고 있습니다…"})]})]})};function Ue(){const[l,c]=r.useState(!1),b=r.useRef(!1),g=r.useRef(!1),x=r.useRef(null);return r.useEffect(()=>{pe({title:"사주 결과",description:"입력하신 정보로 사주를 계산해 보여드립니다.",path:"/#/result"})},[]),r.useEffect(()=>{document.body.classList.remove("scroll-lock")},[]),r.useEffect(()=>{const R=()=>{window.pageYOffset>8&&(g.current=!0)},S=()=>{g.current=!0},k=()=>{g.current=!0},D=O=>{["PageDown","End"," ","Spacebar"].includes(O.key)&&(g.current=!0)};window.addEventListener("scroll",R,{passive:!0}),window.addEventListener("wheel",S,{passive:!0}),window.addEventListener("touchstart",k,{passive:!0}),window.addEventListener("keydown",D);const A=x.current;let F;return A&&(F=new IntersectionObserver(O=>{for(const T of O)T.isIntersecting&&T.intersectionRatio>=.99&&g.current&&!b.current&&!Ne()&&(b.current=!0,ve(),c(!0))},{root:null,threshold:[.99]}),F.observe(A)),()=>{window.removeEventListener("scroll",R),window.removeEventListener("wheel",S),window.removeEventListener("touchstart",k),window.removeEventListener("keydown",D),F&&F.disconnect()}},[]),t.jsxs(t.Fragment,{children:[t.jsx(Me,{}),t.jsx("div",{ref:x,"aria-hidden":!0,style:{height:1}}),t.jsx(ke,{isOpen:l,onClose:()=>c(!1),pageTitle:"사주 결과",shareText:"결과가 도움이 되셨다면 지인과 공유해 보세요."})]})}export{Ue as default};
