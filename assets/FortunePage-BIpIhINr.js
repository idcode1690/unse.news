import{r,j as e,I as z}from"./index-B5FvXLuA.js";import{s as H,a as I,c as K,P as O,S as J}from"./ShareModal-DmmgUW_s.js";import{F as q,A as G,c as W}from"./openaiService-hsjoxdMm.js";import{a as P,k as Q,m as V,f as X,j as Z,g as _}from"./cookieUtils-DN7C23S5.js";function b(t){return String(t).padStart(2,"0")}function ee(){const t=Date.now(),s=new Date(t+9*3600*1e3),o=s.getUTCFullYear(),u=b(s.getUTCMonth()+1),l=b(s.getUTCDate());return`${o}.${u}.${l}`}function te(){const t=Date.now(),s=new Date(t+9*3600*1e3),o=s.getUTCFullYear(),u=b(s.getUTCMonth()+1),l=b(s.getUTCDate());return`${o}-${u}-${l}`}const S=(t,s=void 0)=>{const o=Number(t);return Number.isFinite(o)?o:s};function se(t){if(!t)return null;if(t?.sajuResult?.year&&t?.sajuResult?.month&&t?.sajuResult?.day&&t?.sajuResult?.hour)return t;const s=t.calendar||"solar",o=S(t.year),u=S(t.month),l=S(t.day),w=S(t.hour,0),i=S(t.minute,0),T=t.leapMonth==="leap"||t.isLeap===!0;let a,y,m;if(typeof t.solarDate=="string"){const h=String(t.solarDate).match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);h&&(a=S(h[1]),y=S(h[2]),m=S(h[3]))}if(!a||!y||!m)if(s==="lunar"){const h=X(o,u,l,T),D=h instanceof Date?h:new Date(h);a=D.getFullYear(),y=D.getMonth()+1,m=D.getDate()}else a=o,y=u,m=l;const N=K(a,y,m,w,i);return{...t,calendar:s,solarDate:`${a}-${String(y).padStart(2,"0")}-${String(m).padStart(2,"0")}`,sajuResult:N,year:o,month:u,day:l,hour:w,minute:i,isLeap:T}}function ne(){const t=Date.now(),s=new Date(t+9*3600*1e3);return{y:s.getUTCFullYear(),m:s.getUTCMonth()+1,d:s.getUTCDate(),hh:s.getUTCHours(),mm:s.getUTCMinutes()}}function re(t){if(!t)return"NOINPUT";const{calendar:s,year:o,month:u,day:l,hour:w,minute:i,gender:T,leapMonth:a,solarDate:y,mbti:m}=t;return["FORTUNE",s||"solar",`${o||""}-${u||""}-${l||""}`,`${b(w||0)}:${b(i||0)}`,T||"",a||(t.isLeap?"leap":"common"),y||"",(m||"").toUpperCase()].join("|")}const ce=()=>{const[t,s]=r.useState(""),[o,u]=r.useState(""),[l,w]=r.useState(!1),[i,T]=r.useState(null),[a,y]=r.useState(null),[m,N]=r.useState(null),[h,D]=r.useState(null),[c,A]=r.useState(null),[Y,$]=r.useState(!1),k=r.useRef(!1),C=r.useRef(!1),U=r.useRef(null),v=r.useMemo(()=>ee(),[]),R=r.useMemo(()=>te(),[]),B=r.useMemo(()=>!!P(),[]);if(r.useEffect(()=>{H({title:`오늘의 운세 ${v}`,description:"오늘의 일진과 길한 시간대, 주의 포인트를 간단 요약으로 확인하세요.",path:"/#/fortune",image:"/og-image.png"})},[v]),r.useEffect(()=>{const p=P();if(!p)return;const n=se(p);if(A(n||null),T(n?.sajuResult||null),n?.sajuResult){const d=n.year,j=n.month,g=n.day,f={y:d,m:j,d:g,hh:n.hour??0,mm:n.minute??0,gender:n.gender||"unknown",yearStem:n.sajuResult?.year?.stem},x=I(n.sajuResult,{birth:f});N(x)}},[]),r.useEffect(()=>{const{y:p,m:n,d,hh:j,mm:g}=ne(),f=K(p,n,d,j,g);y(f),D(x=>I(f,{birth:{y:p,m:n,d,hh:j,mm:g,yearStem:i?.year?.stem},anchorDayStem:i?.day?.stem}))},[i?.day?.stem]),r.useEffect(()=>{if(!c||!i||!a)return;(async()=>{w(!0),u("");try{const n=re(c),d=Z();if(d?.text&&d?.meta?.date===v&&d?.meta?.signature===n){s(d.text);return}const g={birth:{calendar:c.calendar,y:c.year,m:c.month,d:c.day,hh:c.hour??0,mm:c.minute??0,gender:c.gender||"unknown",leapMonth:c.leapMonth||(c.isLeap?"leap":"common"),solarDate:c.solarDate||null,mbti:(c.mbti||"").toUpperCase()},pillars:{birth:i,today:a},meta:{birth:m,today:h},todayKST:{date:R,display:v,timeBase:"KST now"}},f=["당신은 명리·사주 풀이 무당입니다. 오늘의 운세를 풀이하고 다음 규칙을 반드시 지킵니다.","한글로 작성해야된다.","오늘의 날짜를 기준으로 오늘의 운세 풀이를 작성하고. 사주기둥도 오늘의 기둥을 중심으로 풀이해야한다.","소제목은 h3(###) 형식으로 작성하고, 추가 소제목/서론/결론/요약 금지","사주기둥으로 윤친,신살,용신을 모두 적용해서 해석하고 당사자에게 말하는 말투로 작성하되 이 사람의 오늘의 사주풀이에 대해서만 이야기해야 된다.","새 간지/절기/점수 생성 금지, 외부 추정 금지, 조언금지, 해결책 제시 금지","오늘의 사주운 총평, 오늘의 금전운, 오늘의 직장운, 오늘의 연애운, 오늘의 관계운으로 소제목을 작성해줘.","각 항목은 400~600자, 반복/상투어 금지, 오늘의 “상호작용”을 구체 사례로 설명."].join(" "),x=["분석 JSON:","```json",JSON.stringify(g,null,2),"```","","지침:","- 출생 메타의 용신/기신을 우선 기준으로 오늘의 천간·지지를 평가하세요.","- 오늘 메타의 십성/신살을 출생 일간 기준으로 해석하세요.","- 합·충·형·해·파·원진이 성립하면 해당 영역(금전/관계/업무)에 구체적 영향으로 연결하세요.","- 확률/점수/별점/색상표 금지. 체크리스트/시간대 팁은 구체적으로."].join(`
`),M=await W({messages:[{role:"system",content:f},{role:"user",content:x}],cacheKey:`TODAY|${R}|${n}`}),F=String(M||"").trim();s(F),_(F,{date:v,signature:n})}catch(n){u(`오늘의 운세 생성에 실패했습니다.
${n?.message??""}`)}finally{w(!1)}})()},[c,i,a,m,h,v,R]),r.useEffect(()=>{const p=()=>{window.pageYOffset>8&&(C.current=!0)},n=()=>{C.current=!0},d=()=>{C.current=!0},j=x=>{["PageDown","End"," ","Spacebar"].includes(x.key)&&(C.current=!0)};window.addEventListener("scroll",p,{passive:!0}),window.addEventListener("wheel",n,{passive:!0}),window.addEventListener("touchstart",d,{passive:!0}),window.addEventListener("keydown",j);const g=U.current;let f;return g&&(f=new IntersectionObserver(x=>{for(const M of x)M.isIntersecting&&M.intersectionRatio>=.99&&C.current&&!k.current&&!Q()&&(k.current=!0,V(),$(!0))},{root:null,threshold:[.99]}),f.observe(g)),()=>{window.removeEventListener("scroll",p),window.removeEventListener("wheel",n),window.removeEventListener("touchstart",d),window.removeEventListener("keydown",j),f&&f.disconnect()}},[]),!B)return e.jsx("div",{className:"calculator",children:e.jsx(z,{homeHref:"/"})});const E=(!i||!a)&&!o,L=E||l&&!o;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"calculator",children:[e.jsx(q,{show:L,title:E?"오늘의 정보를 준비 중…":"AI 해석을 준비하고 있어요",message:E?"출생 사주와 오늘의 일진을 계산하고 있습니다.":"곧 결과가 표시됩니다."}),e.jsxs("div",{className:"card result","aria-busy":L?"true":"false",children:[e.jsx("h2",{style:{textAlign:"left"},children:"오늘의 운세"}),i&&e.jsxs("div",{children:[e.jsx("h3",{style:{margin:"8px 0 0",fontSize:14,color:"var(--ink-soft)"},children:"출생 사주 기둥"}),e.jsx(O,{pillars:i})]}),a&&e.jsxs("div",{style:{marginTop:4},children:[e.jsx("h3",{style:{margin:"8px 0 0",fontSize:14,color:"var(--ink-soft)"},children:"오늘의 사주 기둥 (KST 현재 시각 기준)"}),e.jsx(O,{pillars:a})]}),e.jsxs("div",{className:"info-box",style:{marginTop:4},children:[e.jsx("div",{className:"season-title",style:{marginBottom:4},children:"오늘"}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"info-label",children:"KST 기준"}),e.jsx("span",{className:"info-value",children:v})]}),e.jsx("div",{className:"info-sub",children:"※ 날짜/시각이 바뀌면 ‘오늘의 사주 기둥’도 달라질 수 있어요."})]}),!l&&e.jsx(G,{content:t}),!l&&!o&&t&&e.jsxs("details",{className:"info-box info-soft calc-notes",style:{marginTop:12},children:[e.jsx("summary",{children:"오늘의 운세는 이렇게 계산했어요 (펼치기)"}),e.jsxs("div",{className:"calc-body",children:[e.jsxs("ol",{children:[e.jsxs("li",{children:[e.jsx("strong",{children:"일간 중심"}),": 출생 일간과 오늘의 생·극·설·쟁을 교차 점검."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"신강·신약"}),": 출생 신강도/계절, 오늘 조후 보정 여부를 함께 고려."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"용신·기신"}),": 출생 용신/기신 기준으로 오늘 천간·지지를 평가."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"십성 초점"}),": 오늘 천간이 일간과 맺는 십성으로 금전/관계/업무 초점 도출."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"합·충·형·해·파·원진"}),": 출생 지지 ↔ 오늘 지지 상호작용을 영향 영역과 연결."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"대운·세운 톤"}),": 큰 흐름과 오늘 톤의 일치 여부 확인."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"실천 팁"}),": 합의 날엔 협상/발표, 충의 날엔 일정 완충·언어 완급 권장."]})]}),e.jsx("p",{className:"caption",children:"※ 길흉을 단정하지 않으며, 합리적 선택을 돕는 참고 안내입니다."})]})]}),o&&!l&&!t&&e.jsx("div",{className:"helper",style:{marginTop:12,whiteSpace:"pre-wrap"},children:o})]})]}),e.jsx("div",{ref:U,"aria-hidden":!0,style:{height:1}}),e.jsx(J,{isOpen:Y,onClose:()=>$(!1),pageTitle:"오늘의 운세",shareText:"오늘의 운세가 도움이 되셨다면 지인과 공유해 보세요."})]})};export{ce as default};
