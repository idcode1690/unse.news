import{r as o,j as s,I as _}from"./index-Ba2vumV5.js";import{a as I,B as R}from"./index-DCrhh5Dy.js";import{F as P,A as z,c as L}from"./openaiService-CUavVJ8k.js";import{s as J,P as K,a as Q,l as q,c as U}from"./seo-DrLYezSk.js";const Y=["자","축","인","묘","진","사","오","미","신","유","술","해"],w={자:0,축:2,인:4,묘:6,진:8,사:10,오:12,미:14,신:16,유:18,술:20,해:22};function G(t){if(t===""||t==null)return null;const e=Number(t);return Number.isFinite(e)&&e>=0&&e<=23?e:null}function k(t,e){if(e&&Y.includes(e))return w[e];const a=G(t);return a??12}function S(t){return String(t).padStart(2,"0")}function V(){const t=new Date(Date.now()+324e5);return`${t.getUTCFullYear()}.${S(t.getUTCMonth()+1)}.${S(t.getUTCDate())}`}function W(t){if(!t)return null;if(t.sajuResult?.year&&t.sajuResult?.month&&t.sajuResult?.day)return t;if(!t.year||!t.month||!t.day)return null;const e=t.calendar||"solar",a=Number(t.year),r=Number(t.month),u=Number(t.day),c=t.leapMonth==="leap"||t.isLeap===!0,g=k(t.hour,t.hourBranch),x=Number(t.minute||0);let l=a,d=r,i=u;if(e==="lunar"){const y=q(a,r,u,c),m=y instanceof Date?y:new Date(y);l=m.getFullYear(),d=m.getMonth()+1,i=m.getDate()}const j=U(l,d,i,g,x);return{...t,calendar:e,solarDate:`${l}-${S(d)}-${S(i)}`,sajuResult:j}}function se(){o.useEffect(()=>{J({title:"질문 풀이",description:"운세뉴스에 궁금한 점을 보내면 사주 관점에서 해석해 드립니다.",path:"/#/ask",image:"/og-image.png"})},[]);const t=I()||null,e=o.useMemo(()=>W(t),[t]),a=!!(e?.sajuResult?.year&&e?.sajuResult?.month&&e?.sajuResult?.day);if(!e)return s.jsx("div",{className:"calculator",children:s.jsx(_,{homeHref:"/"})});const[r,u]=o.useState(""),[c,g]=o.useState(!1),[x,l]=o.useState(""),[d,i]=o.useState(""),j=o.useRef(null),y=o.useCallback(()=>{const n=["QNA",r.trim()];return a?n.push(e.calendar,`${e.year}-${e.month}-${e.day}`,`${e.hour??""}:${e.minute??""}:${e.hourBranch??""}`,e.gender??""):n.push("NO_SAJU"),n.join("|")},[r,a,e]),m=o.useCallback(()=>{const n=j.current;if(n)try{n.scrollIntoView({behavior:"smooth",block:"start"})}catch{const f=n.getBoundingClientRect(),h=(window.pageYOffset||document.documentElement.scrollTop||0)+f.top-12;window.scrollTo(0,h)}},[]),A=async n=>{n?.preventDefault?.(),i(""),l("");const f=r.trim();if(!f){i("질문을 먼저 입력해 주세요.");return}const h=y();try{const p=JSON.parse(localStorage.getItem("ASK_QNA_CACHE")||"{}");if(p[h]){l(p[h]),setTimeout(m,30);return}}catch{}g(!0);try{const p=["당신은 '운세 뉴스'의 Q&A 편집자이자 명리(사주) 풀이가 가능한 도우미입니다.","사용자가 보낸 질문을 한국어로 풀어주되, 과장/단정/공포 조장은 피하고 차분한 톤을 유지하세요.","사주 정보가 제공되면 그 범위 내에서만 해석하고, 없으면 일반적 관점에서 해석하세요.","형식: 소제목은 항상 h3(###)로, 불릿 대신 짧은 단락 위주로 서술.","점수/별점/색상 표기는 금지. 개인정보나 생년월일은 본문에 재기술하지 마세요."].join(" "),N=[`- 질문 원문: """${f}"""`,`- 조회일(KST): ${V()}`],v={question:f};if(a){const b=k(e.hour,e.hourBranch),B={y:Number(e.year),m:Number(e.month),d:Number(e.day),hh:b,mm:Number(e.minute||0),gender:e.gender||"unknown",yearStem:e.sajuResult?.year?.stem},M=Q(e.sajuResult,{birth:B,mode:"qna"});v.me={input:{calendar:e.calendar,year:e.year,month:e.month,day:e.day,hour:e.hour??"",minute:e.minute??"",hourBranch:e.hourBranch||"",gender:e.gender||"unknown",leapMonth:e.leapMonth||(e.isLeap?"leap":"common"),solarDate:e.solarDate||""},pillars:e.sajuResult,meta:M},N.push("- 사주 정보: 제공됨(쿠키의 사주 기둥 + 메타)")}else N.push("- 사주 정보: 제공되지 않음");const $=p,D=["질문/컨텍스트:",...N,"","요청:","1) ### 질문 요약 — 사용자의 질문을 한두 문장으로 요약.","2) ### 핵심 풀이 — 질문에 대한 직답. 사실/관찰/경향 위주로 간결히.","3) ### 사주 관점(가능할 때만) — 제공된 4주/메타 안에서만 근거 제시. 없으면 일반 관점이라고 명시.","4) ### 참고 — 단정적 예언/재정·의료 조언은 피하고, 해석의 한계를 짧게 언급.","","※ 점괘식 표현/별점/색상/점수 금지. JSON 외 간지/표를 새로 만들지 마세요."].join(`
`),O="```json\n"+JSON.stringify(v,null,2)+"\n```",E=[{role:"system",content:$},{role:"user",content:D+`

데이터:
`+O}],H=await L({messages:E,cacheKey:h}),C=String(H||"").trim();l(C);try{const b=JSON.parse(localStorage.getItem("ASK_QNA_CACHE")||"{}");b[h]=C,localStorage.setItem("ASK_QNA_CACHE",JSON.stringify(b))}catch{}setTimeout(m,30)}catch(p){i(p?.message||"풀이 요청 중 오류가 발생했습니다.")}finally{g(!1)}},T=()=>{u(""),l(""),i("")},F=["지금 회사에서 이직을 준비하는 게 맞을까요?","올해 내 재물운 흐름이 어떤가요?","새로 만난 사람과 잘 맞는지 궁금합니다.","최근 컨디션이 안 좋은데 조심할 때가 있을까요?"];return s.jsxs("div",{className:"calculator","aria-label":"질문 풀이",children:[s.jsx(P,{show:c,title:"질문 풀이를 준비하고 있어요",message:"질문을 분석하고(필요시) 사주 정보를 반영하는 중입니다."}),s.jsxs("div",{className:"card result","aria-busy":c?"true":"false",children:[s.jsx("h2",{children:"질문 풀이"}),a&&s.jsxs("div",{style:{marginTop:0},children:[s.jsx("h3",{style:{margin:"8px 0 0",fontSize:14,color:"var(--ink-soft)"},children:"출생 사주 기둥"}),s.jsx(K,{pillars:e.sajuResult,idPrefix:"ask"})]}),s.jsxs("form",{onSubmit:A,style:{display:"grid",gap:12,marginTop:12},children:[s.jsxs("div",{children:[s.jsx("label",{htmlFor:"q-body",className:"label",children:"질문"}),s.jsx("textarea",{id:"q-body",value:r,onChange:n=>u(n.target.value),placeholder:"예) 올해 이직 타이밍이 궁금해요. 현재 직무는 데이터 분석이고, 스타트업 제안을 받았습니다.",rows:6,style:{width:"100%",resize:"vertical",borderRadius:12,padding:"12px 14px",border:"1px solid var(--border)",background:"var(--surface)",lineHeight:1.6}}),s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:6},children:[s.jsx("div",{className:"muted",style:{fontSize:12},children:"구체적으로 적을수록 더 도움이 돼요. 개인정보는 적지 마세요."}),s.jsxs("div",{className:"muted",style:{fontSize:12},children:[r.trim().length,"자"]})]})]}),s.jsx("div",{className:"examples","aria-label":"예시 질문",style:{display:"flex",gap:8,flexWrap:"wrap"},children:F.map(n=>s.jsx("button",{type:"button",onClick:()=>u(n),className:"chip",style:{borderRadius:999,padding:"6px 10px",border:"1px solid var(--border)",background:"var(--surface)",fontSize:12,cursor:"pointer"},children:n},n))}),s.jsxs("div",{className:"actions",style:{display:"flex",gap:10,marginTop:2},children:[s.jsx(R,{type:"button",variant:"text",onClick:T,children:"초기화"}),s.jsx(R,{type:"submit",disabled:c||!r.trim(),children:c?"풀이 중…":"풀이 받기"})]})]}),s.jsxs("section",{ref:j,style:{marginTop:16},children:[d?s.jsx("div",{className:"info-box",role:"alert",style:{color:"var(--danger, #b91c1c)"},children:d}):null,!c&&x&&s.jsxs(s.Fragment,{children:[s.jsx("h3",{className:"h4",style:{margin:"0 0 8px"},children:"풀이"}),s.jsx(z,{content:x,isLoading:!1,error:""})]})]})]}),s.jsx("style",{children:`
        .label{ display:block; font-weight:700; margin-bottom:6px; }
        .muted{ color: var(--ink-soft, #6b7280); }
        .chip:focus-visible{ outline:2px solid #94a3b8; outline-offset:2px; }
      `})]})}export{se as default};
