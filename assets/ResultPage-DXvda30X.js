import{r,j as t,I as de}from"./index-CNdVkFF5.js";import{l as xe,c as fe,a as ae,P as be,s as Se}from"./sajuExtras-LbL1oaer.js";import{c as we,F as $e,A as Re}from"./openaiService-CEHq7sOl.js";import{e as De,f as ie,l as Ne,a as ve,b as ke,g as Te,h as Ce,i as Me,j as Le}from"./cookieUtils-fixozt5I.js";import{S as Ae}from"./ShareModal-DxElo6DM.js";function A(a){return String(a).padStart(2,"0")}function K(a){if(a===""||a===null||a===void 0)return null;const c=Number(a);return Number.isFinite(c)&&c>=0&&c<=23?c:null}function Fe({year:a,month:c,day:R,hour:p}){const f=a?String(a):"YYYY",N=c?A(c):"MM",D=R?A(R):"DD",T=K(p);return T===null?`${f}.${N}.${D} 모름`:`${f}.${N}.${D} ${A(T)}시`}function Ie(){const a=Date.now(),c=new Date(a+9*3600*1e3),R=c.getUTCFullYear(),p=A(c.getUTCMonth()+1),f=A(c.getUTCDate());return`${R}.${p}.${f}`}const Ee=()=>{const[a,c]=r.useState(null),[R,p]=r.useState(null),[f,N]=r.useState(""),[D,T]=r.useState(!1),[v,F]=r.useState(""),[I,U]=r.useState(null),C=r.useMemo(()=>Ie(),[]),W=r.useMemo(()=>{try{if(new URLSearchParams(window.location.search).get("debug")==="1"||localStorage.getItem("SAJU_DEBUG")==="1")return!0}catch{}return!1},[]),u=r.useCallback((e,n=void 0)=>{const j=Number(e);return Number.isFinite(j)?j:n},[]),_=r.useCallback(e=>{var S,w,$,E,k;if((S=e==null?void 0:e.sajuResult)!=null&&S.year&&((w=e==null?void 0:e.sajuResult)!=null&&w.month)&&(($=e==null?void 0:e.sajuResult)!=null&&$.day)&&((E=e==null?void 0:e.sajuResult)!=null&&E.hour))return e;const n=e.calendar||"solar",j=u(e.year),d=u(e.month),x=u(e.day),g=e.hour!==void 0?e.hour:"",y=e.minute!==void 0?e.minute:"",s=(k=K(g))!=null?k:12,b=u(y,0),l=e.leapMonth==="leap"||e.isLeap===!0;let m,i,o;if(typeof e.solarDate=="string"){const h=String(e.solarDate).match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);h&&(m=u(h[1]),i=u(h[2]),o=u(h[3]))}if(!m||!i||!o)if(n==="lunar"){const h=xe(j,d,x,l),O=h instanceof Date?h:new Date(h);m=O.getFullYear(),i=O.getMonth()+1,o=O.getDate()}else m=j,i=d,o=x;const M=fe(m,i,o,s,b);return{...e,calendar:n,solarDate:`${m}-${String(i).padStart(2,"0")}-${String(o).padStart(2,"0")}`,sajuResult:M,year:j,month:d,day:x,hour:g,minute:y}},[u]),Y=r.useCallback((e,n)=>{const{calendar:j,year:d,month:x,day:g,hour:y,minute:s,gender:b,leapMonth:l,solarDate:m,mbti:i}=e||{},o=((n==null?void 0:n.mbti)||i||"").toUpperCase();return["SAJU",j,`${d}-${x}-${g}`,`${y!=null?y:""}:${s!=null?s:""}`,b,l,m||"",o].join("|")},[]),ce=r.useCallback(async(e,n,j)=>{var d,x,g,y,s,b,l,m,i,o,M,S,w,$,E,k,h,O,ee,te,se,ne,re;N(""),T(!0),F("");try{let L=0,z=0,H=0;if(typeof e.solarDate=="string"){const P=e.solarDate.match(/^(\d{4})-(\d{2})-(\d{2})$/);P&&(L=Number(P[1]),z=Number(P[2]),H=Number(P[3]))}else L=u(e.year),z=u(e.month),H=u(e.day);const oe=K(e.hour),G=(d=K(e.hour))!=null?d:12,he={y:L,m:z,d:H,hh:G,mm:(x=u(e.minute,0))!=null?x:0,gender:e.gender||"unknown",yearStem:(y=(g=e.sajuResult)==null?void 0:g.year)==null?void 0:y.stem},B=j||ae(e.sajuResult,{birth:he}),je=`- 입력 캘린더=${e.calendar||"N/A"} 생년월일=${e.year||"YYYY"}.${e.month||"MM"}.${e.day||"DD"} ${oe===null?"모름":A(oe)}:${A((s=u(e.minute,0))!=null?s:0)} 성별=${e.gender||"N/A"} (양력=${e.solarDate||"N/A"}, 윤달=${e.leapMonth||(e.isLeap?"leap":"normal")})
- 4주: 년(${((l=(b=e.sajuResult)==null?void 0:b.year)==null?void 0:l.stem)||""}${((i=(m=e.sajuResult)==null?void 0:m.year)==null?void 0:i.branch)||""}) 월(${((M=(o=e.sajuResult)==null?void 0:o.month)==null?void 0:M.stem)||""}${((w=(S=e.sajuResult)==null?void 0:S.month)==null?void 0:w.branch)||""}) 일(${((E=($=e.sajuResult)==null?void 0:$.day)==null?void 0:E.stem)||""}${((h=(k=e.sajuResult)==null?void 0:k.day)==null?void 0:h.branch)||""}) 시(${((ee=(O=e.sajuResult)==null?void 0:O.hour)==null?void 0:ee.stem)||""}${((se=(te=e.sajuResult)==null?void 0:te.hour)==null?void 0:se.branch)||""})
- 조회일(KST): ${C}
- MBTI: ${((n==null?void 0:n.mbti)||e.mbti||"미입력").toUpperCase()}`,ge=["당신은 명리·사주 풀이 무당입니다. 평생운을 풀이하고 다음 규칙을 반드시 지킵니다.","모르거나 부정확한 풀이는 허위로 작성하지 말고 완전히 작성하지 마세요","이 사람의 사주풀이에 대해서만 이야기하고 당사자에게 말하는 말투로 작성해줘.","한글로 작성해야된다.","사주기둥으로 윤친,신살,용신을 모두 해석할 것","소제목은 항상 h3(###) 형식으로 작성하고, 추가 소제목/서론/결론/요약 금지","평생운 총평, 과거운 풀이, 미래운 풀이, 자식운 풀이(자식이 언제쯤 생길지 이야기해줘), 직장운 풀이, 사업운 풀이, 건강운 풀이, 재물운 풀이, 삼재운 풀이, 연애운 풀이, 바람끼 풀이, 성욕 풀이(변태 성욕이 있는지 풀이해줘)로 소제목을 작성해줘.","각 항목별 500자 정도 작성할것","주어진 데이터에 따른 풀이만 이야기하고 명리용어 및 전문용어설명 금지, 조언금지 JSON에 없는 추정/가정 금지.","todayKST는 조회일·나이 표현 참고용일 뿐, 오늘의 일진/시주는 새로 세우지 않습니다.","**일반적이지 않은 내용을 위주로 작성하고 항목마다 500자 내외로 자세히 서술하세요","해결방법을 제시하지말것, 조언하지말것, 소설쓰지말것, 충고하지말것 사주풀이만 이야기할것"].join(" "),ye=["분석용 JSON:","```json",JSON.stringify({birth:{calendar:e.calendar,y:e.year,m:e.month,d:e.day,hh:G,mm:(ne=u(e.minute,0))!=null?ne:0,gender:e.gender||"unknown",solarDate:e.solarDate,leapMonth:e.leapMonth||(e.isLeap?"leap":"normal")},pillars:e.sajuResult,meta:B,todayKST:C,mbti:((n==null?void 0:n.mbti)||e.mbti||"").toUpperCase()},null,2),"```","","※ 추가 소제목/서론/결론/요약 금지. 각 항목은 한 단락으로만 작성."].join(`
`),pe=[{role:"system",content:ge},{role:"user",content:je+`

`+ye}];U({birth:{calendar:e.calendar,y:e.year,m:e.month,d:e.day,hh:G,mm:(re=u(e.minute,0))!=null?re:0,gender:e.gender||"unknown",solarDate:e.solarDate,leapMonth:e.leapMonth||(e.isLeap?"leap":"normal")},pillars:e.sajuResult,meta:B,todayKST:C,mbti:((n==null?void 0:n.mbti)||e.mbti||"").toUpperCase()});const q=Y(e,n),le=await we({messages:pe,cacheKey:q});N(le||""),De(le||"",{signature:q}),ie(B,{signature:q}),p(B)}catch(L){F(`AI 풀이 생성에 실패했습니다.
${L!=null&&L.message?`오류: ${L.message}`:""}`)}finally{T(!1)}},[Y,u,C]),Q=r.useRef(!1);r.useEffect(()=>{var j,d,x,g,y;if(Q.current)return;Q.current=!0;const e=Ne()||null,n=ve();if(!n){F("입력 데이터가 없습니다. 먼저 정보를 입력해 주세요.");return}try{const s=_(n);c(s),ke(s);const b=Y(s,e),l=Te(),m=!!(l!=null&&l.meta&&(l==null?void 0:l.metaSignature)===b);let i=null;if(m)p(l.meta),i=l.meta;else{let S=0,w=0,$=0;if(typeof s.solarDate=="string"){const h=s.solarDate.match(/^(\d{4})-(\d{2})-(\d{2})$/);h&&(S=Number(h[1]),w=Number(h[2]),$=Number(h[3]))}else S=Number(s.year),w=Number(s.month),$=Number(s.day);const E={y:S,m:w,d:$,hh:(j=K(s.hour))!=null?j:12,mm:Number((d=s.minute)!=null?d:0),gender:s.gender||"unknown",yearStem:(g=(x=s.sajuResult)==null?void 0:x.year)==null?void 0:g.stem},k=ae(s.sajuResult,{birth:E});p(k),ie(k,{signature:b}),i=k}const o=Ce();if(!!(o!=null&&o.text&&((y=o==null?void 0:o.meta)==null?void 0:y.signature)===b)){N(o.text);return}ce(s,e,i)}catch{F("명식을 계산하는 중 오류가 발생했습니다.")}},[_,Y]);const J=!a&&!v,V=J||D&&!v,ue=({data:e})=>{var M,S,w,$;if(!e)return null;const n=e.calendar==="lunar"?"음력":"양력",j=(M=e.year)!=null?M:e.y,d=(S=e.month)!=null?S:e.m,x=(w=e.day)!=null?w:e.d,g=($=e.hour)!=null?$:e.hh,y=e.gender==="male"?"남성":e.gender==="female"?"여성":e.gender||"미입력",s=(e.mbti||"").toUpperCase()||"미입력",b=e.calendar==="lunar"?e.leapMonth==="leap"||e.isLeap?"윤달":"평달":"-",l=(e.solarDate||"").replace(/-/g,"."),m=e.calendar==="lunar"&&l,i=Fe({year:j,month:d,day:x,hour:g}),o=m?K(g)===null?`${l} 모름`:`${l} ${A(K(g))}시`:"";return t.jsxs("div",{className:"info-box info-soft","aria-label":"기본정보",style:{marginTop:10},children:[t.jsx("strong",{style:{display:"block",marginBottom:6},children:"📋 계산 기준 정보(입력·변환 요약)"}),t.jsxs("ul",{style:{listStyle:"none",padding:0,margin:0},children:[t.jsxs("li",{children:["달력: ",t.jsx("strong",{children:n})]}),t.jsxs("li",{children:["생년월일: ",t.jsx("strong",{children:i})]}),m&&t.jsxs("li",{children:["양력변환: ",t.jsx("strong",{children:o})]}),e.calendar==="lunar"&&t.jsxs("li",{children:["윤달 여부: ",t.jsx("strong",{children:b})]}),t.jsxs("li",{children:["성별: ",t.jsx("strong",{children:y})]}),t.jsxs("li",{children:["MBTI: ",t.jsx("strong",{children:s})]}),t.jsxs("li",{children:["조회일(KST): ",t.jsx("strong",{children:C})]})]})]})},X=r.useMemo(()=>typeof f=="string"&&f.trim().length>0,[f]),me=r.useMemo(()=>X&&!D&&!v,[X,D,v]);if(v&&!a)return t.jsx("div",{className:"calculator",children:t.jsx(de,{homeHref:"/"})});const{sajuResult:Z}=a||{};return t.jsxs("div",{className:"calculator",children:[t.jsx($e,{show:V,title:J?"사주 정보를 불러오는 중…":"AI 해석을 준비하고 있어요",message:J?"입력값을 검증하고 명식을 계산하는 중입니다.":"한 번 생성되면 같은 입력에서는 동일한 결과가 제공됩니다."}),t.jsxs("div",{className:"card result","aria-busy":V?"true":"false",children:[t.jsx("h2",{children:"사주팔자 결과"}),Z?t.jsxs(t.Fragment,{children:[t.jsxs("div",{style:{marginTop:0},children:[t.jsx("h3",{style:{margin:"8px 0 0",fontSize:14,color:"var(--ink-soft)"},children:"출생 사주 기둥"}),t.jsx(be,{pillars:Z})]}),t.jsx(ue,{data:a}),!D&&t.jsx(Re,{content:f,isLoading:!1,error:v}),me&&t.jsxs("details",{className:"info-box info-soft calc-notes",style:{marginTop:12},children:[t.jsx("summary",{children:"📘 이 결과는 이렇게 계산했어요 (펼치기)"}),t.jsxs("div",{className:"calc-body",children:[t.jsxs("ol",{children:[t.jsxs("li",{children:[t.jsx("strong",{children:"입력 전처리"}),": 음력 선택 시 양력 변환(윤달 반영)."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"연주"}),": 입춘(≈ 2/4) 이전 출생은 전년으로 간주 → 1984년=갑자 기준 10간/12지 모듈러."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"월주"}),": 절기 경계 근사표로 월지 결정, 월간은 ",t.jsx("em",{children:"기두법"}),"(寅 기준 순가산)."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"일주"}),": 기준 갑자일 앵커 + ",t.jsx("em",{children:"중경법"}),"(23:30 이후 익일)."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"시주"}),": 子시 23:30 시작, 2시간 단위 12지 분할, 일간그룹별 시작간 적용."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"절기"}),": 24절기 월/일 근사표로 현재/다음 절기 표기."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"오행·신강"}),": 간·지·장간 가중 합산 + 계절 보정 점수로 판정."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"합·충·형·해·파·원진"}),": 표준 테이블로 성립여부 탐지."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"격국"}),": 월지 오행과 일간의 생극관계로 1차 분류."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"용신"}),": 신강도·계절 기반으로 순환/조후 용신 참조."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"대운"}),": 출생→절입까지 일수로 환산, 10년 주기 전개."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"세운"}),": 1984=갑자 기준으로 연운 산출."]})]}),t.jsx("p",{className:"caption",children:"※ 오늘 날짜(todayKST)는 결과의 표현(조회일·나이) 참고에만 쓰이며, 오늘의 일진/기둥 계산은 포함하지 않습니다."})]}),t.jsx("style",{children:`
                  .calc-notes > summary { cursor: pointer; font-weight: 600; color: var(--ink-strong, #222); list-style: none; }
                  .calc-notes[open] > summary { margin-bottom: 8px; }
                  .calc-body ol { margin: 0; padding-left: 18px; line-height: 1.6; }
                  .calc-body li { margin: 6px 0; }
                  .calc-body em { font-style: normal; color: var(--accent, #7a5af8); }
                  .calc-body .caption { margin-top: 8px; color: var(--ink-soft, #666); font-size: .9rem; }
                `})]}),W&&I?t.jsxs("details",{className:"info-box",style:{marginTop:12},children:[t.jsx("summary",{children:"보낸 데이터 미리보기 (AI 프롬프트용)"}),t.jsx("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-all",marginTop:8},children:JSON.stringify(I,null,2)})]}):null,W&&R?t.jsxs("details",{className:"info-box",style:{marginTop:8},children:[t.jsx("summary",{children:"메타 미리보기 (오행/신강/합충/격국/용신/대운/세운)"}),t.jsx("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-all",marginTop:8},children:JSON.stringify(R,null,2)})]}):null]}):t.jsx("div",{className:"sr-only","aria-live":"polite",children:"사주 정보를 불러오고 있습니다…"})]})]})};function ze(){const[a,c]=r.useState(!1),R=r.useRef(!1),p=r.useRef(!1),f=r.useRef(null);return r.useEffect(()=>{Se({title:"사주 결과",description:"입력하신 정보로 사주를 계산해 보여드립니다.",path:"/#/result"})},[]),r.useEffect(()=>{document.body.classList.remove("scroll-lock")},[]),r.useEffect(()=>{const N=()=>{window.pageYOffset>8&&(p.current=!0)},D=()=>{p.current=!0},T=()=>{p.current=!0},v=U=>{["PageDown","End"," ","Spacebar"].includes(U.key)&&(p.current=!0)};window.addEventListener("scroll",N,{passive:!0}),window.addEventListener("wheel",D,{passive:!0}),window.addEventListener("touchstart",T,{passive:!0}),window.addEventListener("keydown",v);const F=f.current;let I;return F&&(I=new IntersectionObserver(U=>{for(const C of U)C.isIntersecting&&C.intersectionRatio>=.99&&p.current&&!R.current&&!Me()&&(R.current=!0,Le(),c(!0))},{root:null,threshold:[.99]}),I.observe(F)),()=>{window.removeEventListener("scroll",N),window.removeEventListener("wheel",D),window.removeEventListener("touchstart",T),window.removeEventListener("keydown",v),I&&I.disconnect()}},[]),t.jsxs(t.Fragment,{children:[t.jsx(Ee,{}),t.jsx("div",{ref:f,"aria-hidden":!0,style:{height:1}}),t.jsx(Ae,{isOpen:a,onClose:()=>c(!1),pageTitle:"사주 결과",shareText:"결과가 도움이 되셨다면 지인과 공유해 보세요."})]})}export{ze as default};
