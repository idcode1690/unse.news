import{r as o,j as t,I as q}from"./index-DZ-eqXIP.js";import{s as G,a as Y,c as z,P,l as W}from"./sajuExtras-DS998SFq.js";import{F as Q,A as V,c as X}from"./openaiService-Bf_ZOIu9.js";import{S as Z}from"./ShareModal-Bz6_RzOD.js";import{a as B,i as _,j as ee,h as te,e as se}from"./cookieUtils-DnZWWZiT.js";function M(e){return String(e).padStart(2,"0")}function ne(){const e=Date.now(),n=new Date(e+9*3600*1e3),a=n.getUTCFullYear(),d=M(n.getUTCMonth()+1),m=M(n.getUTCDate());return`${a}.${d}.${m}`}function re(){const e=Date.now(),n=new Date(e+9*3600*1e3),a=n.getUTCFullYear(),d=M(n.getUTCMonth()+1),m=M(n.getUTCDate());return`${a}-${d}-${m}`}const w=(e,n=void 0)=>{const a=Number(e);return Number.isFinite(a)?a:n};function oe(e){var N,E,i,$;if(!e)return null;if((N=e==null?void 0:e.sajuResult)!=null&&N.year&&((E=e==null?void 0:e.sajuResult)!=null&&E.month)&&((i=e==null?void 0:e.sajuResult)!=null&&i.day)&&(($=e==null?void 0:e.sajuResult)!=null&&$.hour))return e;const n=e.calendar||"solar",a=w(e.year),d=w(e.month),m=w(e.day),v=w(e.hour,0),r=w(e.minute,0),D=e.leapMonth==="leap"||e.isLeap===!0;let u,y,h;if(typeof e.solarDate=="string"){const p=String(e.solarDate).match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);p&&(u=w(p[1]),y=w(p[2]),h=w(p[3]))}if(!u||!y||!h)if(n==="lunar"){const p=W(a,d,m,D),b=p instanceof Date?p:new Date(p);u=b.getFullYear(),y=b.getMonth()+1,h=b.getDate()}else u=a,y=d,h=m;const U=z(u,y,h,v,r);return{...e,calendar:n,solarDate:`${u}-${String(y).padStart(2,"0")}-${String(h).padStart(2,"0")}`,sajuResult:U,year:a,month:d,day:m,hour:v,minute:r,isLeap:D}}function ae(){const e=Date.now(),n=new Date(e+9*3600*1e3);return{y:n.getUTCFullYear(),m:n.getUTCMonth()+1,d:n.getUTCDate(),hh:n.getUTCHours(),mm:n.getUTCMinutes()}}function le(e){if(!e)return"NOINPUT";const{calendar:n,year:a,month:d,day:m,hour:v,minute:r,gender:D,leapMonth:u,solarDate:y,mbti:h}=e;return["FORTUNE",n||"solar",`${a||""}-${d||""}-${m||""}`,`${M(v||0)}:${M(r||0)}`,D||"",u||(e.isLeap?"leap":"common"),y||"",(h||"").toUpperCase()].join("|")}const he=()=>{var K;const[e,n]=o.useState(""),[a,d]=o.useState(""),[m,v]=o.useState(!1),[r,D]=o.useState(null),[u,y]=o.useState(null),[h,U]=o.useState(null),[N,E]=o.useState(null),[i,$]=o.useState(null),[p,b]=o.useState(!1),F=o.useRef(!1),R=o.useRef(!1),I=o.useRef(null),T=o.useMemo(()=>ne(),[]),k=o.useMemo(()=>re(),[]),H=o.useMemo(()=>!!B(),[]);if(o.useEffect(()=>{G({title:`오늘의 운세 ${T}`,description:"오늘의 일진과 길한 시간대, 주의 포인트를 간단 요약으로 확인하세요.",path:"/#/fortune",image:"/og-image.png"})},[T]),o.useEffect(()=>{var f,c;const j=B();if(!j)return;const s=oe(j);if($(s||null),D((s==null?void 0:s.sajuResult)||null),s!=null&&s.sajuResult){const l=s.year,g=s.month,S=s.day,x={y:l,m:g,d:S,hh:s.hour??0,mm:s.minute??0,gender:s.gender||"unknown",yearStem:(c=(f=s.sajuResult)==null?void 0:f.year)==null?void 0:c.stem},C=Y(s.sajuResult,{birth:x});U(C)}},[]),o.useEffect(()=>{const{y:j,m:s,d:f,hh:c,mm:l}=ae(),g=z(j,s,f,c,l);y(g),E(S=>{var x,C;return Y(g,{birth:{y:j,m:s,d:f,hh:c,mm:l,yearStem:(x=r==null?void 0:r.year)==null?void 0:x.stem},anchorDayStem:(C=r==null?void 0:r.day)==null?void 0:C.stem})})},[(K=r==null?void 0:r.day)==null?void 0:K.stem]),o.useEffect(()=>{if(!i||!r||!u)return;(async()=>{var s,f;v(!0),d("");try{const c=le(i),l=te();if(l!=null&&l.text&&((s=l==null?void 0:l.meta)==null?void 0:s.date)===T&&((f=l==null?void 0:l.meta)==null?void 0:f.signature)===c){n(l.text);return}const S={birth:{calendar:i.calendar,y:i.year,m:i.month,d:i.day,hh:i.hour??0,mm:i.minute??0,gender:i.gender||"unknown",leapMonth:i.leapMonth||(i.isLeap?"leap":"common"),solarDate:i.solarDate||null,mbti:(i.mbti||"").toUpperCase()},pillars:{birth:r,today:u},meta:{birth:h,today:N},todayKST:{date:k,display:T,timeBase:"KST now"}},x=["당신은 명리·사주 풀이 무당입니다. 오늘의 운세를 풀이하고 다음 규칙을 반드시 지킵니다.","모르거나 부정확한 풀이는 허위로 작성하지 말고 완전히 작성하지 마세요","한글로 작성해야된다.","오늘의 날짜를 기준으로 오늘의 운세 풀이를 작성하고. 사주기둥도 오늘의 기둥을 중심으로 풀이해야한다.","소제목은 h3(###) 형식으로 작성하고, 추가 소제목/서론/결론/요약 금지","사주기둥으로 윤친,신살,용신을 모두 적용해서 해석하고 당사자에게 말하는 말투로 작성하되 이 사람의 오늘의 사주풀이에 대해서만 이야기해야 된다.","새 간지/절기/점수 생성 금지, 외부 추정 금지, 조언금지, 해결책 제시 금지","오늘의 사주운 총평, 오늘의 금전운, 오늘의 직장운, 오늘의 연애운, 오늘의 관계운으로 소제목을 작성해줘.","각 항목은 400~600자, 반복/상투어 금지, 오늘의 “상호작용”을 구체 사례로 설명."].join(" "),C=["분석 JSON:","```json",JSON.stringify(S,null,2),"```","","지침:","- 출생 메타의 용신/기신을 우선 기준으로 오늘의 천간·지지를 평가하세요.","- 오늘 메타의 십성/신살을 출생 일간 기준으로 해석하세요.","- 합·충·형·해·파·원진이 성립하면 해당 영역(금전/관계/업무)에 구체적 영향으로 연결하세요.","- 확률/점수/별점/색상표 금지. 체크리스트/시간대 팁은 구체적으로."].join(`
`),J=await X({messages:[{role:"system",content:x},{role:"user",content:C}],cacheKey:`TODAY|${k}|${c}`}),A=String(J||"").trim();n(A),se(A,{date:T,signature:c})}catch(c){d(`오늘의 운세 생성에 실패했습니다.
${(c==null?void 0:c.message)??""}`)}finally{v(!1)}})()},[i,r,u,h,N,T,k]),o.useEffect(()=>{const j=()=>{window.pageYOffset>8&&(R.current=!0)},s=()=>{R.current=!0},f=()=>{R.current=!0},c=S=>{["PageDown","End"," ","Spacebar"].includes(S.key)&&(R.current=!0)};window.addEventListener("scroll",j,{passive:!0}),window.addEventListener("wheel",s,{passive:!0}),window.addEventListener("touchstart",f,{passive:!0}),window.addEventListener("keydown",c);const l=I.current;let g;return l&&(g=new IntersectionObserver(S=>{for(const x of S)x.isIntersecting&&x.intersectionRatio>=.99&&R.current&&!F.current&&!_()&&(F.current=!0,ee(),b(!0))},{root:null,threshold:[.99]}),g.observe(l)),()=>{window.removeEventListener("scroll",j),window.removeEventListener("wheel",s),window.removeEventListener("touchstart",f),window.removeEventListener("keydown",c),g&&g.disconnect()}},[]),!H)return t.jsx("div",{className:"calculator",children:t.jsx(q,{homeHref:"/"})});const L=(!r||!u)&&!a,O=L||m&&!a;return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"calculator",children:[t.jsx(Q,{show:O,title:L?"오늘의 정보를 준비 중…":"AI 해석을 준비하고 있어요",message:L?"출생 사주와 오늘의 일진을 계산하고 있습니다.":"곧 결과가 표시됩니다."}),t.jsxs("div",{className:"card result","aria-busy":O?"true":"false",children:[t.jsx("h2",{style:{textAlign:"left"},children:"오늘의 운세"}),r&&t.jsxs("div",{children:[t.jsx("h3",{style:{margin:"8px 0 0",fontSize:14,color:"var(--ink-soft)"},children:"출생 사주 기둥"}),t.jsx(P,{pillars:r})]}),u&&t.jsxs("div",{style:{marginTop:4},children:[t.jsx("h3",{style:{margin:"8px 0 0",fontSize:14,color:"var(--ink-soft)"},children:"오늘의 사주 기둥 (KST 현재 시각 기준)"}),t.jsx(P,{pillars:u})]}),t.jsxs("div",{className:"info-box",style:{marginTop:4},children:[t.jsx("div",{className:"season-title",style:{marginBottom:4},children:"오늘"}),t.jsxs("div",{className:"info-row",children:[t.jsx("span",{className:"info-label",children:"KST 기준"}),t.jsx("span",{className:"info-value",children:T})]}),t.jsx("div",{className:"info-sub",children:"※ 날짜/시각이 바뀌면 ‘오늘의 사주 기둥’도 달라질 수 있어요."})]}),!m&&t.jsx(V,{content:e}),!m&&!a&&e&&t.jsxs("details",{className:"info-box info-soft calc-notes",style:{marginTop:12},children:[t.jsx("summary",{children:"오늘의 운세는 이렇게 계산했어요 (펼치기)"}),t.jsxs("div",{className:"calc-body",children:[t.jsxs("ol",{children:[t.jsxs("li",{children:[t.jsx("strong",{children:"일간 중심"}),": 출생 일간과 오늘의 생·극·설·쟁을 교차 점검."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"신강·신약"}),": 출생 신강도/계절, 오늘 조후 보정 여부를 함께 고려."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"용신·기신"}),": 출생 용신/기신 기준으로 오늘 천간·지지를 평가."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"십성 초점"}),": 오늘 천간이 일간과 맺는 십성으로 금전/관계/업무 초점 도출."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"합·충·형·해·파·원진"}),": 출생 지지 ↔ 오늘 지지 상호작용을 영향 영역과 연결."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"대운·세운 톤"}),": 큰 흐름과 오늘 톤의 일치 여부 확인."]}),t.jsxs("li",{children:[t.jsx("strong",{children:"실천 팁"}),": 합의 날엔 협상/발표, 충의 날엔 일정 완충·언어 완급 권장."]})]}),t.jsx("p",{className:"caption",children:"※ 길흉을 단정하지 않으며, 합리적 선택을 돕는 참고 안내입니다."})]})]}),a&&!m&&!e&&t.jsx("div",{className:"helper",style:{marginTop:12,whiteSpace:"pre-wrap"},children:a})]})]}),t.jsx("div",{ref:I,"aria-hidden":!0,style:{height:1}}),t.jsx(Z,{isOpen:p,onClose:()=>b(!1),pageTitle:"오늘의 운세",shareText:"오늘의 운세가 도움이 되셨다면 지인과 공유해 보세요."})]})};export{he as default};
