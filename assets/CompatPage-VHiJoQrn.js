import{r as o,j as n,I as ke,R as De}from"./index-Cq4ejKLT.js";import{a as _e,D as le,n as K,M as oe,d as ie,k as Fe,m as Be,S as ce,e as M,B as ue,f as Ae,o as $e}from"./cookieUtils-CWdrEs-e.js";import{s as He,P as de,A as Ye,S as Ge,c as Oe,a as me,b as ze}from"./ShareModal-Cn_oAQ-N.js";import{F as Je}from"./FullScreenLoader-Cd3BPG6I.js";const E="compat_locked",P="compat_partner",z="compat_skip_scroll_on_return";function ye(a){try{return localStorage.getItem(a)}catch{return null}}function j(a,i){try{localStorage.setItem(a,i)}catch{}}function he(a){try{localStorage.removeItem(a)}catch{}}function Ke(a){try{return sessionStorage.getItem(a)}catch{return null}}function pe(a,i){try{sessionStorage.setItem(a,i)}catch{}}function U(a){return a==null?"":String(a).trim().toUpperCase()}function fe(a){const i=a?.calendar||"solar",h=a?.year??"",x=a?.month??"",A=a?.day??"",v=a?.hour??"0",k=a?.minute??"0",$=a?.gender||"",l=a?.leapMonth||(a?.isLeap?"leap":"common"),g=U(a?.mbti);return[i,`${h}-${x}-${A}`,`${v}:${k}`,$,l,g].join("|")}function xe(a,i){return`ME:${fe(a)}||PARTNER:${fe(i)}`}function Ue(a){return a?a.signature?a.signature:a.me&&a.partner?xe(a.me,a.partner):null:null}function ge(){const a=ye(E);if(a==="1")return!0;if(a==="0")return!1;try{const i=K();if(i&&(i.text||i.myPillars||i.partnerPillars))return!0}catch{}return!1}function J(a){const i=a||{};return{calendar:i.calendar||"solar",leapMonth:i.leapMonth||"common",gender:i.gender||"female",mbti:i.mbti||"",year:i.year?String(i.year):"",month:i.month?String(i.month):"",day:i.day?String(i.day):"",hour:i.hour!=null?String(i.hour):"",minute:i.minute!=null?String(i.minute):""}}function et(){o.useEffect(()=>{He({title:"궁합",description:"상생·상극 밸런스와 소통 팁을 사주 기둥 기반으로 확인하세요.",path:"/#/compat",image:"/og-image.png"})},[]);const a=_e(),i=!!a,[h,x]=o.useState(ge),[A,v]=o.useState(()=>ge()?"saved":""),k=o.useMemo(()=>a?.gender==="male"?"female":a?.gender==="female"?"male":"female",[a]),$=o.useMemo(()=>{if(!a)return[];const e=a.calendar==="lunar",t=e?"음력":"양력",s=e&&(a.leapMonth==="leap"||a.isLeap)?" (윤달)":"",r=[a.year,a.month,a.day].filter(Boolean).join("."),u=(a?.hour??"")!==""?`${a.hour}시`:"—",c=a.gender==="male"?"남성":a.gender==="female"?"여성":"—",d=a.mbti?String(a.mbti).toUpperCase():"—";return[{label:"달력",value:`${t}${s}`.trim()},{label:"생년월일",value:r||"—"},{label:"시간",value:u},{label:"성별",value:c},{label:"MBTI",value:d}]},[a]),[l,g]=o.useState(()=>({...le,calendar:"solar",gender:k,mbti:""})),[D,T]=o.useState(null),[_,R]=o.useState(null),[qe,H]=o.useState(null),[We,Y]=o.useState(null),[G,N]=o.useState(""),[p,q]=o.useState(!1),[ve,F]=o.useState(""),[Se,W]=o.useState(!1),V=o.useRef(!1),I=o.useRef(!1),Q=o.useRef(null),L=o.useRef(!1),B=o.useRef(!1);o.useEffect(()=>(Ke(z),pe(z,"0"),()=>{pe(z,"1")}),[]),o.useEffect(()=>{const e=K();e&&(e.myPillars&&T(e.myPillars),e.partnerPillars&&R(e.partnerPillars),e.text&&N(e.text),e.myMeta&&H(e.myMeta),e.partnerMeta&&Y(e.partnerMeta));let t=null;const s=ye(P);if(s)try{t=JSON.parse(s)}catch{}!t&&e&&e.partner&&(t=e.partner),t&&g(r=>({...r,...J(t)}))},[]);const be=o.useMemo(()=>oe.map(e=>({value:e.value,label:e.label})),[]),we=o.useMemo(()=>{const e=[];for(let t=1900;t<=2029;t++)e.push({value:String(t),label:`${t}년`});return e},[]),Me=o.useMemo(()=>{const e=[];for(let t=1;t<=12;t++)e.push({value:String(t),label:`${t}월`});return e},[]),je=o.useMemo(()=>{const t=l.calendar==="lunar"?30:ie(Number(l.year),Number(l.month)),s=[];for(let r=1;r<=t;r++)s.push({value:String(r),label:`${r}일`});return s},[l.calendar,l.year,l.month]),X=e=>{const t={...e},r=t.calendar==="lunar"?30:ie(Number(t.year),Number(t.month)),u=Number(t.day);return(!u||u>r)&&(t.day=String(Math.min(u||1,r))),t},Ne=e=>g(t=>X({...t,calendar:e})),Ce=e=>g(t=>({...t,gender:e})),S=(e,t)=>{g(e==="year"||e==="month"||e==="leapMonth"?s=>X({...s,[e]:t}):s=>({...s,[e]:t}))},O=o.useMemo(()=>{const e=l.year&&l.month&&l.day,t=l.calendar==="solar"||!!l.leapMonth;return!!(e&&t&&l.gender)},[l]);function Z(e){const t=e.calendar||"solar",s=Number(e.year),r=Number(e.month),u=Number(e.day),c=e.hour!=null?Number(e.hour):0,d=e.minute!=null?Number(e.minute):0,y=e.leapMonth==="leap"||e.isLeap;let C=s,b=r,m=u;if(t==="lunar"){const f=Ae(s,r,u,y),w=f instanceof Date?f:new Date(f);C=w.getFullYear(),b=w.getMonth()+1,m=w.getDate()}return Oe(C,b,m,c,d)}const ee=o.useCallback(()=>{try{const e=document.querySelector("header, .header, [role='banner']");if(!e)return 0;const t=getComputedStyle(e).position||"";return/fixed|sticky/i.test(t)?Math.ceil(e.getBoundingClientRect().height||0):0}catch{return 0}},[]),te=o.useCallback(e=>{if(!e||typeof window>"u")return null;let t=e.parentElement;for(;t;){const s=window.getComputedStyle(t),r=s.overflowY||s.overflow;if(/(auto|scroll|overlay)/i.test(r))return t;t=t.parentElement}return null},[]),ae=o.useCallback(e=>{if(!e)return!1;const t=14,s=ee(),r=te(e)||window;let u;if(r===window){const f=e.getBoundingClientRect();u=(window.scrollY||window.pageYOffset)+f.top}else{const f=e.getBoundingClientRect(),w=r.getBoundingClientRect();u=r.scrollTop+(f.top-w.top)}const c=Math.max(0,u-s-t),d=document.scrollingElement||document.documentElement,y=r===window?window.innerHeight||d.clientHeight:r.clientHeight,C=r===window?d.scrollHeight:r.scrollHeight,b=Math.max(0,C-y),m=Math.min(c,b);try{r===window?window.scrollTo({top:m,behavior:"smooth"}):r.scrollTo({top:m,behavior:"smooth"})}catch{r===window?window.scrollTo(0,m):r.scrollTop=m}return!0},[ee,te]);o.useEffect(()=>{if(!B.current&&!p&&G&&L.current){const e=document.getElementById("compat-my-header")||document.querySelector("h3.h4, h3");e&&requestAnimationFrame(()=>setTimeout(()=>{ae(e)&&(B.current=!0,L.current=!1)},80))}},[p,G,ae]);function ne(e,t){const s=Number(e?.year),r=Number(e?.month),u=Number(e?.day),c=e?.hour!=null?Number(e.hour):0,d=e?.minute!=null?Number(e.minute):0;return{y:s,m:r,d:u,hh:c,mm:d,gender:e?.gender||"unknown",yearStem:t?.year?.stem}}async function Ee(e,t,s,r,u){q(!0),F(""),N("");try{const c={calendar:e?.calendar,year:e?.year,month:e?.month,day:e?.day,hour:e?.hour??"0",minute:e?.minute??"0",gender:e?.gender,leapMonth:e?.leapMonth,mbti:U(e?.mbti)},d={calendar:t?.calendar,year:t?.year,month:t?.month,day:t?.day,hour:t?.hour??"0",minute:t?.minute??"0",gender:t?.gender,leapMonth:t?.leapMonth,mbti:U(t?.mbti)},y=ne(e,s),C=ne(t,r),b=me(s,{birth:y,mode:"compat"}),m=me(r,{birth:C,mode:"compat"}),f={me:{input:c,pillars:s,meta:b},partner:{input:d,pillars:r,meta:m},guidance:{must_use:["오행 분포/균형","용신·기신","십성(육친)","신살","합·충·형·해·파·원진","격국(요지)","대운·세운 톤(과도한 단정 금지)"],avoid:["JSON 외 임의 간지/점수 생성","과장/공포 유발 표현","개인정보/생년월일 재기술"]}},w=["당신은 명리·사주 풀이 무당입니다. 궁합을 풀이하고 다음 규칙을 반드시 지킵니다.","오직 제공된 JSON(양측의 4주와 meta: 용신·기신·십성·신살·오행분포·합충형해파·격국 등)만을 근거로 서술하세요.","새 간지/점수/절기 생성 금지, 외부 추정 금지, 단정/공포 금지.","궁합 총평, 성격풀이, 겉궁합 풀이, 속궁합 풀이, 섹스풀이로 소제목을 작성해줘.","각 항목 500자 이상 작성하고, 반복/상투어 금지, 구체 사례/상호작용 중심.","조언, 해결책제시는 금지. 오로지 사주풀이만 작성해주세요","생년월일/시각은 본문에 재기술하지 마세요(이미 별도로 제공됨)."].join(" "),Le=["분석 JSON:","```json",JSON.stringify(f,null,2),"```","","지침:","- 용신과 기신의 상호작용(상생/상극)으로 관계의 균형·보완 포인트를 설명하세요.","- 양측 십성(육친)과 신살을 비교하여 소통/신뢰/갈등 포인트를 구체화하세요.","- 합·충·형·해·파·원진이 성립하면 해당 영역에 미칠 가능성을 사례로 연결하세요.","- 과한 점괘식 표현/점수화/별점/색상 표기는 금지합니다."].join(`
`),Pe=await ze({messages:[{role:"system",content:w},{role:"user",content:Le}]}),se=String(Pe||"").trim();N(se),$e({me:c,partner:d,myPillars:s,partnerPillars:r,myMeta:b,partnerMeta:m,text:se,signature:u,ts:Date.now()}),x(!0),v("saved"),j(E,"1"),j(P,JSON.stringify(J(d)))}catch(c){F(c?.message||String(c))}finally{q(!1)}}const Te=async e=>{e.preventDefault(),L.current=!0,B.current=!1,x(!0),v("");const t=J(l);j(E,"1"),j(P,JSON.stringify(t));let s=null;a?.year&&a?.month&&a?.day?(s=Z(a),T(s)):T(null);let r=null;if(l?.year&&l?.month&&l?.day?(r=Z(l),R(r)):R(null),!(s&&r)){N(""),F("내 정보와 상대방 정보를 모두 입력해야 궁합 풀이가 가능합니다."),x(!1),v(""),j(E,"0"),he(P),L.current=!1;return}const u=xe(a,l),c=K(),d=Ue(c);if(c&&c.text&&d===u){N(c.text),T(c.myPillars||s),R(c.partnerPillars||r),c.myMeta&&H(c.myMeta),c.partnerMeta&&Y(c.partnerMeta),x(!0),v("saved"),j(E,"1");return}await Ee(a,l,s,r,u)},Re=()=>{g({...le,calendar:"solar",gender:k,mbti:""}),T(null),R(null),H(null),Y(null),N(""),F(""),x(!1),v(""),j(E,"0"),he(P),B.current=!1,L.current=!1},Ie=l.calendar==="lunar";if(!i)return n.jsx("div",{className:"calculator",children:n.jsx(ke,{homeHref:"/"})});const re=p;return o.useEffect(()=>{const e=()=>{window.pageYOffset>8&&(I.current=!0)},t=()=>{I.current=!0},s=()=>{I.current=!0},r=d=>{["PageDown","End"," ","Spacebar"].includes(d.key)&&(I.current=!0)};window.addEventListener("scroll",e,{passive:!0}),window.addEventListener("wheel",t,{passive:!0}),window.addEventListener("touchstart",s,{passive:!0}),window.addEventListener("keydown",r);const u=Q.current;let c;return u&&(c=new IntersectionObserver(d=>{for(const y of d)y.isIntersecting&&y.intersectionRatio>=.99&&I.current&&!V.current&&!Fe()&&(V.current=!0,Be(),W(!0))},{root:null,threshold:[.99]}),c.observe(u)),()=>{window.removeEventListener("scroll",e),window.removeEventListener("wheel",t),window.removeEventListener("touchstart",s),window.removeEventListener("keydown",r),c&&c.disconnect()}},[]),n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"calculator","aria-label":"궁합",children:[n.jsx(Je,{show:re,title:"궁합 해석을 준비하고 있어요",message:"두 사람의 사주 기둥과 메타를 분석하는 중입니다."}),n.jsxs("div",{className:"card result","aria-busy":re?"true":"false",children:[n.jsx("h2",{children:"궁합"}),a?n.jsxs("div",{"aria-label":"내정보 요약",style:{marginTop:8,display:"flex",flexWrap:"wrap",alignItems:"center",gap:8,rowGap:6},children:[n.jsx("span",{"aria-hidden":"true",style:{padding:"4px 8px",borderRadius:999,background:"var(--muted)",fontSize:12,lineHeight:1},children:"내정보"}),$.map(({label:e,value:t},s)=>n.jsxs(De.Fragment,{children:[s>0&&n.jsx("span",{"aria-hidden":"true",style:{opacity:.35,margin:"0 4px"},children:"|"}),n.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:6,minWidth:0,whiteSpace:"nowrap"},children:[n.jsx("span",{style:{fontSize:12,color:"var(--ink-soft)"},children:e}),n.jsx("span",{style:{fontSize:15,letterSpacing:"-0.01em"},children:t})]})]},e))]}):null,n.jsxs("form",{onSubmit:Te,style:{marginTop:16},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:8},children:[n.jsx("h3",{className:"h4",style:{margin:0},children:"상대방 정보"}),h&&A==="saved"&&n.jsx("span",{role:"status","aria-live":"polite",style:{padding:"3px 8px",borderRadius:999,background:"var(--surface)",border:"1px solid var(--border)",fontSize:12,color:"var(--ink-strong)"},children:"저장완료"})]}),n.jsxs("fieldset",{disabled:h||p,"aria-disabled":h||p,style:{border:0,padding:0,margin:0},children:[n.jsxs("div",{className:"row cols-2",children:[n.jsx("div",{className:"field-calendar",children:n.jsx(ce,{label:"달력",options:[{value:"solar",label:"양력"},{value:"lunar",label:"음력"}],value:l.calendar,onChange:Ne,ariaLabel:"달력 종류 선택",helper:"음력 선택 시 양력으로 자동 변환해 계산합니다."})}),Ie&&n.jsx("div",{className:"field-leap",children:n.jsx(M,{label:"윤달 여부",id:"p-leapMonth",options:[{value:"common",label:"평달"},{value:"leap",label:"윤달"}],value:l.leapMonth,onChange:e=>S("leapMonth",e.target.value),helper:"음력에서만 의미가 있습니다."})})]}),n.jsxs("div",{className:"row cols-2",children:[n.jsx("div",{className:"field-gender",children:n.jsx(ce,{label:"성별",options:[{value:"male",label:"남성"},{value:"female",label:"여성"}],value:l.gender,onChange:Ce,ariaLabel:"성별 선택",helper:n.jsxs("span",{children:["성별은 ",n.jsx("strong",{children:"대운 방향(순/역행)"})," 계산에 사용됩니다."]})})}),n.jsx("div",{className:"field-mbti only-desktop",children:n.jsx(M,{label:"MBTI (선택사항)",id:"p-mbti-desktop",options:oe.map(e=>({value:e.value,label:e.label})),value:l.mbti||"",onChange:e=>S("mbti",e.target.value),helper:"더 개인화된 해석을 위해 선택해주세요"})})]}),n.jsxs("div",{className:"row cols-4 sm-cols-2","aria-label":"생년월일 및 시간 선택",children:[n.jsx("div",{className:"field-year",children:n.jsx(M,{label:"년도",id:"p-year",options:we,value:l.year,onChange:e=>S("year",e.target.value)})}),n.jsx("div",{className:"field-month",children:n.jsx(M,{label:"월",id:"p-month",options:Me,value:l.month,onChange:e=>S("month",e.target.value)})}),n.jsx("div",{className:"field-day",children:n.jsx(M,{label:"일",id:"p-day",options:je,value:l.day,onChange:e=>S("day",e.target.value)})}),n.jsx("div",{className:"field-hour",children:n.jsx(M,{label:"시간",id:"p-hour",options:Array.from({length:24},(e,t)=>({value:String(t),label:`${t}시`})),value:l.hour,onChange:e=>S("hour",e.target.value)})})]}),n.jsx("div",{className:"row only-mobile",style:{marginTop:"clamp(8px, 2.2vw, 16px)"},children:n.jsx("div",{className:"field-mbti",children:n.jsx(M,{label:"MBTI (선택사항)",id:"p-mbti-mobile",options:be,value:l.mbti||"",onChange:e=>S("mbti",e.target.value),helper:"더 개인화된 해석을 위해 선택해주세요"})})})]}),n.jsxs("div",{className:"actions",style:{marginTop:"clamp(10px, 2.8vw, 20px)",gap:10},children:[n.jsx(ue,{variant:"text",type:"button",onClick:Re,children:"초기화"}),n.jsx(ue,{type:"submit",disabled:h||p||!O,"aria-disabled":h||p||!O,title:h?"이전 결과가 저장되었습니다. 초기화를 누르면 해제됩니다.":O?void 0:"필수 정보를 먼저 입력하세요.",children:p?"분석 중…":h?"저장완료":"궁합 보기"})]})]}),(D||_)&&n.jsxs("div",{className:"row cols-2 sm-cols-1",style:{marginTop:16},children:[n.jsxs("section",{style:{display:"grid",gap:8},children:[n.jsx("h3",{id:"compat-my-header",className:"h4",style:{margin:0},children:"내 사주 기둥"}),D?n.jsx(de,{pillars:D,idPrefix:"my"}):n.jsx("p",{className:"muted",style:{margin:0},children:"내 정보가 없어 표시할 수 없습니다."})]}),n.jsxs("section",{style:{display:"grid",gap:8},children:[n.jsx("h3",{className:"h4",style:{margin:0},children:"상대방 사주 기둥"}),_?n.jsx(de,{pillars:_,idPrefix:"partner"}):n.jsx("p",{className:"muted",style:{margin:0},children:"상대방 정보를 먼저 입력해 주세요."})]})]}),D&&_&&n.jsxs("section",{style:{display:"grid",gap:8,marginTop:16},children:[n.jsx("h3",{id:"compat-analysis-header",className:"h4",style:{margin:0},children:"궁합 풀이"}),!p&&n.jsx(Ye,{content:G,isLoading:!1,error:ve})]})]})]}),n.jsx("div",{ref:Q,"aria-hidden":!0,style:{height:1}}),n.jsx(Ge,{isOpen:Se,onClose:()=>W(!1),pageTitle:"궁합",shareText:"궁합 결과가 도움이 되셨다면 지인과 공유해 보세요."})]})}export{et as default};
