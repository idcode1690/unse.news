import{r as i,j as s,I as M}from"./index-DEUf_PyA.js";import{a as Q,B as H}from"./cookieUtils-B8spcfGc.js";import{F as P,A as z,c as U}from"./openaiService-D0yG26wD.js";import{s as Y,P as V,a as G,l as W,c as X}from"./seo-CR9k0mXF.js";const Z=["자","축","인","묘","진","사","오","미","신","유","술","해"],ee={자:0,축:2,인:4,묘:6,진:8,사:10,오:12,미:14,신:16,유:18,술:20,해:22};function te(t){if(t===""||t==null)return null;const e=Number(t);return Number.isFinite(e)&&e>=0&&e<=23?e:null}function I(t,e){if(e&&Z.includes(e))return ee[e];const r=te(t);return r??12}function C(t){return String(t).padStart(2,"0")}function se(){const t=new Date(Date.now()+324e5);return`${t.getUTCFullYear()}.${C(t.getUTCMonth()+1)}.${C(t.getUTCDate())}`}function ne(t){var N,S,A;if(!t)return null;if((N=t.sajuResult)!=null&&N.year&&((S=t.sajuResult)!=null&&S.month)&&((A=t.sajuResult)!=null&&A.day))return t;if(!t.year||!t.month||!t.day)return null;const e=t.calendar||"solar",r=Number(t.year),a=Number(t.month),o=Number(t.day),c=t.leapMonth==="leap"||t.isLeap===!0,x=I(t.hour,t.hourBranch),b=Number(t.minute||0);let u=r,g=a,m=o;if(e==="lunar"){const j=W(r,a,o,c),p=j instanceof Date?j:new Date(j);u=p.getFullYear(),g=p.getMonth()+1,m=p.getDate()}const f=X(u,g,m,x,b);return{...t,calendar:e,solarDate:`${u}-${C(g)}-${C(m)}`,sajuResult:f}}function R(t){try{const e=String(t||"").replace(/\r\n/g,`
`).trim();if(!e)return"";if(/^###\s+/m.test(e))return e;const r=e.split(/\n{2,}/).map(o=>o.trim()).filter(Boolean);return r.length?r.map((o,c)=>`### 사주 풀이 ${c+1}
${o}`).join(`

`):e}catch{return t}}function ie(){var p,_,k;i.useEffect(()=>{Y({title:"질문 풀이",description:"운세뉴스에 궁금한 점을 보내면 사주 관점에서 해석해 드립니다.",path:"/#/ask",image:"/og-image.png"})},[]);const t=Q()||null,e=i.useMemo(()=>ne(t),[t]),r=!!((p=e==null?void 0:e.sajuResult)!=null&&p.year&&((_=e==null?void 0:e.sajuResult)!=null&&_.month)&&((k=e==null?void 0:e.sajuResult)!=null&&k.day));if(!e)return s.jsx("div",{className:"calculator",children:s.jsx(M,{homeHref:"/"})});const[a,o]=i.useState(""),[c,x]=i.useState(!1),[b,u]=i.useState(""),[g,m]=i.useState(""),f=i.useRef(null),N=i.useCallback(()=>{const n=["QNA_SAJU_ONLY_WITH_FORCED_H3",a.trim()];return r?n.push(e.calendar,`${e.year}-${e.month}-${e.day}`,`${e.hour??""}:${e.minute??""}:${e.hourBranch??""}`,e.gender??""):n.push("NO_SAJU"),n.join("|")},[a,r,e]);i.useEffect(()=>{try{const n=JSON.parse(localStorage.getItem("ASK_QNA_LAST")||"null");n&&n.question&&typeof n.answer=="string"&&n.answer.trim()&&(o(n.question),u(R(n.answer)),setTimeout(()=>{var l;try{(l=f.current)==null||l.scrollIntoView({behavior:"smooth",block:"start"})}catch{}},60))}catch{}},[]);const S=i.useCallback(()=>{const n=f.current;if(n)try{n.scrollIntoView({behavior:"smooth",block:"start"})}catch{const l=n.getBoundingClientRect(),d=(window.pageYOffset||document.documentElement.scrollTop||0)+l.top-12;window.scrollTo(0,d)}},[]),A=async n=>{var D,O,$;(D=n==null?void 0:n.preventDefault)==null||D.call(n),m(""),u("");const l=a.trim();if(!l){m("질문을 먼저 입력해 주세요.");return}const d=N();try{const h=JSON.parse(localStorage.getItem("ASK_QNA_CACHE")||"{}");if(h[d]){const y=R(String(h[d]||""));u(y);try{localStorage.setItem("ASK_QNA_LAST",JSON.stringify({question:l,answer:y,signature:d,ts:Date.now()}))}catch{}setTimeout(S,30);return}}catch{}x(!0);try{const h=["당신은 '운세 뉴스'의 명리(사주) 풀이 도우미입니다.","출력은 오직 사주 관점 풀이로 작성합니다.","전체 분량은 최소 500자 이상으로 하세요.","쉬운 한국어로, 불필요한 전문용어는 풀어서 설명하세요.","각 문단 앞에 반드시 h3 소제목(### 짧고 명확한 제목)을 한 줄 넣고, 다음 줄부터 본문을 작성하세요.","문단 수는 3~6개로 하세요.","점수/별점/색상/표/목록은 사용하지 마세요. 표나 리스트 대신 문단으로 서술합니다.","일반적/심리/의료/재정 조언, 서론·결론·면책·주의사항 등 비사주성 내용은 금지합니다.","개인정보나 생년월일을 본문에 재기술하지 마세요.","사주가 제공될 경우 근거 우선순위: 용신·기신 → 합/충/형/해/파/원진 → 신살 → 격국(요지) → 오행 분포/신강도 → 대운·세운 톤.","제공된 JSON(pillars, meta) 밖의 임의 간지/표/추정은 생성하지 마세요."].join(" "),y=[`- 질문 원문: """${l}"""`,`- 조회일(KST): ${se()}`],F={question:l};if(r){const v=I(e.hour,e.hourBranch),K={y:Number(e.year),m:Number(e.month),d:Number(e.day),hh:v,mm:Number(e.minute||0),gender:e.gender||"unknown",yearStem:($=(O=e.sajuResult)==null?void 0:O.year)==null?void 0:$.stem},w=G(e.sajuResult,{birth:K});F.me={input:{calendar:e.calendar,year:e.year,month:e.month,day:e.day,hour:e.hour??"",minute:e.minute??"",hourBranch:e.hourBranch||"",gender:e.gender||"unknown",leapMonth:e.leapMonth||(e.isLeap?"leap":"common"),solarDate:e.solarDate||""},pillars:e.sajuResult,meta:w},y.push("- 사주 정보: 제공됨(쿠키의 사주 기둥 + 신살/용신/격국/합충/대운·세운 메타)")}else y.push("- 사주 정보: 제공되지 않음");const E=h,L=["질문/컨텍스트:",...y,"","요청:","- 제공된 4주/메타만 근거로 질문과 직접 연결되는 풀이를 작성하세요.","- 각 문단 앞에는 반드시 '### {짧은 소제목}'을 넣고, 다음 줄에 본문을 씁니다.","- 전체 길이는 500자 이상, 문단은 3~6개."].join(`
`),q="```json\n"+JSON.stringify(F,null,2)+"\n```",B=[{role:"system",content:E},{role:"user",content:L+`

데이터:
`+q}],J=await U({messages:B,cacheKey:d}),T=R(String(J||"").trim());u(T);try{const v=JSON.parse(localStorage.getItem("ASK_QNA_CACHE")||"{}");v[d]=T,localStorage.setItem("ASK_QNA_CACHE",JSON.stringify(v))}catch{}try{localStorage.setItem("ASK_QNA_LAST",JSON.stringify({question:l,answer:T,signature:d,ts:Date.now()}))}catch{}setTimeout(S,30)}catch(h){m((h==null?void 0:h.message)||"풀이 요청 중 오류가 발생했습니다.")}finally{x(!1)}},j=()=>{o(""),u(""),m("");try{localStorage.removeItem("ASK_QNA_LAST")}catch{}};return s.jsxs("div",{className:"calculator ask-page","aria-label":"질문 풀이",children:[s.jsx(P,{show:c,title:"질문 풀이를 준비하고 있어요",message:"질문을 분석하고 사주 정보를 반영하는 중입니다."}),s.jsxs("div",{className:"card result","aria-busy":c?"true":"false",children:[s.jsx("h2",{children:"질문 풀이"}),r&&s.jsxs("div",{style:{marginTop:0},children:[s.jsx("h3",{style:{margin:"8px 0 0",fontSize:14,color:"var(--ink-soft)"},children:"출생 사주 기둥"}),s.jsx(V,{pillars:e.sajuResult,idPrefix:"ask"})]}),s.jsxs("form",{onSubmit:A,style:{display:"grid",gap:12,marginTop:12},children:[s.jsxs("div",{children:[s.jsx("label",{htmlFor:"q-body",className:"label",children:"질문"}),s.jsx("textarea",{id:"q-body",value:a,onChange:n=>o(n.target.value),placeholder:"예) 올해 이직 타이밍이 제 사주에 어떤가요?",rows:6,style:{width:"100%",resize:"vertical",borderRadius:12,padding:"12px 14px",border:"1px solid var(--border)",background:"var(--surface)",lineHeight:1.6}}),s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:6},children:[s.jsx("div",{className:"muted",style:{fontSize:12},children:"구체적으로 적을수록 더 도움이 돼요. 개인정보는 적지 마세요."}),s.jsxs("div",{className:"muted",style:{fontSize:12},children:[a.trim().length,"자"]})]})]}),s.jsxs("div",{className:"actions",style:{display:"flex",gap:10,marginTop:2},children:[s.jsx(H,{type:"button",variant:"text",onClick:j,children:"초기화"}),s.jsx(H,{type:"submit",disabled:c||!a.trim(),children:c?"풀이 중…":"풀이 받기"})]})]}),s.jsxs("section",{ref:f,style:{marginTop:16},children:[g?s.jsx("div",{className:"info-box",role:"alert",style:{color:"var(--danger, #b91c1c)"},children:g}):null,!c&&b&&s.jsx(z,{content:b,isLoading:!1,error:""})]})]}),s.jsx("style",{children:`
        .label{ display:block; font-weight:700; margin-bottom:6px; }
        .muted{ color: var(--ink-soft, #6b7280); }
      `})]})}export{ie as default};
