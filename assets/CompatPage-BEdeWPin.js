import{r as i,j as n,I as je,R as Ne}from"./index-2Ic18lwy.js";import{a as Ce,D as ne,q as J,M as re,d as G,k as Me,m as Ee,S as se,e as w,B as le,f as Te,r as Le}from"./cookieUtils-so1sHaBl.js";import{s as Re,P as oe,S as ke,c as Ie}from"./ShareModal-DhQkg9on.js";import{F as Pe,A as De,c as _e}from"./openaiService-DmtULpVB.js";const M="compat_locked",I="compat_partner",O="compat_skip_scroll_on_return";function me(a){try{return localStorage.getItem(a)}catch{return null}}function j(a,o){try{localStorage.setItem(a,o)}catch{}}function ie(a){try{localStorage.removeItem(a)}catch{}}function Ae(a){try{return sessionStorage.getItem(a)}catch{return null}}function ce(a,o){try{sessionStorage.setItem(a,o)}catch{}}function K(a){return a==null?"":String(a).trim().toUpperCase()}function ue(a){const o=a?.calendar||"solar",m=a?.year??"",g=a?.month??"",$=a?.day??"",y=a?.hour??"0",P=a?.minute??"0",B=a?.gender||"",s=a?.leapMonth||(a?.isLeap?"leap":"common"),p=K(a?.mbti);return[o,`${m}-${g}-${$}`,`${y}:${P}`,B,s,p].join("|")}function he(a,o){return`ME:${ue(a)}||PARTNER:${ue(o)}`}function Fe(a){return a?a.signature?a.signature:a.me&&a.partner?he(a.me,a.partner):null:null}function de(){const a=me(M);if(a==="1")return!0;if(a==="0")return!1;try{const o=J();if(o&&(o.text||o.myPillars||o.partnerPillars))return!0}catch{}return!1}function z(a){const o=a||{};return{calendar:o.calendar||"solar",leapMonth:o.leapMonth||"common",gender:o.gender||"female",mbti:o.mbti||"",year:o.year?String(o.year):"",month:o.month?String(o.month):"",day:o.day?String(o.day):"",hour:o.hour!=null?String(o.hour):"",minute:o.minute!=null?String(o.minute):""}}function Ge(){i.useEffect(()=>{Re({title:"궁합",description:"상생·상극 밸런스와 소통 팁을 사주 기둥 기반으로 확인하세요.",path:"/#/compat",image:"/og-image.png"})},[]);const a=Ce(),o=!!a,[m,g]=i.useState(de),[$,y]=i.useState(()=>de()?"saved":""),P=i.useMemo(()=>a?.gender==="male"?"female":a?.gender==="female"?"male":"female",[a]),B=i.useMemo(()=>{if(!a)return[];const e=a.calendar==="lunar",t=e?"음력":"양력",l=e&&(a.leapMonth==="leap"||a.isLeap)?" (윤달)":"",r=[a.year,a.month,a.day].filter(Boolean).join("."),u=(a?.hour??"")!==""?`${a.hour}시`:"—",c=a.gender==="male"?"남성":a.gender==="female"?"여성":"—",d=a.mbti?String(a.mbti).toUpperCase():"—";return[{label:"달력",value:`${t}${l}`.trim()},{label:"생년월일",value:r||"—"},{label:"시간",value:u},{label:"성별",value:c},{label:"MBTI",value:d}]},[a]),[s,p]=i.useState(()=>({...ne,calendar:"solar",gender:P,mbti:""})),[D,E]=i.useState(null),[_,T]=i.useState(null),[H,N]=i.useState(""),[h,U]=i.useState(!1),[pe,A]=i.useState(""),[fe,q]=i.useState(!1),W=i.useRef(!1),L=i.useRef(!1),V=i.useRef(null),R=i.useRef(!1),F=i.useRef(!1);i.useEffect(()=>(Ae(O),ce(O,"0"),()=>{ce(O,"1")}),[]),i.useEffect(()=>{const e=J();e&&(e.myPillars&&E(e.myPillars),e.partnerPillars&&T(e.partnerPillars),typeof e.text=="string"&&N(e.text));let t=null;const l=me(I);if(l)try{t=JSON.parse(l)}catch{}!t&&e&&e.partner&&(t=e.partner),t&&p(r=>({...r,...z(t)}))},[]);const ge=i.useMemo(()=>re.map(e=>({value:e.value,label:e.label})),[]);i.useMemo(()=>{const e=[];for(let t=1900;t<=2029;t++)e.push({value:String(t),label:`${t}년`});return e},[]),i.useMemo(()=>{const e=[];for(let t=1;t<=12;t++)e.push({value:String(t),label:`${t}월`});return e},[]),i.useMemo(()=>{const t=s.calendar==="lunar"?30:G(Number(s.year),Number(s.month)),l=[];for(let r=1;r<=t;r++)l.push({value:String(r),label:`${r}일`});return l},[s.calendar,s.year,s.month]);const Q=e=>{const t={...e},r=t.calendar==="lunar"?30:G(Number(t.year),Number(t.month)),u=Number(t.day);return(!u||u>r)&&(t.day=String(Math.min(u||1,r))),t},ye=e=>p(t=>Q({...t,calendar:e})),ve=e=>p(t=>({...t,gender:e})),v=(e,t)=>{p(e==="year"||e==="month"||e==="leapMonth"?l=>Q({...l,[e]:t}):l=>({...l,[e]:t}))},Y=i.useMemo(()=>{const e=s.year&&s.month&&s.day,t=s.calendar==="solar"||!!s.leapMonth;return!!(e&&t&&s.gender)},[s]);function X(e){const t=e.calendar||"solar",l=Number(e.year),r=Number(e.month),u=Number(e.day),c=e.hour!=null?Number(e.hour):0,d=e.minute!=null?Number(e.minute):0,f=e.leapMonth==="leap"||e.isLeap;let C=l,x=r,S=u;if(t==="lunar"){const b=Te(l,r,u,f),k=b instanceof Date?b:new Date(b);C=k.getFullYear(),x=k.getMonth()+1,S=k.getDate()}return Ie(C,x,S,c,d)}const Z=i.useCallback(()=>{try{const e=document.querySelector("header, .header, [role='banner']");if(!e)return 0;const t=getComputedStyle(e).position||"";return/fixed|sticky/i.test(t)?Math.ceil(e.getBoundingClientRect().height||0):0}catch{return 0}},[]),ee=i.useCallback(e=>{if(!e||typeof window>"u")return null;let t=e.parentElement;for(;t;){const l=window.getComputedStyle(t),r=l.overflowY||l.overflow;if(/(auto|scroll|overlay)/i.test(r))return t;t=t.parentElement}return null},[]),te=i.useCallback(e=>{if(!e)return!1;const t=14,l=Z(),r=ee(e)||window;let u;if(r===window){const b=e.getBoundingClientRect();u=(window.scrollY||window.pageYOffset)+b.top}else{const b=e.getBoundingClientRect(),k=r.getBoundingClientRect();u=r.scrollTop+(b.top-k.top)}const c=Math.max(0,u-l-t),d=document.scrollingElement||document.documentElement,f=r===window?window.innerHeight||d.clientHeight:r.clientHeight,C=r===window?d.scrollHeight:r.scrollHeight,x=Math.max(0,C-f),S=Math.min(c,x);try{r===window?window.scrollTo({top:S,behavior:"smooth"}):r.scrollTo({top:S,behavior:"smooth"})}catch{r===window?window.scrollTo(0,S):r.scrollTop=S}return!0},[Z,ee]);i.useEffect(()=>{if(!F.current&&!h&&H&&R.current){const e=document.getElementById("compat-my-header")||document.querySelector("h3.h4, h3");e&&requestAnimationFrame(()=>setTimeout(()=>{te(e)&&(F.current=!0,R.current=!1)},80))}},[h,H,te]);async function xe(e,t,l,r,u){U(!0),A(""),N("");try{const c={calendar:e?.calendar,year:e?.year,month:e?.month,day:e?.day,hour:e?.hour??"0",minute:e?.minute??"0",gender:e?.gender,leapMonth:e?.leapMonth,mbti:K(e?.mbti)},d={calendar:t?.calendar,year:t?.year,month:t?.month,day:t?.day,hour:t?.hour??"0",minute:t?.minute??"0",gender:t?.gender,leapMonth:t?.leapMonth,mbti:K(t?.mbti)},f=["아래 두 사람의 사주 궁합을 한국어로 분석해 주세요.","- 반드시 소제목을 **정확한 이름과 순서**로, 마크다운 h3(###)로 출력하세요.","- 궁합을 보는 사람들이 궁금해 하는 소제목으로 8개 작성할것","- 같은 말 반복 금지, 사주 기둥/오행 근거로 핵심만 쓰세요. 각 항목은 한 단락으로.","명리학과 관련된 전문용어 금지","사주팔자 계산에 따른 풀이만 하고 조언금지","생년 월일시 내용을 본문에 넣지 말것, 별도로 제공됨","# 내 정보","```json",JSON.stringify({input:c,pillars:l},null,2),"```","","# 상대방 정보","```json",JSON.stringify({input:d,pillars:r},null,2),"```"].join(`
`),C=await _e({messages:[{role:"system",content:"당신은 전통 사주 명리학 궁합 전문가입니다. 한국어로 간결하고 실용적으로 조언합니다. JSON에 없는 추정/가정 금지."},{role:"user",content:f}]}),x=String(C||"").trim();N(x),Le({me:c,partner:d,myPillars:l,partnerPillars:r,text:x,signature:u,ts:Date.now()}),g(!0),y("saved"),j(M,"1"),j(I,JSON.stringify(z(d)))}catch(c){A(c?.message||String(c))}finally{U(!1)}}const Se=async e=>{e.preventDefault(),R.current=!0,F.current=!1,g(!0),y("");const t=z(s);j(M,"1"),j(I,JSON.stringify(t));let l=null;a?.year&&a?.month&&a?.day?(l=X(a),E(l)):E(null);let r=null;if(s?.year&&s?.month&&s?.day?(r=X(s),T(r)):T(null),!(l&&r)){N(""),A("내 정보와 상대방 정보를 모두 입력해야 궁합 풀이가 가능합니다."),g(!1),y(""),j(M,"0"),ie(I),R.current=!1;return}const u=he(a,s),c=J(),d=Fe(c);if(c&&c.text&&d===u){N(c.text),E(c.myPillars||l),T(c.partnerPillars||r),g(!0),y("saved"),j(M,"1");return}await xe(a,s,l,r,u)},be=()=>{p({...ne,calendar:"solar",gender:P,mbti:""}),E(null),T(null),N(""),A(""),g(!1),y(""),j(M,"0"),ie(I),F.current=!1,R.current=!1},we=s.calendar==="lunar";if(!o)return n.jsx("div",{className:"calculator",children:n.jsx(je,{homeHref:"/"})});const ae=h;return i.useEffect(()=>{const e=()=>{window.pageYOffset>8&&(L.current=!0)},t=()=>{L.current=!0},l=()=>{L.current=!0},r=d=>{["PageDown","End"," ","Spacebar"].includes(d.key)&&(L.current=!0)};window.addEventListener("scroll",e,{passive:!0}),window.addEventListener("wheel",t,{passive:!0}),window.addEventListener("touchstart",l,{passive:!0}),window.addEventListener("keydown",r);const u=V.current;let c;return u&&(c=new IntersectionObserver(d=>{for(const f of d)f.isIntersecting&&f.intersectionRatio>=.99&&L.current&&!W.current&&!Me()&&(W.current=!0,Ee(),q(!0))},{root:null,threshold:[.99]}),c.observe(u)),()=>{window.removeEventListener("scroll",e),window.removeEventListener("wheel",t),window.removeEventListener("touchstart",l),window.removeEventListener("keydown",r),c&&c.disconnect()}},[]),n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"calculator","aria-label":"궁합",children:[n.jsx(Pe,{show:ae,title:"궁합 해석을 준비하고 있어요",message:"두 사람의 사주 기둥을 분석하는 중입니다."}),n.jsxs("div",{className:"card result","aria-busy":ae?"true":"false",children:[n.jsx("h2",{children:"궁합"}),a?n.jsxs("div",{"aria-label":"내정보 요약",style:{marginTop:8,display:"flex",flexWrap:"wrap",alignItems:"center",gap:8,rowGap:6},children:[n.jsx("span",{"aria-hidden":"true",style:{padding:"4px 8px",borderRadius:999,background:"var(--muted)",fontSize:12,lineHeight:1},children:"내정보"}),B.map(({label:e,value:t},l)=>n.jsxs(Ne.Fragment,{children:[l>0&&n.jsx("span",{"aria-hidden":"true",style:{opacity:.35,margin:"0 4px"},children:"|"}),n.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:6,minWidth:0,whiteSpace:"nowrap"},children:[n.jsx("span",{style:{fontSize:12,color:"var(--ink-soft)"},children:e}),n.jsx("span",{style:{fontSize:15,letterSpacing:"-0.01em"},children:t})]})]},e))]}):null,n.jsxs("form",{onSubmit:Se,style:{marginTop:16},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:8},children:[n.jsx("h3",{className:"h4",style:{margin:0},children:"상대방 정보"}),m&&$==="saved"&&n.jsx("span",{role:"status","aria-live":"polite",style:{padding:"3px 8px",borderRadius:999,background:"var(--surface)",border:"1px solid var(--border)",fontSize:12,color:"var(--ink-strong)"},children:"저장완료"})]}),n.jsxs("fieldset",{disabled:m||h,"aria-disabled":m||h,style:{border:0,padding:0,margin:0},children:[n.jsxs("div",{className:"row cols-2",children:[n.jsx("div",{className:"field-calendar",children:n.jsx(se,{label:"달력",options:[{value:"solar",label:"양력"},{value:"lunar",label:"음력"}],value:s.calendar,onChange:ye,ariaLabel:"달력 종류 선택",helper:"음력 선택 시 양력으로 자동 변환해 계산합니다."})}),we&&n.jsx("div",{className:"field-leap",children:n.jsx(w,{label:"윤달 여부",id:"p-leapMonth",options:[{value:"common",label:"평달"},{value:"leap",label:"윤달"}],value:s.leapMonth,onChange:e=>v("leapMonth",e.target.value),helper:"음력에서만 의미가 있습니다."})})]}),n.jsxs("div",{className:"row cols-2",children:[n.jsx("div",{className:"field-gender",children:n.jsx(se,{label:"성별",options:[{value:"male",label:"남성"},{value:"female",label:"여성"}],value:s.gender,onChange:ve,ariaLabel:"성별 선택",helper:n.jsxs("span",{children:["성별은 ",n.jsx("strong",{children:"대운 방향(순/역행)"})," 계산에 사용됩니다."]})})}),n.jsx("div",{className:"field-mbti only-desktop",children:n.jsx(w,{label:"MBTI (선택사항)",id:"p-mbti-desktop",options:re.map(e=>({value:e.value,label:e.label})),value:s.mbti||"",onChange:e=>v("mbti",e.target.value),helper:"더 개인화된 해석을 위해 선택해주세요"})})]}),n.jsxs("div",{className:"row cols-4 sm-cols-2","aria-label":"생년월일 및 시간 선택",children:[n.jsx("div",{className:"field-year",children:n.jsx(w,{label:"년도",id:"p-year",options:Array.from({length:130},(e,t)=>1900+t).map(e=>({value:String(e),label:`${e}년`})),value:s.year,onChange:e=>v("year",e.target.value)})}),n.jsx("div",{className:"field-month",children:n.jsx(w,{label:"월",id:"p-month",options:Array.from({length:12},(e,t)=>({value:String(t+1),label:`${t+1}월`})),value:s.month,onChange:e=>v("month",e.target.value)})}),n.jsx("div",{className:"field-day",children:n.jsx(w,{label:"일",id:"p-day",options:(()=>{const t=s.calendar==="lunar"?30:G(Number(s.year),Number(s.month));return Array.from({length:t},(l,r)=>({value:String(r+1),label:`${r+1}일`}))})(),value:s.day,onChange:e=>v("day",e.target.value)})}),n.jsx("div",{className:"field-hour",children:n.jsx(w,{label:"시간",id:"p-hour",options:Array.from({length:24},(e,t)=>({value:String(t),label:`${t}시`})),value:s.hour,onChange:e=>v("hour",e.target.value)})})]}),n.jsx("div",{className:"row only-mobile",style:{marginTop:"clamp(8px, 2.2vw, 16px)"},children:n.jsx("div",{className:"field-mbti",children:n.jsx(w,{label:"MBTI (선택사항)",id:"p-mbti-mobile",options:ge,value:s.mbti||"",onChange:e=>v("mbti",e.target.value),helper:"더 개인화된 해석을 위해 선택해주세요"})})})]}),n.jsxs("div",{className:"actions",style:{marginTop:"clamp(10px, 2.8vw, 20px)",gap:10},children:[n.jsx(le,{variant:"text",type:"button",onClick:be,children:"초기화"}),n.jsx(le,{type:"submit",disabled:m||h||!Y,"aria-disabled":m||h||!Y,title:m?"이전 결과가 저장되었습니다. 초기화를 누르면 해제됩니다.":Y?void 0:"필수 정보를 먼저 입력하세요.",children:h?"분석 중…":m?"저장완료":"궁합 보기"})]})]}),(D||_)&&n.jsxs("div",{className:"row cols-2 sm-cols-1",style:{marginTop:16},children:[n.jsxs("section",{style:{display:"grid",gap:8},children:[n.jsx("h3",{id:"compat-my-header",className:"h4",style:{margin:0},children:"내 사주 기둥"}),D?n.jsx(oe,{pillars:D,idPrefix:"my"}):n.jsx("p",{className:"muted",style:{margin:0},children:"내 정보가 없어 표시할 수 없습니다."})]}),n.jsxs("section",{style:{display:"grid",gap:8},children:[n.jsx("h3",{className:"h4",style:{margin:0},children:"상대방 사주 기둥"}),_?n.jsx(oe,{pillars:_,idPrefix:"partner"}):n.jsx("p",{className:"muted",style:{margin:0},children:"상대방 정보를 먼저 입력해 주세요."})]})]}),D&&_&&n.jsxs("section",{style:{display:"grid",gap:8,marginTop:16},children:[n.jsx("h3",{id:"compat-analysis-header",className:"h4",style:{margin:0},children:"궁합 풀이"}),!h&&n.jsx(De,{content:H,isLoading:!1,error:pe})]})]})]}),n.jsx("div",{ref:V,"aria-hidden":!0,style:{height:1}}),n.jsx(ke,{isOpen:fe,onClose:()=>q(!1),pageTitle:"궁합",shareText:"궁합 결과가 도움이 되셨다면 지인과 공유해 보세요."})]})}export{Ge as default};
