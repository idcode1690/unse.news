import{j as r,r as x}from"./index-GSf4yhqz.js";function y(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function S(e){return e=e.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,(t,n,i)=>`<a href="${y(i)}" target="_blank" rel="noopener noreferrer">${y(n)}</a>`),e=e.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),e=e.replace(/\*([^*]+)\*/g,"<em>$1</em>"),e=e.replace(/`([^`]+)`/g,"<code>$1</code>"),e}function B(e){if(!e)return"";const t=String(e).replace(/\r\n/g,`
`).split(`
`);let n=0,i="";const s=o=>{const u=[];for(;n<t.length&&o(t[n]);)u.push(t[n++]);return u},h=o=>{const u=o.join(`
`).trim();if(!u)return;const g=u.split(/\n{2,}/).map(l=>`<p>${S(y(l))}</p>`);i+=g.join("")};for(;n<t.length;){const o=t[n];if(/^\s*(-{3,}|\*{3,}|_{3,})\s*$/.test(o)){n++,i+="<hr/>";continue}const u=o.match(/^\s*(#{1,3})\s+(.+)$/);if(u){n++;const l=u[1].length,c=u[2].trim(),m=S(y(c));i+=`<h${l+1}>${m}</h${l+1}>`;continue}if(/^\s*>/.test(o)){const c=s(m=>/^\s*>/.test(m)).map(m=>m.replace(/^\s*>\s?/,"")).join(`
`).split(/\n{2,}/).map(m=>`<p>${S(y(m))}</p>`);i+=`<blockquote>${c.join("")}</blockquote>`;continue}if(/^\s*\d+\.\s+/.test(o)){const l=s(c=>/^\s*\d+\.\s+/.test(c)).map(c=>c.replace(/^\s*\d+\.\s+/,"")).map(c=>`<li>${S(y(c))}</li>`).join("");i+=`<ol>${l}</ol>`;continue}if(/^\s*([-*•])\s+/.test(o)){const l=s(c=>/^\s*([-*•])\s+/.test(c)).map(c=>c.replace(/^\s*([-*•])\s+/,"")).map(c=>`<li>${S(y(c))}</li>`).join("");i+=`<ul>${l}</ul>`;continue}const g=[];for(;n<t.length&&!/^\s*$/.test(t[n]);)g.push(t[n++]);for(h(g);n<t.length&&/^\s*$/.test(t[n]);)n++}return i}const q=()=>r.jsxs("div",{className:"ai-loading",role:"img","aria-label":"로딩 중",children:[r.jsxs("svg",{className:"ai-spinner",width:"96",height:"96",viewBox:"0 0 96 96",xmlns:"http://www.w3.org/2000/svg",children:[r.jsx("defs",{children:r.jsxs("linearGradient",{id:"aiGrad",x1:"0",y1:"0",x2:"1",y2:"1",children:[r.jsx("stop",{offset:"0%",stopColor:"#0a84ff"}),r.jsx("stop",{offset:"50%",stopColor:"#7a5af8"}),r.jsx("stop",{offset:"100%",stopColor:"#0fa958"})]})}),r.jsx("circle",{cx:"48",cy:"48",r:"32",fill:"none",stroke:"url(#aiGrad)",strokeWidth:"4",strokeLinecap:"round",strokeDasharray:"160 60",children:r.jsx("animate",{attributeName:"stroke-dashoffset",from:"0",to:"-440",dur:"1.2s",repeatCount:"indefinite"})}),r.jsx("circle",{cx:"48",cy:"48",r:"24",fill:"none",stroke:"rgba(0,0,0,.08)",strokeWidth:"2",strokeDasharray:"4 6",children:r.jsx("animateTransform",{attributeName:"transform",type:"rotate",from:"0 48 48",to:"360 48 48",dur:"6s",repeatCount:"indefinite"})}),r.jsx("g",{transform:"translate(48,48)",children:r.jsxs("circle",{cx:"0",cy:"-24",r:"3.2",fill:"rgba(10,132,255,.85)",children:[r.jsx("animateTransform",{attributeName:"transform",type:"rotate",from:"0",to:"360",dur:"1.6s",repeatCount:"indefinite"}),r.jsx("animate",{attributeName:"r",values:"3.2;5;3.2",dur:"1.6s",repeatCount:"indefinite"})]})}),r.jsx("g",{transform:"translate(48,48)",children:r.jsxs("circle",{cx:"0",cy:"18",r:"2.8",fill:"rgba(122,90,248,.9)",children:[r.jsx("animateTransform",{attributeName:"transform",type:"rotate",from:"360",to:"0",dur:"2.4s",repeatCount:"indefinite"}),r.jsx("animate",{attributeName:"r",values:"2.8;4;2.8",dur:"2.4s",repeatCount:"indefinite"})]})})]}),r.jsx("style",{children:`
      .ai-loading { display:grid; place-items:center; padding:10px 0 6px; }
      .ai-spinner { filter: drop-shadow(0 4px 18px rgba(122,90,248,.25)); }
      @media (prefers-reduced-motion: reduce){
        .ai-spinner animate, .ai-spinner animateTransform { display:none; }
      }
    `})]}),oe=({content:e,isLoading:t,error:n})=>{if(t)return r.jsxs("div",{className:"ai-fortune",children:[r.jsxs("div",{className:"content",children:[r.jsx(q,{}),r.jsx("p",{"aria-live":"polite",children:"AI가 내용을 준비하는 중…"})]}),r.jsx("style",{children:`
          .ai-fortune .content { max-width:none; width:100%; margin:0; padding-right:0; box-sizing:border-box; }
          .ai-fortune .content p { margin: 10px 0; text-align:center; color: var(--ink-soft, #666); }
        `})]});if(n)return r.jsxs("div",{className:"ai-fortune",children:[r.jsxs("div",{className:"content",role:"alert",children:[r.jsx("p",{children:"사주 풀이 생성 중 오류가 발생했습니다."}),r.jsxs("p",{children:[r.jsx("strong",{children:"오류 내용:"})," ",String(n)]}),r.jsx("p",{children:"API 키/네트워크 또는 CORS 설정을 확인해주세요."})]}),r.jsx("style",{children:`
          .ai-fortune .content { max-width:none; width:100%; margin:0; padding-right:0; box-sizing:border-box; }
          .ai-fortune .content p { margin: 8px 0; line-height:1.7; }
        `})]});if(!e)return null;const i=B(e),s={"@context":"https://schema.org","@type":"Article",headline:"AI 사주 풀이",author:{"@type":"Person",name:"AI Fortune"},datePublished:new Date().toISOString(),articleSection:"Horoscope",inLanguage:"ko"};return r.jsxs("div",{className:"ai-fortune",children:[r.jsxs("article",{className:"content",itemScope:!0,itemType:"https://schema.org/Article",children:[r.jsx("div",{itemProp:"articleBody",dangerouslySetInnerHTML:{__html:i}}),r.jsx("meta",{itemProp:"author",content:"AI Fortune"})]}),r.jsx("script",{type:"application/ld+json",dangerouslySetInnerHTML:{__html:JSON.stringify(s)}}),r.jsx("style",{children:`
        .ai-fortune .content {
          max-width: none !important;
          width: 100% !important;
          margin: 0 !important;
          padding-right: 0 !important;
          box-sizing: border-box;
          line-height: 1.85;
          overflow-wrap: anywhere;
        }
        .ai-fortune .content h2,
        .ai-fortune .content h3,
        .ai-fortune .content h4 { text-align: left; }
        .ai-fortune .content p { margin: 10px 0; }
        .ai-fortune .content ul, 
        .ai-fortune .content ol { margin: 8px 0 8px 18px; }
        .ai-fortune .content a { color: var(--accent, #7a5af8); text-decoration: none; }
        .ai-fortune .content a:hover { text-decoration: underline; }
      `})]})};function ce({show:e=!1,title:t="준비 중입니다…",message:n="조금만 기다려 주세요.",respectReducedMotion:i=!0,forceHaptics:s=!1}){const h=typeof navigator<"u"&&typeof navigator.vibrate=="function",[o,u]=x.useState(!1);x.useEffect(()=>{if(i)try{const a=window.matchMedia("(prefers-reduced-motion: reduce)"),p=()=>u(!!a.matches);return p(),a.addEventListener?a.addEventListener("change",p):a.addListener(p),()=>{a.removeEventListener?a.removeEventListener("change",p):a.removeListener(p)}}catch{}},[i]);const g=x.useMemo(()=>{try{return s||navigator?.maxTouchPoints>0||window.matchMedia&&window.matchMedia("(hover: none) and (pointer: coarse)").matches}catch{return!!s}},[s]),[l,c]=x.useState(!1),m=()=>{try{const a=navigator.userActivation;return!!(a?.isActive||a?.hasBeenActive)}catch{return!1}};x.useEffect(()=>{e&&m()&&queueMicrotask(()=>c(!0))},[e]),x.useEffect(()=>{if(!e||l)return;const a=()=>{c(!0)};return window.addEventListener("pointerdown",a,{capture:!0,passive:!0}),window.addEventListener("keydown",a,{capture:!0}),window.addEventListener("touchstart",a,{capture:!0,passive:!0}),()=>{window.removeEventListener("pointerdown",a,{capture:!0}),window.removeEventListener("keydown",a,{capture:!0}),window.removeEventListener("touchstart",a,{capture:!0})}},[e,l]);const d=x.useRef(null),k=x.useRef(e),b=(a=20)=>{if(!h||!l&&!m()||o&&!s)return!1;try{return navigator.vibrate(a)?!0:Array.isArray(a)?navigator.vibrate(20)||!1:navigator.vibrate([20,30,20])||!1}catch{return!1}},f=()=>{if(d.current&&(clearInterval(d.current),d.current=null),h&&(l||m())&&!(o&&!s))try{navigator.vibrate(0)}catch{}};return x.useEffect(()=>(e&&g&&h&&(l||m())&&!(o&&!s)?(b(20),d.current||(d.current=setInterval(()=>{b(20)},2e3))):f(),k.current&&!e&&(b(0),setTimeout(()=>b([25,35,25]),0)),k.current=e,()=>{f()}),[e,g,h,l,o,s]),x.useEffect(()=>{if(!e)return;const a=()=>{document.visibilityState==="hidden"?f():e&&(l||m())&&(b(20),d.current||(d.current=setInterval(()=>b(20),2e3)))};return document.addEventListener("visibilitychange",a),()=>document.removeEventListener("visibilitychange",a)},[e,l]),x.useEffect(()=>{e&&(h||console.info("[FullScreenLoader] 이 환경은 navigator.vibrate를 지원하지 않습니다(iOS Safari 등)."))},[e,h]),e?r.jsxs("div",{role:"status","aria-live":"polite",className:`fs-loader ${o?"reduce":"animate"}`,children:[r.jsxs("div",{className:"fs-loader__inner",children:[r.jsxs("div",{className:"solarsys",role:"img","aria-label":"로딩 중: 태양계 애니메이션",children:[r.jsx("div",{className:"sun","aria-hidden":"true"}),r.jsx("div",{className:"orbit orbit--1","aria-hidden":"true",children:r.jsx("div",{className:"planet planet--1"})}),r.jsx("div",{className:"orbit orbit--2","aria-hidden":"true",children:r.jsx("div",{className:"planet planet--2"})}),r.jsx("div",{className:"orbit orbit--3","aria-hidden":"true",children:r.jsx("div",{className:"planet planet--3"})})]}),r.jsx("h3",{className:"fs-loader__title",children:t}),r.jsx("p",{className:"fs-loader__msg",children:n}),r.jsx("span",{style:{marginTop:2,fontSize:11,opacity:.45,userSelect:"none",display:"block"},children:h?l||m()?"진동 활성화됨":"화면을 한 번 터치하면 진동이 켜집니다":"이 기기는 진동 미지원"})]}),r.jsx("style",{children:`
        .fs-loader { position: fixed; inset: 0; width: 100vw; height: 100vh; z-index: 9999;
          display: grid; place-items: center; background: rgba(250,250,252,.88); backdrop-filter: blur(4px);
          contain: layout style paint; }
        @media (prefers-color-scheme: dark){ .fs-loader { background: rgba(11,15,25,.72); } }

        .fs-loader__inner { display: grid; justify-items: center; gap: 14px; padding: 24px 28px; border-radius: 16px;
          background: var(--surface,#fff); border: 1px solid var(--border,#e5e7eb);
          box-shadow: 0 1px 2px rgba(0,0,0,.04), 0 18px 50px rgba(0,0,0,.10);
          text-align: center; max-width: min(88vw,520px); transform: translateZ(0); will-change: transform; }
        @media (prefers-color-scheme: dark){ .fs-loader__inner { background: #0b0f19; border-color: #253041; } }

        .fs-loader__title { margin: 2px 0 0; font-size: clamp(18px,2.2vw,20px); font-weight: 800;
          letter-spacing: -0.01em; color: var(--ink-strong,#111827); }
        .fs-loader__msg { margin: 0; font-size: 14px; color: var(--ink-soft,#6b7280); }
        @media (prefers-color-scheme: dark){
          .fs-loader__title { color: #e5e7eb; }
          .fs-loader__msg { color: #9aa4b2; }
        }

        .solarsys { --size: clamp(84px,16vw,120px); --sun: calc(var(--size)*0.28);
          --o1: calc(var(--size)*0.40); --o2: calc(var(--size)*0.64); --o3: calc(var(--size)*0.84);
          --spin1: 7s; --spin2: 11s; --spin3: 16s; --pulse: 2.6s;
          position: relative; width: var(--size); height: var(--size);
          display: grid; place-items: center; user-select: none; pointer-events: none;
          transform: translateZ(0); will-change: transform; }
        .fs-loader.reduce .solarsys { --spin1: 11s; --spin2: 16s; --spin3: 24s; --pulse: 4.2s; }

        .solarsys .sun { width: var(--sun); height: var(--sun); border-radius: 50%;
          background: radial-gradient(circle at 30% 30%, #ffd166 0%, #fca311 45%, #f59e0b 60%, #ef7f00 100%);
          box-shadow: 0 0 12px 4px rgba(255,184,0,.35), 0 0 40px 8px rgba(255,184,0,.20);
          animation: sun-pulse var(--pulse) ease-in-out infinite; }

        .solarsys .orbit { position: absolute; display: grid; place-items: center; border-radius: 50%;
          border: 1px dashed rgba(125,130,155,.25); }
        .solarsys .orbit--1 { width: var(--o1); height: var(--o1); animation: spin var(--spin1) linear infinite; }
        .solarsys .orbit--2 { width: var(--o2); height: var(--o2); animation: spin var(--spin2) linear infinite reverse; }
        .solarsys .orbit--3 { width: var(--o3); height: var(--o3); animation: spin var(--spin3) linear infinite; }

        .solarsys .planet { position: absolute; top: 0; transform: translateY(-50%); border-radius: 50%;
          box-shadow: 0 2px 6px rgba(0,0,0,.12); }
        .solarsys .planet--1 { width: calc(var(--size)*0.08); height: calc(var(--size)*0.08);
          background: radial-gradient(circle at 35% 35%, #9ae6b4 0%, #22c55e 70%); }
        .solarsys .planet--2 { width: calc(var(--size)*0.10); height: calc(var(--size)*0.10);
          background: radial-gradient(circle at 35% 35%, #93c5fd 0%, #3b82f6 70%); }
        .solarsys .planet--3 { width: calc(var(--size)*0.12); height: calc(var(--size)*0.12);
          background: radial-gradient(circle at 35% 35%, #fca5a5 0%, #ef4444 70%); }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes sun-pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }
      `})]}):null}const P=typeof navigator<"u"&&typeof navigator.vibrate=="function";function z(){try{const e=navigator.userActivation;return!!(e?.isActive||e?.hasBeenActive)}catch{return!1}}function I(e=20){if(!P||!z())return!1;try{return navigator.vibrate(e)?!0:Array.isArray(e)?navigator.vibrate(20)||!1:navigator.vibrate([20,35,20])||!1}catch{return!1}}function C(){if(P&&z())try{navigator.vibrate(0)}catch{}}function V(){I(20)}function E(){C(),I(30)}function W(){C(),I([25,40,25])}const L=!1,M="https://cool-shape-9570.idcode1690.workers.dev",D=typeof location<"u"&&/github\.io|workers\.dev|vercel\.app|netlify\.app|unse\.news/i.test(location.host),U=L&&!D?"/api/ai":`${M}/chat`;try{console.info("[openaiService] endpoint:",U,"mode=","production","dev=",L)}catch{}const J="ai_cache_v1:",A=new Map,O=60*1e3,F=60*O,w=24*F;function G(){return Date.now()+9*F}function H(){const e=G(),t=w-e%w;return t>0?t:O}function Y(){const e=G(),n=new Date(e).getUTCDay(),i=e-e%w,s=(7-n)%7,o=i+(s===0?7:s)*w-e;return o>0?o:O}function N(e){const t=String(e||"").toUpperCase();return t.includes("TODAY")?H():t.includes("SAJU")?365*w:t.includes("COMPAT")?30*w:t.includes("LOTTO")?Y():30*w}function Z(e){try{return localStorage.getItem(e)}catch{return null}}function Q(e,t){try{localStorage.setItem(e,t)}catch{}}function R(e){try{localStorage.removeItem(e)}catch{}}function X(e){if(!e)return null;const t=J+e,n=Z(t);if(!n)return null;try{const{value:i,expireAt:s}=JSON.parse(n);return s&&Date.now()<s?String(i??""):(R(t),null)}catch{return R(t),null}}function $(e,t,n){if(!e)return;const i=J+e,s=Date.now()+(n??N(e));Q(i,JSON.stringify({value:String(t??""),expireAt:s}))}const K=new Set([404,405,409,415,429,500,501,502,503,504]);function _(e){return K.has(Number(e))}function ee(e){return Array.from(new Set(e.filter(Boolean)))}function te(e){const t=JSON.stringify(e);return btoa(unescape(encodeURIComponent(t))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function re(e){const t=M.replace(/\/+$/,""),n=e||`${t}/chat`;return ee([n,`${t}/chat`,`${t}/api/ai`,`${t}/v1/chat`,`${t}/v1/chat/completions`,t,L&&!D?"/api/ai":null])}async function ne(e,t){const n=await fetch(e,{method:"POST",mode:"cors",credentials:"omit",cache:"no-store",headers:{"content-type":"application/json"},body:JSON.stringify(t),redirect:"follow",referrerPolicy:"no-referrer"}),i=await n.text();return{res:n,text:i}}async function ae(e,t){const n=await fetch(e,{method:"POST",mode:"cors",credentials:"omit",cache:"no-store",headers:{"content-type":"text/plain;charset=UTF-8"},body:JSON.stringify(t),redirect:"follow",referrerPolicy:"no-referrer"}),i=await n.text();return{res:n,text:i}}async function ie(e,t){const n=te(t),i=new URL(e,location.origin);i.searchParams.set("payload",n);const s=i.toString();if(s.length>1900){const u=new Error("GET fallback skipped: URL too long");throw u.skipped=!0,u}const h=await fetch(s,{method:"GET",mode:"cors",credentials:"omit",cache:"no-store",redirect:"follow",referrerPolicy:"no-referrer"}),o=await h.text();return{res:h,text:o}}function T(e){let t=null;try{t=JSON.parse(e)}catch{}const n=t?.choices?.[0]?.message?.content??(t?"":e);return String(n??"")}function j(e,t,n){let i;try{i=JSON.parse(n)}catch{i={error:n}}const s=i?.error?.message||i?.error||n||"Unknown error",h=`OpenAI API 오류 (${t.status}) @ ${e} : ${typeof s=="string"?s:JSON.stringify(s)}`,o=new Error(h);return o.status=t.status,o.endpoint=e,o.body=n,o}async function le({messages:e,cacheKey:t,model:n="gpt-5.1-mini",temperature:i=.1,top_p:s=1,max_tokens:h=1800,seed:o=777}={}){const u=t?X(t):null;if(u!=null&&u!==""){try{console.debug("[openaiService] cache HIT:",t)}catch{}return u}if(t&&A.has(t)){try{console.debug("[openaiService] inflight dedupe:",t)}catch{}return A.get(t)}const g={model:n,messages:e,cacheKey:t,temperature:i,top_p:s,max_tokens:h,seed:o};try{V()}catch{}const l=re(U),c=[],m=(async()=>{let d=null;for(const f of l){try{c.push(`POST json -> ${f}`);const{res:a,text:p}=await ne(f,g);if(a.ok){const v=T(p);t&&v&&$(t,v,N(t));try{E()}catch{}return v}else if(_(a.status))d=j(f,a,p);else throw j(f,a,p)}catch(a){d=a}try{c.push(`POST text/plain -> ${f}`);const{res:a,text:p}=await ae(f,g);if(a.ok){const v=T(p);t&&v&&$(t,v,N(t));try{E()}catch{}return v}else if(_(a.status))d=j(f,a,p);else throw j(f,a,p)}catch(a){d=a}try{c.push(`GET ?payload -> ${f}`);const{res:a,text:p}=await ie(f,g);if(a.ok){const v=T(p);t&&v&&$(t,v,N(t));try{E()}catch{}return v}else if(_(a.status))d=j(f,a,p);else throw j(f,a,p)}catch(a){d=a}}try{W()}catch{}const k=["AI 풀이 생성에 실패했습니다.","시도한 요청:",...c.map(f=>`- ${f}`),d?`마지막 오류: ${d.message||String(d)}`:""].join(`
`),b=new Error(k);throw b.cause=d,b})();t&&A.set(t,m);try{return await m}finally{t&&A.delete(t)}}export{oe as A,ce as F,le as c};
