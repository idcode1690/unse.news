import{r as c,j as s,I as P}from"./index-CNdVkFF5.js";import{a as z,B as E}from"./cookieUtils-fixozt5I.js";import{F as U,A as Y,c as V}from"./openaiService-CEHq7sOl.js";import{s as G,P as W,a as X,l as Z,c as ee}from"./sajuExtras-LbL1oaer.js";const te=["자","축","인","묘","진","사","오","미","신","유","술","해"],se={자:0,축:2,인:4,묘:6,진:8,사:10,오:12,미:14,신:16,유:18,술:20,해:22};function ne(t){if(t===""||t==null)return null;const e=Number(t);return Number.isFinite(e)&&e>=0&&e<=23?e:null}function L(t,e){if(e&&te.includes(e))return se[e];const r=ne(t);return r==null?12:r}function R(t){return String(t).padStart(2,"0")}function re(){const t=new Date(Date.now()+324e5);return`${t.getUTCFullYear()}.${R(t.getUTCMonth()+1)}.${R(t.getUTCDate())}`}function ae(t){var v,S,C;if(!t)return null;if((v=t.sajuResult)!=null&&v.year&&((S=t.sajuResult)!=null&&S.month)&&((C=t.sajuResult)!=null&&C.day))return t;if(!t.year||!t.month||!t.day)return null;const e=t.calendar||"solar",r=Number(t.year),l=Number(t.month),i=Number(t.day),u=t.leapMonth==="leap"||t.isLeap===!0,N=L(t.hour,t.hourBranch),A=Number(t.minute||0);let m=r,g=l,d=i;if(e==="lunar"){const j=Z(r,l,i,u),p=j instanceof Date?j:new Date(j);m=p.getFullYear(),g=p.getMonth()+1,d=p.getDate()}const f=ee(m,g,d,N,A);return{...t,calendar:e,solarDate:`${m}-${R(g)}-${R(d)}`,sajuResult:f}}function k(t){try{const e=String(t||"").replace(/\r\n/g,`
`).trim();if(!e)return"";if(/^###\s+/m.test(e))return e;const r=e.split(/\n{2,}/).map(i=>i.trim()).filter(Boolean);return r.length?r.map((i,u)=>`### 사주 풀이 ${u+1}
${i}`).join(`

`):e}catch{return t}}function ue(){var p,D,O;c.useEffect(()=>{G({title:"질문 풀이",description:"운세뉴스에 궁금한 점을 보내면 사주 관점에서 해석해 드립니다.",path:"/#/ask",image:"/og-image.png"})},[]);const t=z()||null,e=c.useMemo(()=>ae(t),[t]),r=!!((p=e==null?void 0:e.sajuResult)!=null&&p.year&&((D=e==null?void 0:e.sajuResult)!=null&&D.month)&&((O=e==null?void 0:e.sajuResult)!=null&&O.day));if(!e)return s.jsx("div",{className:"calculator",children:s.jsx(P,{homeHref:"/"})});const[l,i]=c.useState(""),[u,N]=c.useState(!1),[A,m]=c.useState(""),[g,d]=c.useState(""),f=c.useRef(null),v=c.useCallback(()=>{var a,o,x,b;const n=["QNA_SAJU_ONLY_WITH_FORCED_H3",l.trim()];return r?n.push(e.calendar,`${e.year}-${e.month}-${e.day}`,`${(a=e.hour)!=null?a:""}:${(o=e.minute)!=null?o:""}:${(x=e.hourBranch)!=null?x:""}`,(b=e.gender)!=null?b:""):n.push("NO_SAJU"),n.join("|")},[l,r,e]);c.useEffect(()=>{try{const n=JSON.parse(localStorage.getItem("ASK_QNA_LAST")||"null");n&&n.question&&typeof n.answer=="string"&&n.answer.trim()&&(i(n.question),m(k(n.answer)),setTimeout(()=>{var a;try{(a=f.current)==null||a.scrollIntoView({behavior:"smooth",block:"start"})}catch{}},60))}catch{}},[]);const S=c.useCallback(()=>{const n=f.current;if(n)try{n.scrollIntoView({behavior:"smooth",block:"start"})}catch{const a=n.getBoundingClientRect(),o=(window.pageYOffset||document.documentElement.scrollTop||0)+a.top-12;window.scrollTo(0,o)}},[]),C=async n=>{var x,b,$,F,H;(x=n==null?void 0:n.preventDefault)==null||x.call(n),d(""),m("");const a=l.trim();if(!a){d("질문을 먼저 입력해 주세요.");return}const o=v();try{const h=JSON.parse(localStorage.getItem("ASK_QNA_CACHE")||"{}");if(h[o]){const y=k(String(h[o]||""));m(y);try{localStorage.setItem("ASK_QNA_LAST",JSON.stringify({question:a,answer:y,signature:o,ts:Date.now()}))}catch{}setTimeout(S,30);return}}catch{}N(!0);try{const h=["당신은 '운세 뉴스'의 명리(사주) 풀이 도우미입니다.","출력은 오직 사주 관점 풀이로 작성합니다.","전체 분량은 최소 500자 이상으로 하세요.","쉬운 한국어로, 불필요한 전문용어는 풀어서 설명하세요.","각 문단 앞에 반드시 h3 소제목(### 짧고 명확한 제목)을 한 줄 넣고, 다음 줄부터 본문을 작성하세요.","문단 수는 3~6개로 하세요.","점수/별점/색상/표/목록은 사용하지 마세요. 표나 리스트 대신 문단으로 서술합니다.","일반적/심리/의료/재정 조언, 서론·결론·면책·주의사항 등 비사주성 내용은 금지합니다.","개인정보나 생년월일을 본문에 재기술하지 마세요.","사주가 제공될 경우 근거 우선순위: 용신·기신 → 합/충/형/해/파/원진 → 신살 → 격국(요지) → 오행 분포/신강도 → 대운·세운 톤.","제공된 JSON(pillars, meta) 밖의 임의 간지/표/추정은 생성하지 마세요."].join(" "),y=[`- 질문 원문: """${a}"""`,`- 조회일(KST): ${re()}`],I={question:a};if(r){const T=L(e.hour,e.hourBranch),M={y:Number(e.year),m:Number(e.month),d:Number(e.day),hh:T,mm:Number(e.minute||0),gender:e.gender||"unknown",yearStem:($=(b=e.sajuResult)==null?void 0:b.year)==null?void 0:$.stem},Q=X(e.sajuResult,{birth:M});I.me={input:{calendar:e.calendar,year:e.year,month:e.month,day:e.day,hour:(F=e.hour)!=null?F:"",minute:(H=e.minute)!=null?H:"",hourBranch:e.hourBranch||"",gender:e.gender||"unknown",leapMonth:e.leapMonth||(e.isLeap?"leap":"common"),solarDate:e.solarDate||""},pillars:e.sajuResult,meta:Q},y.push("- 사주 정보: 제공됨(쿠키의 사주 기둥 + 신살/용신/격국/합충/대운·세운 메타)")}else y.push("- 사주 정보: 제공되지 않음");const q=h,B=["질문/컨텍스트:",...y,"","요청:","- 제공된 4주/메타만 근거로 질문과 직접 연결되는 풀이를 작성하세요.","- 각 문단 앞에는 반드시 '### {짧은 소제목}'을 넣고, 다음 줄에 본문을 씁니다.","- 전체 길이는 500자 이상, 문단은 3~6개."].join(`
`),J="```json\n"+JSON.stringify(I,null,2)+"\n```",K=[{role:"system",content:q},{role:"user",content:B+`

데이터:
`+J}],w=await V({messages:K,cacheKey:o}),_=k(String(w||"").trim());m(_);try{const T=JSON.parse(localStorage.getItem("ASK_QNA_CACHE")||"{}");T[o]=_,localStorage.setItem("ASK_QNA_CACHE",JSON.stringify(T))}catch{}try{localStorage.setItem("ASK_QNA_LAST",JSON.stringify({question:a,answer:_,signature:o,ts:Date.now()}))}catch{}setTimeout(S,30)}catch(h){d((h==null?void 0:h.message)||"풀이 요청 중 오류가 발생했습니다.")}finally{N(!1)}},j=()=>{i(""),m(""),d("");try{localStorage.removeItem("ASK_QNA_LAST")}catch{}};return s.jsxs("div",{className:"calculator ask-page","aria-label":"질문 풀이",children:[s.jsx(U,{show:u,title:"질문 풀이를 준비하고 있어요",message:"질문을 분석하고 사주 정보를 반영하는 중입니다."}),s.jsxs("div",{className:"card result","aria-busy":u?"true":"false",children:[s.jsx("h2",{children:"질문 풀이"}),r&&s.jsxs("div",{style:{marginTop:0},children:[s.jsx("h3",{style:{margin:"8px 0 0",fontSize:14,color:"var(--ink-soft)"},children:"출생 사주 기둥"}),s.jsx(W,{pillars:e.sajuResult,idPrefix:"ask"})]}),s.jsxs("form",{onSubmit:C,style:{display:"grid",gap:12,marginTop:12},children:[s.jsxs("div",{children:[s.jsx("label",{htmlFor:"q-body",className:"label",children:"질문"}),s.jsx("textarea",{id:"q-body",value:l,onChange:n=>i(n.target.value),placeholder:"예) 올해 이직 타이밍이 제 사주에 어떤가요?",rows:6,style:{width:"100%",resize:"vertical",borderRadius:12,padding:"12px 14px",border:"1px solid var(--border)",background:"var(--surface)",lineHeight:1.6}}),s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:6},children:[s.jsx("div",{className:"muted",style:{fontSize:12},children:"구체적으로 적을수록 더 도움이 돼요. 개인정보는 적지 마세요."}),s.jsxs("div",{className:"muted",style:{fontSize:12},children:[l.trim().length,"자"]})]})]}),s.jsxs("div",{className:"actions",style:{display:"flex",gap:10,marginTop:2},children:[s.jsx(E,{type:"button",variant:"text",onClick:j,children:"초기화"}),s.jsx(E,{type:"submit",disabled:u||!l.trim(),children:u?"풀이 중…":"풀이 받기"})]})]}),s.jsxs("section",{ref:f,style:{marginTop:16},children:[g?s.jsx("div",{className:"info-box",role:"alert",style:{color:"var(--danger, #b91c1c)"},children:g}):null,!u&&A&&s.jsx(Y,{content:A,isLoading:!1,error:""})]})]}),s.jsx("style",{children:`
        .label{ display:block; font-weight:700; margin-bottom:6px; }
        .muted{ color: var(--ink-soft, #6b7280); }
      `})]})}export{ue as default};
