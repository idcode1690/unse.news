import{r as l,j as s,I as L}from"./index-Wku8L6wJ.js";import{a as q,B as T}from"./index-BSTa-Vbb.js";import{F as B,A as J,c as K}from"./openaiService-CBc6il23.js";import{s as w,P as M,a as Q,l as P,c as z}from"./seo-BiiK1ikE.js";const U=["자","축","인","묘","진","사","오","미","신","유","술","해"],Y={자:0,축:2,인:4,묘:6,진:8,사:10,오:12,미:14,신:16,유:18,술:20,해:22};function V(t){if(t===""||t==null)return null;const e=Number(t);return Number.isFinite(e)&&e>=0&&e<=23?e:null}function R(t,e){if(e&&U.includes(e))return Y[e];const r=V(t);return r??12}function N(t){return String(t).padStart(2,"0")}function G(){const t=new Date(Date.now()+324e5);return`${t.getUTCFullYear()}.${N(t.getUTCMonth()+1)}.${N(t.getUTCDate())}`}function W(t){if(!t)return null;if(t.sajuResult?.year&&t.sajuResult?.month&&t.sajuResult?.day)return t;if(!t.year||!t.month||!t.day)return null;const e=t.calendar||"solar",r=Number(t.year),a=Number(t.month),o=Number(t.day),i=t.leapMonth==="leap"||t.isLeap===!0,j=R(t.hour,t.hourBranch),x=Number(t.minute||0);let c=r,h=a,u=o;if(e==="lunar"){const S=P(r,a,o,i),g=S instanceof Date?S:new Date(S);c=g.getFullYear(),h=g.getMonth()+1,u=g.getDate()}const f=z(c,h,u,j,x);return{...t,calendar:e,solarDate:`${c}-${N(h)}-${N(u)}`,sajuResult:f}}function v(t){try{const e=String(t||"").replace(/\r\n/g,`
`).trim();if(!e)return"";if(/^###\s+/m.test(e))return e;const r=e.split(/\n{2,}/).map(o=>o.trim()).filter(Boolean);return r.length?r.map((o,i)=>`### 사주 풀이 ${i+1}
${o}`).join(`

`):e}catch{return t}}function se(){l.useEffect(()=>{w({title:"질문 풀이",description:"운세뉴스에 궁금한 점을 보내면 사주 관점에서 해석해 드립니다.",path:"/#/ask",image:"/og-image.png"})},[]);const t=q()||null,e=l.useMemo(()=>W(t),[t]),r=!!(e?.sajuResult?.year&&e?.sajuResult?.month&&e?.sajuResult?.day);if(!e)return s.jsx("div",{className:"calculator",children:s.jsx(L,{homeHref:"/"})});const[a,o]=l.useState(""),[i,j]=l.useState(!1),[x,c]=l.useState(""),[h,u]=l.useState(""),f=l.useRef(null),S=l.useCallback(()=>{const n=["QNA_SAJU_ONLY_WITH_FORCED_H3",a.trim()];return r?n.push(e.calendar,`${e.year}-${e.month}-${e.day}`,`${e.hour??""}:${e.minute??""}:${e.hourBranch??""}`,e.gender??""):n.push("NO_SAJU"),n.join("|")},[a,r,e]);l.useEffect(()=>{try{const n=JSON.parse(localStorage.getItem("ASK_QNA_LAST")||"null");n&&n.question&&typeof n.answer=="string"&&n.answer.trim()&&(o(n.question),c(v(n.answer)),setTimeout(()=>{try{f.current?.scrollIntoView({behavior:"smooth",block:"start"})}catch{}},60))}catch{}},[]);const g=l.useCallback(()=>{const n=f.current;if(n)try{n.scrollIntoView({behavior:"smooth",block:"start"})}catch{const d=n.getBoundingClientRect(),m=(window.pageYOffset||document.documentElement.scrollTop||0)+d.top-12;window.scrollTo(0,m)}},[]),_=async n=>{n?.preventDefault?.(),u(""),c("");const d=a.trim();if(!d){u("질문을 먼저 입력해 주세요.");return}const m=S();try{const p=JSON.parse(localStorage.getItem("ASK_QNA_CACHE")||"{}");if(p[m]){const y=v(String(p[m]||""));c(y);try{localStorage.setItem("ASK_QNA_LAST",JSON.stringify({question:d,answer:y,signature:m,ts:Date.now()}))}catch{}setTimeout(g,30);return}}catch{}j(!0);try{const p=["당신은 '운세 뉴스'의 명리(사주) 풀이 도우미입니다.","출력은 오직 사주 관점 풀이로 작성합니다.","전체 분량은 최소 500자 이상으로 하세요.","쉬운 한국어로, 불필요한 전문용어는 풀어서 설명하세요.","각 문단 앞에 반드시 h3 소제목(### 짧고 명확한 제목)을 한 줄 넣고, 다음 줄부터 본문을 작성하세요.","문단 수는 3~6개로 하세요.","점수/별점/색상/표/목록은 사용하지 마세요. 표나 리스트 대신 문단으로 서술합니다.","일반적/심리/의료/재정 조언, 서론·결론·면책·주의사항 등 비사주성 내용은 금지합니다.","개인정보나 생년월일을 본문에 재기술하지 마세요.","사주가 제공될 경우 근거 우선순위: 용신·기신 → 합/충/형/해/파/원진 → 신살 → 격국(요지) → 오행 분포/신강도 → 대운·세운 톤.","제공된 JSON(pillars, meta) 밖의 임의 간지/표/추정은 생성하지 마세요."].join(" "),y=[`- 질문 원문: """${d}"""`,`- 조회일(KST): ${G()}`],C={question:d};if(r){const b=R(e.hour,e.hourBranch),I={y:Number(e.year),m:Number(e.month),d:Number(e.day),hh:b,mm:Number(e.minute||0),gender:e.gender||"unknown",yearStem:e.sajuResult?.year?.stem},E=Q(e.sajuResult,{birth:I});C.me={input:{calendar:e.calendar,year:e.year,month:e.month,day:e.day,hour:e.hour??"",minute:e.minute??"",hourBranch:e.hourBranch||"",gender:e.gender||"unknown",leapMonth:e.leapMonth||(e.isLeap?"leap":"common"),solarDate:e.solarDate||""},pillars:e.sajuResult,meta:E},y.push("- 사주 정보: 제공됨(쿠키의 사주 기둥 + 신살/용신/격국/합충/대운·세운 메타)")}else y.push("- 사주 정보: 제공되지 않음");const D=p,O=["질문/컨텍스트:",...y,"","요청:","- 제공된 4주/메타만 근거로 질문과 직접 연결되는 풀이를 작성하세요.","- 각 문단 앞에는 반드시 '### {짧은 소제목}'을 넣고, 다음 줄에 본문을 씁니다.","- 전체 길이는 500자 이상, 문단은 3~6개."].join(`
`),$="```json\n"+JSON.stringify(C,null,2)+"\n```",F=[{role:"system",content:D},{role:"user",content:O+`

데이터:
`+$}],H=await K({messages:F,cacheKey:m}),A=v(String(H||"").trim());c(A);try{const b=JSON.parse(localStorage.getItem("ASK_QNA_CACHE")||"{}");b[m]=A,localStorage.setItem("ASK_QNA_CACHE",JSON.stringify(b))}catch{}try{localStorage.setItem("ASK_QNA_LAST",JSON.stringify({question:d,answer:A,signature:m,ts:Date.now()}))}catch{}setTimeout(g,30)}catch(p){u(p?.message||"풀이 요청 중 오류가 발생했습니다.")}finally{j(!1)}},k=()=>{o(""),c(""),u("");try{localStorage.removeItem("ASK_QNA_LAST")}catch{}};return s.jsxs("div",{className:"calculator ask-page","aria-label":"질문 풀이",children:[s.jsx(B,{show:i,title:"질문 풀이를 준비하고 있어요",message:"질문을 분석하고 사주 정보를 반영하는 중입니다."}),s.jsxs("div",{className:"card result","aria-busy":i?"true":"false",children:[s.jsx("h2",{children:"질문 풀이"}),r&&s.jsxs("div",{style:{marginTop:0},children:[s.jsx("h3",{style:{margin:"8px 0 0",fontSize:14,color:"var(--ink-soft)"},children:"출생 사주 기둥"}),s.jsx(M,{pillars:e.sajuResult,idPrefix:"ask"})]}),s.jsxs("form",{onSubmit:_,style:{display:"grid",gap:12,marginTop:12},children:[s.jsxs("div",{children:[s.jsx("label",{htmlFor:"q-body",className:"label",children:"질문"}),s.jsx("textarea",{id:"q-body",value:a,onChange:n=>o(n.target.value),placeholder:"예) 올해 이직 타이밍이 제 사주에 어떤가요?",rows:6,style:{width:"100%",resize:"vertical",borderRadius:12,padding:"12px 14px",border:"1px solid var(--border)",background:"var(--surface)",lineHeight:1.6}}),s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:6},children:[s.jsx("div",{className:"muted",style:{fontSize:12},children:"구체적으로 적을수록 더 도움이 돼요. 개인정보는 적지 마세요."}),s.jsxs("div",{className:"muted",style:{fontSize:12},children:[a.trim().length,"자"]})]})]}),s.jsxs("div",{className:"actions",style:{display:"flex",gap:10,marginTop:2},children:[s.jsx(T,{type:"button",variant:"text",onClick:k,children:"초기화"}),s.jsx(T,{type:"submit",disabled:i||!a.trim(),children:i?"풀이 중…":"풀이 받기"})]})]}),s.jsxs("section",{ref:f,style:{marginTop:16},children:[h?s.jsx("div",{className:"info-box",role:"alert",style:{color:"var(--danger, #b91c1c)"},children:h}):null,!i&&x&&s.jsx(J,{content:x,isLoading:!1,error:""})]})]}),s.jsx("style",{children:`
        .label{ display:block; font-weight:700; margin-bottom:6px; }
        .muted{ color: var(--ink-soft, #6b7280); }
      `})]})}export{se as default};
