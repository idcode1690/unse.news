import{r as i,j as n,I as He,R as Ye}from"./index-DEUf_PyA.js";import{a as Ge,D as le,k as W,M as ie,i as ze,j as Le,S as ce,d as N,B as ue,m as Je}from"./cookieUtils-B8spcfGc.js";import{s as Ke,P as de,l as ke,c as Ue,a as me}from"./seo-CR9k0mXF.js";import{F as qe,A as We,c as Ve}from"./openaiService-D0yG26wD.js";import{S as Qe}from"./ShareModal-pD7V2XUp.js";const T="compat_locked",B="compat_partner",U="compat_skip_scroll_on_return";function xe(t){try{return localStorage.getItem(t)}catch{return null}}function C(t,l){try{localStorage.setItem(t,l)}catch{}}function he(t){try{localStorage.removeItem(t)}catch{}}function Xe(t){try{return sessionStorage.getItem(t)}catch{return null}}function fe(t,l){try{sessionStorage.setItem(t,l)}catch{}}function Ze(t){return t=Number(t),!Number.isFinite(t)||t<=0?!1:t%400===0||t%4===0&&t%100!==0}function ge(t,l){const h=Number(t),m=Number(l);return!Number.isFinite(m)||m<1||m>12?31:m===2?Ze(h)?29:28:[4,6,9,11].includes(m)?30:31}function ye(t){if(t===""||t===null||t===void 0)return null;const l=Number(t);return Number.isFinite(l)&&l>=0&&l<=23?l:null}function V(t){return t==null?"":String(t).trim().toUpperCase()}function pe(t){const l=(t==null?void 0:t.calendar)||"solar",h=(t==null?void 0:t.year)??"",m=(t==null?void 0:t.month)??"",G=(t==null?void 0:t.day)??"",x=(t==null?void 0:t.hour)??"",D=(t==null?void 0:t.minute)??"0",z=(t==null?void 0:t.gender)||"",r=(t==null?void 0:t.leapMonth)||(t!=null&&t.isLeap?"leap":"common"),p=V(t==null?void 0:t.mbti);return[l,`${h}-${m}-${G}`,`${x}:${D}`,z,r,p].join("|")}function Se(t,l){return`ME:${pe(t)}||PARTNER:${pe(l)}`}function je(t){return t?t.signature?t.signature:t.me&&t.partner?Se(t.me,t.partner):null:null}function ve(){const t=xe(T);if(t==="1")return!0;if(t==="0")return!1;try{const l=W();if(l&&(l.text||l.myPillars||l.partnerPillars))return!0}catch{}return!1}function q(t){const l=t||{};return{calendar:l.calendar||"solar",leapMonth:l.leapMonth||"common",gender:l.gender||"female",mbti:l.mbti||"",year:l.year?String(l.year):"",month:l.month?String(l.month):"",day:l.day?String(l.day):"",hour:l.hour!=null?String(l.hour):"",minute:l.minute!=null?String(l.minute):""}}function ot(){i.useEffect(()=>{Ke({title:"궁합",description:"상생·상극 밸런스와 소통 팁을 사주 기둥 기반으로 확인하세요.",path:"/#/compat",image:"/og-image.png"})},[]);const t=Ge(),l=!!t,[h,m]=i.useState(ve),[G,x]=i.useState(()=>ve()?"saved":""),D=i.useMemo(()=>(t==null?void 0:t.gender)==="male"?"female":(t==null?void 0:t.gender)==="female"?"male":"female",[t]),z=i.useMemo(()=>{if(!t)return[];const e=t.calendar==="lunar",a=e?"음력":"양력",o=e&&(t.leapMonth==="leap"||t.isLeap)?" (윤달)":"",s=[t.year,t.month,t.day].filter(Boolean).join("."),u=((t==null?void 0:t.hour)??"")!==""?`${t.hour}시`:"—",c=t.gender==="male"?"남성":t.gender==="female"?"여성":"—",d=t.mbti?String(t.mbti).toUpperCase():"—";return[{label:"달력",value:`${a}${o}`.trim()},{label:"생년월일",value:s||"—"},{label:"시간",value:u},{label:"성별",value:c},{label:"MBTI",value:d}]},[t]),[r,p]=i.useState(()=>({...le,calendar:"solar",gender:D,mbti:""})),[$,R]=i.useState(null),[A,I]=i.useState(null),[Oe,L]=i.useState(null),[et,J]=i.useState(null),[K,E]=i.useState(""),[g,Q]=i.useState(!1),[we,H]=i.useState(""),[Me,X]=i.useState(!1),Z=i.useRef(!1),P=i.useRef(!1),j=i.useRef(null),F=i.useRef(!1),Y=i.useRef(!1);i.useEffect(()=>(Xe(U),fe(U,"0"),()=>{fe(U,"1")}),[]),i.useEffect(()=>{const e=W();e&&(e.myPillars&&R(e.myPillars),e.partnerPillars&&I(e.partnerPillars),e.text&&E(e.text),e.myMeta&&L(e.myMeta),e.partnerMeta&&J(e.partnerMeta));let a=null;const o=xe(B);if(o)try{a=JSON.parse(o)}catch{}!a&&e&&e.partner&&(a=e.partner),a&&p(s=>({...s,...q(a)}))},[]);const Ne=i.useMemo(()=>ie.map(e=>({value:e.value,label:e.label})),[]),Ce=i.useMemo(()=>{const e=[];for(let a=1900;a<=2029;a++)e.push({value:String(a),label:`${a}년`});return e},[]),Ee=i.useMemo(()=>{const e=[];for(let a=1;a<=12;a++)e.push({value:String(a),label:`${a}월`});return e},[]),Te=i.useMemo(()=>{const a=r.calendar==="lunar"?30:ge(r.year,r.month),o=[];for(let s=1;s<=a;s++)o.push({value:String(s),label:`${s}일`});return o},[r.calendar,r.year,r.month]),Re=i.useMemo(()=>{const e=[{value:"",label:"모름"}];for(let a=0;a<24;a++)e.push({value:String(a),label:`${String(a).padStart(2,"0")}시`});return e},[]),O=e=>{const a={...e},s=a.calendar==="lunar"?30:ge(a.year,a.month),u=Number(a.day);return(!u||u>s)&&(a.day=String(Math.min(u||1,s))),a},Ie=e=>p(a=>O({...a,calendar:e})),Pe=e=>p(a=>({...a,gender:e})),S=(e,a)=>{p(e==="year"||e==="month"||e==="leapMonth"?o=>O({...o,[e]:a}):o=>({...o,[e]:a}))},k=i.useMemo(()=>{const e=r.year&&r.month&&r.day,a=r.calendar==="solar"||!!r.leapMonth;return!!(e&&a&&r.gender)},[r]);function ee(e){const a=e.calendar||"solar",o=Number(e.year),s=Number(e.month),u=Number(e.day),d=ye(e.hour)??12,f=e.minute!=null?Number(e.minute):0,_=e.leapMonth==="leap"||e.isLeap;let w=o,y=s,v=u;if(a==="lunar"){const M=ke(o,s,u,_),b=M instanceof Date?M:new Date(M);w=b.getFullYear(),y=b.getMonth()+1,v=b.getDate()}return Ue(w,y,v,d,f)}const te=i.useCallback(()=>{try{const e=document.querySelector("header, .header, [role='banner']");if(!e)return 0;const a=getComputedStyle(e).position||"";return/fixed|sticky/i.test(a)?Math.ceil(e.getBoundingClientRect().height||0):0}catch{return 0}},[]),ae=i.useCallback(e=>{if(!e||typeof window>"u")return null;let a=e.parentElement;for(;a;){const o=window.getComputedStyle(a),s=o.overflowY||o.overflow;if(/(auto|scroll|overlay)/i.test(s))return a;a=a.parentElement}return null},[]),ne=i.useCallback(e=>{if(!e)return!1;const a=14,o=te(),s=ae(e)||window;let u;if(s===window){const v=e.getBoundingClientRect();u=(window.scrollY||window.pageYOffset)+v.top}else{const v=e.getBoundingClientRect(),M=s.getBoundingClientRect();u=s.scrollTop+(v.top-M.top)}const c=Math.max(0,u-o-a),d=document.scrollingElement||document.documentElement,f=s===window?window.innerHeight||d.clientHeight:s.clientHeight,_=s===window?d.scrollHeight:s.scrollHeight,w=Math.max(0,_-f),y=Math.min(c,w);try{s===window?window.scrollTo({top:y,behavior:"smooth"}):s.scrollTo({top:y,behavior:"smooth"})}catch{s===window?window.scrollTo(0,y):s.scrollTop=y}return!0},[te,ae]);i.useEffect(()=>{if(!Y.current&&!g&&K&&F.current){const e=document.getElementById("compat-my-header")||document.querySelector("h3.h4, h3");e&&requestAnimationFrame(()=>setTimeout(()=>{ne(e)&&(Y.current=!0,F.current=!1)},80))}},[g,K,ne]);function se(e,a){var f;const o=Number(e==null?void 0:e.year),s=Number(e==null?void 0:e.month),u=Number(e==null?void 0:e.day),c=ye(e==null?void 0:e.hour)??12,d=(e==null?void 0:e.minute)!=null?Number(e.minute):0;return{y:o,m:s,d:u,hh:c,mm:d,gender:(e==null?void 0:e.gender)||"unknown",yearStem:(f=a==null?void 0:a.year)==null?void 0:f.stem}}async function Fe(e,a,o,s,u){Q(!0),H(""),E("");try{const c={calendar:e==null?void 0:e.calendar,year:e==null?void 0:e.year,month:e==null?void 0:e.month,day:e==null?void 0:e.day,hour:(e==null?void 0:e.hour)??"",minute:(e==null?void 0:e.minute)??"0",gender:e==null?void 0:e.gender,leapMonth:e==null?void 0:e.leapMonth,mbti:V(e==null?void 0:e.mbti)},d={calendar:a==null?void 0:a.calendar,year:a==null?void 0:a.year,month:a==null?void 0:a.month,day:a==null?void 0:a.day,hour:(a==null?void 0:a.hour)??"",minute:(a==null?void 0:a.minute)??"0",gender:a==null?void 0:a.gender,leapMonth:a==null?void 0:a.leapMonth,mbti:V(a==null?void 0:a.mbti)},f=se(e,o),_=se(a,s),w=me(o,{birth:f,mode:"compat"}),y=me(s,{birth:_,mode:"compat"}),v={me:{input:c,pillars:o,meta:w},partner:{input:d,pillars:s,meta:y},guidance:{must_use:["오행 분포/균형","용신·기신","십성(육친)","신살","합·충·형·해·파·원진","격국(요지)","대운·세운 톤(과도한 단정 금지)"],avoid:["JSON 외 임의 간지/점수 생성","과장/공포 유발 표현","개인정보/생년월일 재기술"]}},M=["당신은 명리·사주 풀이 무당입니다. 궁합을 풀이하고 다음 규칙을 반드시 지킵니다.","모르거나 부정확한 풀이는 허위로 작성하지 말고 완전히 작성하지 마세요","소제목은 h3(###) 형식으로 작성하고, 추가 소제목/서론/결론/요약 금지","오직 제공된 JSON(양측의 4주와 meta: 용신·기신·십성·신살·오행분포·합충형해파·격국 등)만을 근거로 서술하세요.","새 간지/점수/절기 생성 금지, 외부 추정 금지, 단정/공포 금지.","궁합 총평, 성격풀이, 겉궁합 풀이, 속궁합 풀이, 섹스풀이로 소제목을 작성해줘.","각 항목 500자 이상 작성하고, 반복/상투어 금지, 구체 사례/상호작용 중심.","조언, 해결책제시는 금지. 오로지 사주풀이만 작성해주세요","생년월일/시각은 본문에 재기술하지 마세요(이미 별도로 제공됨)."].join(" "),b=["분석 JSON:","```json",JSON.stringify(v,null,2),"```","","지침:","- 용신과 기신의 상호작용(상생/상극)으로 관계의 균형·보완 포인트를 설명하세요.","- 양측 십성(육친)과 신살을 비교하여 소통/신뢰/갈등 포인트를 구체화하세요.","- 합·충·형·해·파·원진이 성립하면 해당 영역에 미칠 가능성을 사례로 연결하세요.","- 과한 점괘식 표현/점수화/별점/색상 표기는 금지합니다."].join(`
`),Ae=await Ve({messages:[{role:"system",content:M},{role:"user",content:b}]}),oe=String(Ae||"").trim();E(oe),Je({me:c,partner:d,myPillars:o,partnerPillars:s,myMeta:w,partnerMeta:y,text:oe,signature:u,ts:Date.now()}),m(!0),x("saved"),C(T,"1"),C(B,JSON.stringify(q(d)))}catch(c){H((c==null?void 0:c.message)||String(c))}finally{Q(!1)}}const _e=async e=>{e.preventDefault(),F.current=!0,Y.current=!1,m(!0),x("");const a=q(r);C(T,"1"),C(B,JSON.stringify(a));let o=null;t!=null&&t.year&&(t!=null&&t.month)&&(t!=null&&t.day)?(o=ee(t),R(o)):R(null);let s=null;if(r!=null&&r.year&&(r!=null&&r.month)&&(r!=null&&r.day)?(s=ee(r),I(s)):I(null),!(o&&s)){E(""),H("내 정보와 상대방 정보를 모두 입력해야 궁합 풀이가 가능합니다."),m(!1),x(""),C(T,"0"),he(B),F.current=!1;return}const u=Se(t,r),c=W(),d=je(c);if(c&&c.text&&d===u){E(c.text),R(c.myPillars||o),I(c.partnerPillars||s),c.myMeta&&L(c.myMeta),c.partnerMeta&&J(c.partnerMeta),m(!0),x("saved"),C(T,"1");return}await Fe(t,r,o,s,u)},be=()=>{p({...le,calendar:"solar",gender:D,mbti:""}),R(null),I(null),L(null),J(null),E(""),H(""),m(!1),x(""),C(T,"0"),he(B),Y.current=!1,F.current=!1},Be=[{value:"solar",label:"양력"},{value:"lunar",label:"음력"}],De=[{value:"male",label:"남성"},{value:"female",label:"여성"}],$e=r.calendar==="lunar";if(!l)return n.jsx("div",{className:"calculator",children:n.jsx(He,{homeHref:"/"})});const re=g;return i.useEffect(()=>{const e=()=>{window.pageYOffset>8&&(P.current=!0)},a=()=>{P.current=!0},o=()=>{P.current=!0},s=d=>{["PageDown","End"," ","Spacebar"].includes(d.key)&&(P.current=!0)};window.addEventListener("scroll",e,{passive:!0}),window.addEventListener("wheel",a,{passive:!0}),window.addEventListener("touchstart",o,{passive:!0}),window.addEventListener("keydown",s);const u=j.current;let c;return u&&(c=new IntersectionObserver(d=>{for(const f of d)f.isIntersecting&&f.intersectionRatio>=.99&&P.current&&!Z.current&&!ze()&&(Z.current=!0,Le(),X(!0))},{root:null,threshold:[.99]}),c.observe(u)),()=>{window.removeEventListener("scroll",e),window.removeEventListener("wheel",a),window.removeEventListener("touchstart",o),window.removeEventListener("keydown",s),c&&c.disconnect()}},[]),n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"calculator","aria-label":"궁합",children:[n.jsx(qe,{show:re,title:"궁합 해석을 준비하고 있어요",message:"두 사람의 사주 기둥과 메타를 분석하는 중입니다."}),n.jsxs("div",{className:"card result","aria-busy":re?"true":"false",children:[n.jsx("h2",{children:"궁합"}),t?n.jsxs("div",{"aria-label":"내정보 요약",style:{marginTop:8,display:"flex",flexWrap:"wrap",alignItems:"center",gap:8,rowGap:6},children:[n.jsx("span",{"aria-hidden":"true",style:{padding:"4px 8px",borderRadius:999,background:"var(--muted)",fontSize:12,lineHeight:1},children:"내정보"}),z.map(({label:e,value:a},o)=>n.jsxs(Ye.Fragment,{children:[o>0&&n.jsx("span",{"aria-hidden":"true",style:{opacity:.35,margin:"0 4px"},children:"|"}),n.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:6,minWidth:0,whiteSpace:"nowrap"},children:[n.jsx("span",{style:{fontSize:12,color:"var(--ink-soft)"},children:e}),n.jsx("span",{style:{fontSize:15,letterSpacing:"-0.01em"},children:a})]})]},e))]}):null,n.jsxs("form",{onSubmit:_e,className:"form-compat",style:{marginTop:16},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("h3",{className:"h4",style:{margin:0},children:"상대방 정보"}),h&&G==="saved"&&n.jsx("span",{role:"status","aria-live":"polite",style:{padding:"3px 8px",borderRadius:999,background:"var(--surface)",border:"1px solid var(--border)",fontSize:12,color:"var(--ink-strong)"},children:"저장완료"})]}),n.jsxs("fieldset",{disabled:h||g,"aria-disabled":h||g,className:h||g?"fieldset-locked":void 0,style:{border:0,padding:0,margin:0},children:[n.jsxs("div",{className:"row cols-2",children:[n.jsx("div",{className:"field-calendar",children:n.jsx(ce,{label:"달력",options:Be,value:r.calendar,onChange:Ie,ariaLabel:"달력 종류 선택"})}),$e&&n.jsx("div",{className:"field-leap",children:n.jsx(N,{label:"윤달 여부",id:"p-leapMonth",options:[{value:"common",label:"평달"},{value:"leap",label:"윤달"}],value:r.leapMonth,onChange:e=>S("leapMonth",e.target.value)})})]}),n.jsxs("div",{className:"row cols-2",children:[n.jsx("div",{className:"field-gender",children:n.jsx(ce,{label:"성별",options:De,value:r.gender,onChange:Pe,ariaLabel:"성별 선택"})}),n.jsx("div",{className:"field-mbti only-desktop",children:n.jsx(N,{label:"MBTI (선택사항)",id:"p-mbti-desktop",options:ie.map(e=>({value:e.value,label:e.label})),value:r.mbti||"",onChange:e=>S("mbti",e.target.value)})})]}),n.jsxs("div",{className:"row cols-4 sm-cols-2","aria-label":"생년월일 및 시간 선택",children:[n.jsx("div",{className:"field-year",children:n.jsx(N,{label:"년도",id:"p-year",options:Ce,value:r.year,onChange:e=>S("year",e.target.value)})}),n.jsx("div",{className:"field-month",children:n.jsx(N,{label:"월",id:"p-month",options:Ee,value:r.month,onChange:e=>S("month",e.target.value)})}),n.jsx("div",{className:"field-day",children:n.jsx(N,{label:"일",id:"p-day",options:Te,value:r.day,onChange:e=>S("day",e.target.value)})}),n.jsx("div",{className:"field-hour",children:n.jsx(N,{label:"시간",id:"p-hour",options:Re,value:r.hour,onChange:e=>S("hour",e.target.value)})})]}),n.jsx("div",{className:"row only-mobile",children:n.jsx("div",{className:"field-mbti",children:n.jsx(N,{label:"MBTI (선택사항)",id:"p-mbti-mobile",options:Ne,value:r.mbti||"",onChange:e=>S("mbti",e.target.value)})})})]}),n.jsxs("div",{className:"actions",children:[n.jsx(ue,{variant:"text",type:"button",onClick:be,children:"초기화"}),n.jsx(ue,{type:"submit",disabled:h||g||!k,"aria-disabled":h||g||!k,title:h?"이전 결과가 저장되었습니다. 초기화를 누르면 해제됩니다.":k?void 0:"필수 정보를 먼저 입력하세요.",children:g?"분석 중…":h?"저장완료":"궁합 보기"})]})]}),($||A)&&n.jsxs("div",{className:"row cols-2 sm-cols-1",style:{marginTop:16},children:[n.jsxs("section",{style:{display:"grid",gap:8},children:[n.jsx("h3",{id:"compat-my-header",className:"h4",style:{margin:0},children:"내 사주 기둥"}),$?n.jsx(de,{pillars:$,idPrefix:"my"}):n.jsx("p",{className:"muted",style:{margin:0},children:"내 정보가 없어 표시할 수 없습니다."})]}),n.jsxs("section",{style:{display:"grid",gap:8},children:[n.jsx("h3",{className:"h4",style:{margin:0},children:"상대방 사주 기둥"}),A?n.jsx(de,{pillars:A,idPrefix:"partner"}):n.jsx("p",{className:"muted",style:{margin:0},children:"상대방 정보를 먼저 입력해 주세요."})]})]}),$&&A&&n.jsxs("section",{style:{display:"grid",gap:8,marginTop:16},children:[n.jsx("h3",{id:"compat-analysis-header",className:"h4",style:{margin:0},children:"궁합 풀이"}),!g&&n.jsx(We,{content:K,isLoading:!1,error:we})]})]})]}),n.jsx("div",{ref:j,"aria-hidden":!0,style:{height:1}}),n.jsx(Qe,{isOpen:Me,onClose:()=>X(!1),pageTitle:"궁합",shareText:"궁합 결과가 도움이 되셨다면 지인과 공유해 보세요."}),n.jsx("style",{children:`
        :root{ --row-gap: 14px; --col-gap: 12px; }

        .form-compat .row{
          display: grid;
          gap: var(--row-gap) var(--col-gap);
          margin: 0;
        }
        .form-compat .row + .row{
          margin-top: var(--row-gap);
        }
        .form-compat .row > [class^="field-"]{
          margin: 0;
        }

        .form-compat .actions{
          margin-top: var(--row-gap);
          display: flex;
          gap: 10px;
        }

        /* 홈 폼과 동일: 락 시 포인터 차단 */
        .fieldset-locked { opacity: 0.98; }
        .fieldset-locked * {
          pointer-events: none !important;
          cursor: not-allowed !important;
        }
      `})]})}export{ot as default};
